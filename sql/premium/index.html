<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SQL in Browser ‚Äî SQLite Demo (Improved)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- tiny inline favicon to avoid 404 -->
    <link
      rel="icon"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%23d97706'/%3E%3Ctext x='64' y='82' font-size='64' text-anchor='middle'%3E%F0%9F%93%8A%3C/text%3E%3C/svg%3E"
    />

    <style>
      :root {
        --bg: #fff7e6;
        --card: #ffffff;
        --ink: #1f2937;
        --brand: #d97706;
        --brand2: #b45309;
        --border: #f3d7a6;
        --muted: #6b7280;
        --danger: #b91c1c;
        --ok: #166534;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          Inter,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        background: linear-gradient(180deg, var(--bg), #fff1d6);
        color: var(--ink);
      }
      a {
        color: inherit;
      }

      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px 16px 26px;
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 30;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 12px;
        margin: 0 -16px 14px;
        background: rgba(255, 255, 255, 0.82);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(31, 41, 55, 0.1);
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
        flex: 1;
      }
      .brand .logo {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: radial-gradient(circle at 30% 30%, #f59e0b, #b45309);
        box-shadow: 0 12px 26px rgba(217, 119, 6, 0.18);
      }
      .brand h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 900;
        letter-spacing: 0.2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .brand p {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .pill {
        border: 1px solid rgba(31, 41, 55, 0.1);
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 10px;
        border-radius: 999px;
        font-weight: 800;
        font-size: 12px;
        color: var(--ink);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #94a3b8;
        box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.12);
      }
      .dot.ok {
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.12);
      }

      .grid {
        display: grid;
        gap: 14px;
      }
      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 1.1fr 0.9fr;
        }
      }

      .card {
        background: rgba(255, 255, 255, 0.88);
        border: 1px solid rgba(31, 41, 55, 0.1);
        border-radius: 18px;
        box-shadow: 0 14px 38px rgba(8, 36, 64, 0.06);
        padding: 14px;
        overflow: hidden;
      }
      .panel-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }
      .panel-title h2 {
        font-size: 14px;
        margin: 0;
        font-weight: 1000;
      }
      .muted {
        color: var(--muted);
      }
      .small {
        font-size: 12px;
      }
      code.inline {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.15);
        padding: 2px 6px;
        border-radius: 8px;
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Roboto Mono",
          monospace;
        font-size: 12px;
      }

      textarea#sqlInput {
        width: 100%;
        min-height: 190px;
        resize: vertical;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(31, 41, 55, 0.12);
        background: rgba(255, 255, 255, 0.95);
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Roboto Mono",
          monospace;
        font-size: 14px;
        outline: none;
        box-shadow: inset 0 10px 22px rgba(2, 6, 23, 0.03);
      }
      textarea#sqlInput:focus {
        border-color: rgba(217, 119, 6, 0.35);
        box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.18);
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      button {
        border: none;
        cursor: pointer;
        font-weight: 900;
      }
      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }
      .btn {
        padding: 10px 12px;
        border-radius: 14px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: #fff;
        box-shadow: 0 12px 26px rgba(217, 119, 6, 0.16);
      }
      .btn-outline {
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(31, 41, 55, 0.12);
        color: var(--ink);
      }
      .btn-ghost {
        padding: 10px 12px;
        border-radius: 14px;
        background: transparent;
        border: 1px solid rgba(31, 41, 55, 0.1);
        color: var(--ink);
      }

      .samples {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }
      .chip {
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(31, 41, 55, 0.12);
        font-weight: 950;
        font-size: 12px;
      }
      .chip:hover {
        background: rgba(245, 158, 11, 0.12);
        border-color: rgba(245, 158, 11, 0.2);
      }
      .chip.h {
        background: rgba(217, 119, 6, 0.1);
        border-color: rgba(217, 119, 6, 0.18);
      }

      .result {
        margin-top: 10px;
        border-radius: 16px;
        border: 1px solid rgba(31, 41, 55, 0.1);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.95);
      }
      .result .meta {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.08);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
      }
      .result .meta .left {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .ok {
        color: var(--ok);
        font-weight: 1000;
      }
      .danger {
        color: var(--danger);
        font-weight: 1000;
      }

      .tablewrap {
        width: 100%;
        overflow: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 10px 10px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.08);
        vertical-align: top;
        text-align: left;
      }
      th {
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.98);
        font-weight: 1000;
      }

      .errorbox {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(185, 28, 28, 0.18);
        background: rgba(185, 28, 28, 0.06);
        color: #7f1d1d;
        white-space: pre-wrap;
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Roboto Mono",
          monospace;
        font-size: 13px;
        display: none;
      }

      .history {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 10px 0;
        flex-wrap: wrap;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .tab {
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.12);
        background: rgba(255, 255, 255, 0.92);
        font-size: 12px;
        font-weight: 950;
      }
      .tab.on {
        border-color: rgba(217, 119, 6, 0.35);
        background: rgba(217, 119, 6, 0.12);
      }
      .histlist {
        max-height: 520px;
        overflow: auto;
        border-radius: 16px;
        border: 1px solid rgba(31, 41, 55, 0.1);
        background: rgba(255, 255, 255, 0.95);
      }
      .histitem {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(31, 41, 55, 0.08);
      }
      .histitem:last-child {
        border-bottom: none;
      }
      .histitem .hmeta {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 800;
      }
      .histitem pre {
        margin: 8px 0 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Roboto Mono",
          monospace;
        font-size: 13px;
        color: var(--ink);
      }
      .histitem .actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .histitem .actions button {
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.12);
        background: rgba(255, 255, 255, 0.92);
        font-size: 12px;
        font-weight: 950;
      }
      .histitem .actions button:hover {
        background: rgba(245, 158, 11, 0.12);
        border-color: rgba(245, 158, 11, 0.18);
      }

      .helpbox {
        margin-top: 12px;
        border-radius: 16px;
        border: 1px dashed rgba(31, 41, 55, 0.15);
        background: rgba(255, 255, 255, 0.65);
        padding: 12px;
      }
      .helpresults {
        margin-top: 10px;
        display: grid;
        gap: 10px;
      }
      .helpitem {
        border: 1px solid rgba(31, 41, 55, 0.1);
        background: rgba(255, 255, 255, 0.92);
        border-radius: 14px;
        padding: 10px 12px;
      }
      .helpitem b {
        font-weight: 1000;
      }

      input[type="text"],
      input[type="file"] {
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(31, 41, 55, 0.12);
        background: rgba(255, 255, 255, 0.95);
        outline: none;
        font-weight: 800;
      }
      input[type="text"]:focus,
      input[type="file"]:focus {
        border-color: rgba(217, 119, 6, 0.35);
        box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.16);
      }

      .footerNote {
        margin-top: 14px;
        color: var(--muted);
        font-size: 12px;
        font-weight: 800;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div style="min-width: 0">
            <h1>SQL in Browser ‚Äî SQLite Demo</h1>
            <p>
              Runs entirely on your device using
              <code class="inline">sql.js</code> (no server).
            </p>
          </div>
        </div>

        <div class="status">
          <div class="pill" title="SQLite readiness">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">Loading SQLite‚Ä¶</span>
          </div>
          <div class="pill" title="CSV tools work after a SELECT">
            üìÑ CSV: <span id="csvHint">Run a SELECT</span>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="card">
          <div class="panel-title">
            <h2>SQL Editor</h2>
            <div class="row">
              <button id="runBtn" class="btn" disabled>Run SQL</button>
              <button id="resetBtn" class="btn-outline" disabled>
                Reset DB
              </button>
              <button id="copySqlBtn" class="btn-ghost" disabled>
                Copy SQL
              </button>
            </div>
          </div>

          <div class="muted small">
            Tip: Use <code class="inline">Show tables</code> then explore
            schemas with <code class="inline">PRAGMA table_info(table)</code>.
            <span class="muted small"
              >Note: SQLite uses <code class="inline">EXCEPT</code> instead of
              Oracle <code class="inline">MINUS</code>; SQLite has no native
              RIGHT/FULL JOIN (we include emulations).</span
            >
          </div>

          <div class="samples" aria-label="Sample queries">
            <!-- core -->
            <button
              class="chip"
              data-sql="SELECT name, type FROM sqlite_master WHERE type IN ('table','view') ORDER BY type, name;"
            >
              Show tables
            </button>
            <button class="chip" data-sql="PRAGMA table_info(birthdays);">
              Describe birthdays
            </button>
            <button class="chip" data-sql="PRAGMA foreign_keys;">
              FK status
            </button>
            <button class="chip" data-sql="SELECT * FROM employees;">
              Employees (FK)
            </button>
            <button class="chip" data-sql="SELECT * FROM birthdays;">
              Birthdays
            </button>
            <button
              class="chip"
              data-sql="INSERT INTO birthdays (name, birthday) VALUES ('New Friend', '2000-01-01'); SELECT * FROM birthdays;"
            >
              Insert sample row
            </button>
            <button
              class="chip"
              data-sql="UPDATE birthdays SET name='Updated Friend' WHERE name='New Friend'; SELECT * FROM birthdays;"
            >
              Update sample row
            </button>
            <button
              class="chip"
              data-sql="DELETE FROM birthdays WHERE name='Updated Friend'; SELECT * FROM birthdays;"
            >
              Delete sample row
            </button>

            <!-- section: keys -->
            <button
              class="chip h"
              data-sql="-- KEYS: Composite Primary Key\nSELECT * FROM Student ORDER BY Course, RollNo;"
            >
              üîë Student (Composite PK)
            </button>
            <button class="chip" data-sql="PRAGMA table_info(Student);">
              Describe Student
            </button>
            <button
              class="chip"
              data-sql="-- Try PK violation: (RollNo,Course) must be unique\nINSERT INTO Student VALUES (1,'Test',20,'MBBS');"
            >
              Try PK violation
            </button>

            <button
              class="chip h"
              data-sql="-- Candidate keys: PK + UNIQUE + composite UNIQUE\nSELECT * FROM Ticket;"
            >
              üé´ Ticket (PK + UNIQUE)
            </button>
            <button class="chip" data-sql="PRAGMA table_info(Ticket);">
              Describe Ticket
            </button>
            <button
              class="chip"
              data-sql="-- Violate UNIQUE PNRNo\nINSERT INTO Ticket VALUES('T2','P1','New Ashish','2023-01-01','123','S2',2);"
            >
              Violate UNIQUE (PNR)
            </button>
            <button
              class="chip"
              data-sql="-- Violate composite UNIQUE(DateOfJourney,TrainNo,CoachNo,BerthNo)\nINSERT INTO Ticket VALUES('T3','P3','Someone','2023-01-01','123','S1',1);"
            >
              Violate UNIQUE (Composite)
            </button>

            <!-- section: foreign key -->
            <button
              class="chip h"
              data-sql="-- FOREIGN KEY demo\nSELECT * FROM Publications;"
            >
              üßæ Publications
            </button>
            <button class="chip" data-sql="SELECT * FROM Subscribers;">
              Subscribers
            </button>
            <button
              class="chip"
              data-sql="-- This should FAIL (FK): non-existent publication\nINSERT INTO Subscribers VALUES('NonExistent Patrika','Mahesh');"
            >
              Try FK fail
            </button>

            <!-- section: set operators -->
            <button
              class="chip h"
              data-sql="-- SETS: UNION\nSELECT name FROM Cricketers UNION SELECT name FROM Footballers ORDER BY name;"
            >
              üß© UNION
            </button>
            <button
              class="chip"
              data-sql="-- SETS: UNION ALL\nSELECT name FROM Cricketers UNION ALL SELECT name FROM Footballers ORDER BY name;"
            >
              UNION ALL
            </button>
            <button
              class="chip"
              data-sql="-- SETS: INTERSECT\nSELECT name FROM Cricketers INTERSECT SELECT name FROM Footballers ORDER BY name;"
            >
              INTERSECT
            </button>
            <button
              class="chip"
              data-sql="-- SETS: EXCEPT (Oracle MINUS)\nSELECT name FROM Cricketers EXCEPT SELECT name FROM Footballers ORDER BY name;"
            >
              EXCEPT (MINUS)
            </button>

            <button
              class="chip"
              data-sql="-- Players who play only one game:\n-- (Cricketers ‚à™ Footballers) ‚àí (Cricketers ‚à© Footballers)\nSELECT name FROM (\n  SELECT name FROM Cricketers\n  UNION\n  SELECT name FROM Footballers\n)\nEXCEPT\nSELECT name FROM (\n  SELECT name FROM Cricketers\n  INTERSECT\n  SELECT name FROM Footballers\n)\nORDER BY name;"
            >
              Only one game
            </button>

            <!-- section: joins -->
            <button
              class="chip h"
              data-sql="-- INNER JOIN\nSELECT * FROM Cricketers C INNER JOIN Footballers F ON C.name=F.name;"
            >
              üîó INNER JOIN
            </button>
            <button
              class="chip"
              data-sql="-- LEFT JOIN\nSELECT * FROM Cricketers C LEFT JOIN Footballers F ON C.name=F.name ORDER BY C.name;"
            >
              LEFT JOIN
            </button>
            <button
              class="chip"
              data-sql="-- RIGHT JOIN emulation in SQLite:\n-- swap tables in LEFT JOIN\nSELECT * FROM Footballers F LEFT JOIN Cricketers C ON C.name=F.name ORDER BY F.name;"
            >
              RIGHT JOIN (emulated)
            </button>
            <button
              class="chip"
              data-sql="-- FULL OUTER JOIN emulation in SQLite:\nSELECT C.name AS name, C.runs, F.goals\nFROM Cricketers C LEFT JOIN Footballers F ON C.name=F.name\nUNION\nSELECT F.name AS name, C.runs, F.goals\nFROM Footballers F LEFT JOIN Cricketers C ON C.name=F.name\nORDER BY name;"
            >
              FULL JOIN (emulated)
            </button>

            <!-- section: aggregates -->
            <button
              class="chip h"
              data-sql="-- Aggregates\nSELECT * FROM Cricket_Scores;"
            >
              üìä Cricket_Scores
            </button>
            <button
              class="chip"
              data-sql="SELECT MAX(score) AS max_score FROM Cricket_Scores;"
            >
              MAX
            </button>
            <button
              class="chip"
              data-sql="SELECT MIN(score) AS min_score FROM Cricket_Scores;"
            >
              MIN
            </button>
            <button
              class="chip"
              data-sql="SELECT SUM(score) AS total FROM Cricket_Scores;"
            >
              SUM
            </button>
            <button
              class="chip"
              data-sql="SELECT AVG(score) AS average FROM Cricket_Scores;"
            >
              AVG
            </button>
            <button
              class="chip"
              data-sql="SELECT COUNT(score) AS count_score FROM Cricket_Scores;"
            >
              COUNT
            </button>

            <button
              class="chip"
              data-sql="-- Need GROUP BY when mixing normal columns + aggregates\nSELECT batsman, MAX(score) AS max_score\nFROM Cricket_Scores\nGROUP BY batsman\nORDER BY max_score DESC;"
            >
              GROUP BY
            </button>

            <button
              class="chip"
              data-sql="-- Multiple aggregates per group\nSELECT batsman,\n       MAX(score) AS max_score,\n       MIN(score) AS min_score,\n       AVG(score) AS avg_score,\n       SUM(score) AS sum_score,\n       COUNT(score) AS count_score\nFROM Cricket_Scores\nGROUP BY batsman\nORDER BY batsman;"
            >
              Multi-aggregates
            </button>

            <button
              class="chip"
              data-sql="-- HAVING filters groups (aggregate conditions)\nSELECT batsman, MAX(score) AS max_score\nFROM Cricket_Scores\nGROUP BY batsman\nHAVING MAX(score) >= 110\nORDER BY max_score DESC;"
            >
              HAVING
            </button>

            <button
              class="chip"
              data-sql="-- Highest scores by MatchType\nSELECT MatchType, MAX(score) AS best\nFROM Cricket_Scores\nGROUP BY MatchType\nORDER BY best DESC;"
            >
              Max by MatchType
            </button>

            <!-- section: trains self-join -->
            <button
              class="chip h"
              data-sql="-- Trains + Stops\nSELECT * FROM trains;"
            >
              üöÜ Trains
            </button>
            <button
              class="chip"
              data-sql="SELECT * FROM stops ORDER BY trainno, stopno;"
            >
              Stops
            </button>
            <button
              class="chip"
              data-sql="-- Find trains that go from Itarsi to Jalgaon (source stop before dest stop)\nSELECT Train.TrainNo, Train.TrainName, Source.station AS FromStation, Dest.station AS ToStation\nFROM stops AS Source\nINNER JOIN stops AS Dest\n  ON Source.trainno = Dest.trainno\nINNER JOIN trains AS Train\n  ON Train.TrainNo = Source.trainno\nWHERE Source.station='Itarsi'\n  AND Dest.station='Jalgaon'\n  AND Source.stopno < Dest.stopno\nORDER BY Train.TrainNo;"
            >
              Find trains: Itarsi ‚Üí Jalgaon
            </button>
          </div>

          <!-- LOAD SQLITE FILE (.db/.sqlite) -->
          <div class="row" style="margin-top: 10px">
            <input
              id="sqliteFile"
              type="file"
              accept=".db,.sqlite,.sqlite3,application/x-sqlite3"
            />
            <button id="loadDbBtn" class="btn-outline" disabled>
              Load DB file
            </button>
            <button id="useSampleBtn" class="btn-ghost" disabled>
              Use Sample DB
            </button>
          </div>
          <div class="muted small" style="margin-top: 6px">
            Choose a <code class="inline">.db</code>/<code class="inline"
              >.sqlite</code
            >
            file. It loads only on this device (in-browser).
          </div>

          <textarea id="sqlInput" aria-label="SQL editor">
SELECT * FROM birthdays;</textarea
          >

          <div class="row" style="margin-top: 10px">
            <button id="downloadCsvBtn" class="btn-outline" disabled>
              Download CSV
            </button>
            <button id="copyCsvBtn" class="btn-ghost" disabled>Copy CSV</button>
          </div>

          <div class="result" aria-live="polite" style="margin-top: 12px">
            <div class="meta">
              <div class="left">
                <span id="metaMsg" class="muted small"
                  >Ready when SQLite loads.</span
                >
                <span id="metaRows" class="muted small"></span>
              </div>
              <div class="row">
                <button id="toggleHelpBtn" class="btn-ghost">Help</button>
              </div>
            </div>
            <div class="tablewrap" id="result"></div>
          </div>

          <div class="errorbox" id="error"></div>

          <div class="helpbox" id="helpBox" style="display: none">
            <div class="muted small">
              Quick help: <code class="inline">select</code>,
              <code class="inline">join</code>,
              <code class="inline">where</code>,
              <code class="inline">group by</code>,
              <code class="inline">having</code>,
              <code class="inline">order by</code>,
              <code class="inline">limit</code>,
              <code class="inline">pragma</code>,
              <code class="inline">union</code>,
              <code class="inline">intersect</code>,
              <code class="inline">except</code>.
            </div>

            <div style="margin-top: 10px">
              <input
                id="helpSearch"
                type="text"
                placeholder="Search SQL help‚Ä¶ (e.g., primary key, except, having)"
                autocomplete="off"
              />
            </div>

            <div class="helpresults" id="helpResults"></div>
          </div>

          <div class="footerNote">
            ‚úÖ Works offline once loaded. Query history is saved in localStorage
            on this device.
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <div class="panel-title">
            <h2>Query History</h2>
            <div class="row">
              <button id="exportHistoryBtn" class="btn-outline" disabled>
                Export
              </button>
              <button id="importHistoryBtn" class="btn-outline" disabled>
                Import
              </button>
              <button id="clearHistoryBtn" class="btn-ghost" disabled>
                Clear
              </button>
              <input
                id="importFile"
                type="file"
                accept="application/json,.json"
                style="display: none"
              />
            </div>
          </div>

          <div class="history">
            <div class="tabs" role="tablist" aria-label="History tabs">
              <button
                class="tab on"
                id="tabSuccess"
                type="button"
                role="tab"
                aria-selected="true"
              >
                Success
              </button>
              <button
                class="tab"
                id="tabFail"
                type="button"
                role="tab"
                aria-selected="false"
              >
                Failed
              </button>
            </div>
            <div class="muted small" id="histCount"></div>
          </div>

          <div class="histlist" id="historyList"></div>
        </div>
      </div>
    </div>

    <!-- IMPORTANT FIX: removed integrity attribute so the browser won't block -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script>
      (function () {
        // ===== Storage keys
        var LS_SUCCESS = "pp_sql_history_success_v1";
        var LS_FAIL = "pp_sql_history_fail_v1";

        // ===== State
        var db = null;
        var SQLlib = null;
        var activeTab = "success";
        var lastSelectResult = null; // {columns, values}

        // ===== DOM
        var statusDot = document.getElementById("statusDot");
        var statusText = document.getElementById("statusText");
        var csvHint = document.getElementById("csvHint");

        var sqlInput = document.getElementById("sqlInput");
        var runBtn = document.getElementById("runBtn");
        var resetBtn = document.getElementById("resetBtn");
        var copySqlBtn = document.getElementById("copySqlBtn");
        var downloadCsvBtn = document.getElementById("downloadCsvBtn");
        var copyCsvBtn = document.getElementById("copyCsvBtn");

        var metaMsg = document.getElementById("metaMsg");
        var metaRows = document.getElementById("metaRows");
        var resultDiv = document.getElementById("result");
        var errorDiv = document.getElementById("error");

        var historyList = document.getElementById("historyList");
        var histCount = document.getElementById("histCount");
        var tabSuccess = document.getElementById("tabSuccess");
        var tabFail = document.getElementById("tabFail");

        var exportHistoryBtn = document.getElementById("exportHistoryBtn");
        var importHistoryBtn = document.getElementById("importHistoryBtn");
        var clearHistoryBtn = document.getElementById("clearHistoryBtn");
        var importFile = document.getElementById("importFile");

        var sqliteFile = document.getElementById("sqliteFile");
        var loadDbBtn = document.getElementById("loadDbBtn");
        var useSampleBtn = document.getElementById("useSampleBtn");

        var toggleHelpBtn = document.getElementById("toggleHelpBtn");
        var helpSearch = document.getElementById("helpSearch");
        var helpBox = document.getElementById("helpBox");
        var helpResults = document.getElementById("helpResults");

        // ===== Utils
        function nowISO() {
          return new Date().toISOString().replace("T", " ").slice(0, 19);
        }
        function readLS(key) {
          try {
            return JSON.parse(localStorage.getItem(key) || "[]");
          } catch {
            return [];
          }
        }
        function writeLS(key, arr) {
          localStorage.setItem(key, JSON.stringify(arr));
        }
        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function enableDbLoadUI(ready) {
          loadDbBtn.disabled = !ready;
          useSampleBtn.disabled = !ready;
        }

        function setStatus(ready) {
          if (ready) {
            statusDot.className = "dot ok";
            statusText.textContent = "DB Ready ‚úÖ";
            runBtn.disabled = false;
            resetBtn.disabled = false;
            exportHistoryBtn.disabled = false;
            importHistoryBtn.disabled = false;
            clearHistoryBtn.disabled = false;
            copySqlBtn.disabled = false;
            downloadCsvBtn.disabled = !lastSelectResult;
            copyCsvBtn.disabled = !lastSelectResult;
            enableDbLoadUI(true);
          } else {
            statusDot.className = "dot";
            statusText.textContent = "Loading SQLite‚Ä¶";
            runBtn.disabled = true;
            resetBtn.disabled = true;
            exportHistoryBtn.disabled = true;
            importHistoryBtn.disabled = true;
            clearHistoryBtn.disabled = true;
            copySqlBtn.disabled = true;
            downloadCsvBtn.disabled = true;
            copyCsvBtn.disabled = true;
            enableDbLoadUI(false);
          }
        }

        function clearOutput() {
          resultDiv.innerHTML = "";
          errorDiv.textContent = "";
          errorDiv.style.display = "none";
          metaRows.textContent = "";
        }

        function showInfo(msg) {
          metaMsg.innerHTML =
            '<span class="muted small">' + escapeHtml(msg) + "</span>";
        }

        function showOk(msg) {
          metaMsg.innerHTML =
            '<span class="ok">‚úÖ ' + escapeHtml(msg) + "</span>";
        }

        function showErr(msg) {
          errorDiv.style.display = "block";
          errorDiv.textContent = msg;
          metaMsg.innerHTML = '<span class="danger">‚ùå Error</span>';
        }

        // ===== Load external SQLite file into sql.js
        function loadSQLiteArrayBuffer(arrayBuffer) {
          if (!SQLlib) return;
          try {
            if (db) {
              try {
                db.close();
              } catch (e) {}
            }
            db = new SQLlib.Database(new Uint8Array(arrayBuffer));
            try {
              db.run("PRAGMA foreign_keys = ON;");
            } catch (e) {}

            lastSelectResult = null;
            downloadCsvBtn.disabled = true;
            copyCsvBtn.disabled = true;
            csvHint.textContent = "Run a SELECT";

            clearOutput();
            showOk("Loaded SQLite DB file successfully ‚úÖ");
            renderHistory();
          } catch (e) {
            showErr(
              "Failed to open this file as a SQLite database.\n\n" +
                (e && e.message ? e.message : String(e)),
            );
          }
        }

        function loadSelectedSQLiteFile(file) {
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function () {
            var buf = reader.result;
            if (!buf) {
              showErr("Could not read file.");
              return;
            }
            loadSQLiteArrayBuffer(buf);
          };
          reader.onerror = function () {
            showErr("Failed to read file. Please try again.");
          };
          reader.readAsArrayBuffer(file);
        }

        // ===== DB init
        function createFreshDB() {
          db = new SQLlib.Database();
          db.run("PRAGMA foreign_keys = ON;");

          // Drop existing (order matters due to FKs)
          db.run("DROP TABLE IF EXISTS stops;");
          db.run("DROP TABLE IF EXISTS trains;");

          db.run("DROP TABLE IF EXISTS Subscribers;");
          db.run("DROP TABLE IF EXISTS Publications;");

          db.run("DROP TABLE IF EXISTS Ticket;");
          db.run("DROP TABLE IF EXISTS Student;");

          db.run("DROP TABLE IF EXISTS Footballers;");
          db.run("DROP TABLE IF EXISTS Cricketers;");

          db.run("DROP TABLE IF EXISTS Cricket_Scores;");

          db.run("DROP TABLE IF EXISTS employees;");
          db.run("DROP TABLE IF EXISTS birthdays;");

          // ===== Original sample
          db.run(
            "CREATE TABLE birthdays (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, birthday TEXT NOT NULL);",
          );
          db.run(
            "INSERT INTO birthdays (name, birthday) VALUES ('Alice', '1998-07-14');",
          );
          db.run(
            "INSERT INTO birthdays (name, birthday) VALUES ('Bob', '1995-02-28');",
          );
          db.run(
            "INSERT INTO birthdays (name, birthday) VALUES ('Charlie', '2001-12-05');",
          );

          db.run(
            "CREATE TABLE employees (emp_id INTEGER PRIMARY KEY, emp_name TEXT NOT NULL, birthday_id INTEGER, FOREIGN KEY(birthday_id) REFERENCES birthdays(id));",
          );
          db.run(
            "INSERT INTO employees (emp_id, emp_name, birthday_id) VALUES (1, 'Riya', 1);",
          );
          db.run(
            "INSERT INTO employees (emp_id, emp_name, birthday_id) VALUES (2, 'Sahil', 2);",
          );
          db.run(
            "INSERT INTO employees (emp_id, emp_name, birthday_id) VALUES (3, 'Nisha', 3);",
          );

          // ===== KEYS examples (Composite PK + UNIQUE)
          db.run(`
            CREATE TABLE Student (
              RollNo INTEGER,
              Name TEXT,
              Age INTEGER,
              Course TEXT,
              PRIMARY KEY (RollNo, Course)
            );
          `);
          db.run(`
            INSERT INTO Student VALUES
              (1,'Himanshu',35,'MBBS'),
              (1,'Himanshu',34,'MD'),
              (2,'Ashish',22,'MBBS');
          `);

          db.run(`
            CREATE TABLE Ticket (
              TicketNo TEXT PRIMARY KEY,
              PNRNo TEXT UNIQUE,
              PassengerName TEXT,
              DateOfJourney TEXT,
              TrainNo TEXT,
              CoachNo TEXT,
              BerthNo INTEGER,
              UNIQUE(DateOfJourney,TrainNo,CoachNo,BerthNo)
            );
          `);
          db.run(
            `INSERT INTO Ticket VALUES ('T1','P1','Ashish','2023-01-01','123','S1',1);`,
          );

          // ===== FOREIGN KEY example (Publications/Subscribers)
          db.run(`
            CREATE TABLE Publications(
              PublicationName TEXT PRIMARY KEY
            );
          `);
          db.run(`
            INSERT INTO Publications VALUES
              ('Yuva Bharati'),
              ('Vivekananda Kendra Patrika');
          `);

          db.run(`
            CREATE TABLE Subscribers(
              PublicationName TEXT REFERENCES Publications(PublicationName),
              CustomerId TEXT,
              PRIMARY KEY(PublicationName,CustomerId)
            );
          `);
          db.run(`
            INSERT INTO Subscribers VALUES
              ('Yuva Bharati','Ashish'),
              ('Vivekananda Kendra Patrika','Manish');
          `);

          // ===== SET operators + JOIN examples
          db.run(`
            CREATE TABLE Cricketers(
              name TEXT PRIMARY KEY,
              runs INTEGER
            );
          `);
          db.run(`INSERT INTO Cricketers VALUES ('A',100),('C',150);`);

          db.run(`
            CREATE TABLE Footballers(
              name TEXT PRIMARY KEY,
              goals INTEGER
            );
          `);
          db.run(`INSERT INTO Footballers VALUES ('B',15),('C',25);`);

          // ===== Aggregates example
          db.run(`
            CREATE TABLE Cricket_Scores(
              batsman TEXT,
              InningsNo INTEGER,
              MatchType TEXT,
              score INTEGER
            );
          `);
          db.run(`
            INSERT INTO Cricket_Scores VALUES
              ('Champak',1,'Test',111),
              ('Champak',1,'OneDay',112),
              ('Gaurav',1,'OneDay',0),
              ('Gaurav',2,'OneDay',10),
              ('Champak',2,'OneDay',113),
              ('Pappu',1,'OneDay',3),
              ('Pappu',2,'OneDay',2);
          `);

          // ===== Trains between stations (self join on stops)
          db.run(`
            CREATE TABLE trains(
              TrainNo TEXT PRIMARY KEY,
              TrainName TEXT,
              Source TEXT,
              Dest TEXT
            );
          `);
          db.run(`
            CREATE TABLE stops(
              stopno INTEGER,
              trainno TEXT REFERENCES trains(TrainNo),
              station TEXT,
              PRIMARY KEY(stopno,trainno)
            );
          `);

          db.run(`
            INSERT INTO trains VALUES
              ('1','Mahanagari','Varanasi','Mumbai'),
              ('2','Mahanagari','Mumbai','Varanasi'),
              ('3','Ratnagiri','Varanasi','Mumbai');
          `);

          // sample route for train 1
          db.run(`
            INSERT INTO stops VALUES
              (1,'1','Varanasi'),
              (2,'1','Jabalpur'),
              (3,'1','Itarsi'),
              (4,'1','Jalgaon'),
              (5,'1','Mumbai');
          `);

          // a few stops for train 3 (so results can differ)
          db.run(`
            INSERT INTO stops VALUES
              (1,'3','Varanasi'),
              (2,'3','Itarsi'),
              (3,'3','Jalgaon'),
              (4,'3','Mumbai');
          `);
        }

        // ===== SQL execution
        function isSelectLike(sql) {
          // Keep your original logic; this tool is educational and simple.
          // (Note: some mixed statements like INSERT; SELECT; will be treated as non-select.)
          var s = (sql || "").trim().toLowerCase();
          return (
            s.startsWith("select") ||
            s.startsWith("pragma") ||
            s.startsWith("with") ||
            s.startsWith("explain")
          );
        }

        function renderTable(columns, values) {
          var html = "<table><thead><tr>";
          for (var i = 0; i < columns.length; i++)
            html += "<th>" + escapeHtml(columns[i]) + "</th>";
          html += "</tr></thead><tbody>";

          if (!values || values.length === 0) {
            html +=
              '<tr><td colspan="' +
              columns.length +
              '" class="muted small">No rows.</td></tr>';
          } else {
            for (var r = 0; r < values.length; r++) {
              html += "<tr>";
              for (var c = 0; c < columns.length; c++) {
                var v = values[r][c];
                html += "<td>" + escapeHtml(v === null ? "NULL" : v) + "</td>";
              }
              html += "</tr>";
            }
          }
          html += "</tbody></table>";
          resultDiv.innerHTML = html;
        }

        function runSQL() {
          clearOutput();
          if (!db) return;

          var sql = sqlInput.value || "";
          var start = performance.now();

          try {
            if (isSelectLike(sql)) {
              var res = db.exec(sql);
              if (!res || res.length === 0) {
                lastSelectResult = {
                  columns: ["(message)"],
                  values: [["Query returned no result set."]],
                };
                renderTable(lastSelectResult.columns, lastSelectResult.values);
                showOk("Query executed.");
                metaRows.textContent = "";
              } else {
                // Render first result set (simple UX). (If you want: we can render multiple.)
                var columns = res[0].columns || [];
                var values = res[0].values || [];
                lastSelectResult = { columns: columns, values: values };
                renderTable(columns, values);
                showOk("SELECT executed.");
                metaRows.textContent = values.length + " row(s)";
              }
              downloadCsvBtn.disabled = !lastSelectResult;
              copyCsvBtn.disabled = !lastSelectResult;
              csvHint.textContent = lastSelectResult ? "Ready" : "Run a SELECT";
            } else {
              db.run(sql);
              lastSelectResult = null;
              downloadCsvBtn.disabled = true;
              copyCsvBtn.disabled = true;
              csvHint.textContent = "Run a SELECT";
              showOk("Statement executed.");
              metaRows.textContent = "";
            }

            var ms = Math.round(performance.now() - start);
            showInfo("Executed in " + ms + " ms ‚Äî " + nowISO());
            saveHistory("success", sql, ms);
            renderHistory();
          } catch (e) {
            showErr(e && e.message ? e.message : String(e));
            saveHistory("fail", sql, 0, e && e.message ? e.message : String(e));
            renderHistory();
          }
        }

        // ===== History
        function saveHistory(kind, sql, ms, err) {
          var key = kind === "success" ? LS_SUCCESS : LS_FAIL;
          var arr = readLS(key);
          arr.unshift({ ts: nowISO(), sql: sql, ms: ms || 0, err: err || "" });
          if (arr.length > 80) arr = arr.slice(0, 80);
          writeLS(key, arr);
        }

        function setTab(tab) {
          activeTab = tab;
          tabSuccess.classList.toggle("on", tab === "success");
          tabFail.classList.toggle("on", tab === "fail");
          tabSuccess.setAttribute("aria-selected", String(tab === "success"));
          tabFail.setAttribute("aria-selected", String(tab === "fail"));
          renderHistory();
        }

        function renderHistory() {
          var key = activeTab === "success" ? LS_SUCCESS : LS_FAIL;
          var arr = readLS(key);
          histCount.textContent = arr.length + " item(s)";
          historyList.innerHTML = "";

          if (!arr.length) {
            historyList.innerHTML =
              '<div class="histitem"><div class="muted small">No history yet.</div></div>';
            return;
          }

          arr.forEach(function (it, idx) {
            var wrap = document.createElement("div");
            wrap.className = "histitem";
            wrap.innerHTML =
              '<div class="hmeta"><span>' +
              escapeHtml(it.ts) +
              "</span>" +
              "<span>" +
              (activeTab === "success" ? escapeHtml(it.ms + " ms") : "Failed") +
              "</span></div>" +
              "<pre>" +
              escapeHtml(it.sql) +
              "</pre>" +
              (it.err
                ? '<div class="muted small" style="margin-top:8px"><span class="danger">Error:</span> ' +
                  escapeHtml(it.err) +
                  "</div>"
                : "") +
              '<div class="actions">' +
              '<button data-act="insert" data-idx="' +
              idx +
              '">Insert</button>' +
              '<button data-act="copy" data-idx="' +
              idx +
              '">Copy</button>' +
              "</div>";

            historyList.appendChild(wrap);
          });
        }

        function exportHistory() {
          var payload = { success: readLS(LS_SUCCESS), fail: readLS(LS_FAIL) };
          var blob = new Blob([JSON.stringify(payload, null, 2)], {
            type: "application/json",
          });
          var url = URL.createObjectURL(blob);
          var a = document.createElement("a");
          a.href = url;
          a.download = "sql_history.json";
          a.click();
          URL.revokeObjectURL(url);
        }

        function importHistoryFile(file) {
          var reader = new FileReader();
          reader.onload = function () {
            try {
              var payload = JSON.parse(reader.result || "{}");
              if (payload.success) writeLS(LS_SUCCESS, payload.success);
              if (payload.fail) writeLS(LS_FAIL, payload.fail);
              showOk("History imported ‚úÖ");
              renderHistory();
            } catch (e) {
              showErr(
                "Import failed: " + (e && e.message ? e.message : String(e)),
              );
            }
          };
          reader.readAsText(file);
        }

        function clearHistory() {
          writeLS(LS_SUCCESS, []);
          writeLS(LS_FAIL, []);
          showOk("History cleared.");
          renderHistory();
        }

        // ===== CSV
        function toCSV(columns, values) {
          function csvCell(v) {
            if (v === null || v === undefined) return "";
            var s = String(v);
            if (/[",\n]/.test(s)) s = '"' + s.replaceAll('"', '""') + '"';
            return s;
          }
          var lines = [];
          lines.push(columns.map(csvCell).join(","));
          (values || []).forEach(function (row) {
            lines.push(row.map(csvCell).join(","));
          });
          return lines.join("\n");
        }

        function downloadCSV() {
          if (!lastSelectResult) return;
          var csv = toCSV(lastSelectResult.columns, lastSelectResult.values);
          var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
          var url = URL.createObjectURL(blob);
          var a = document.createElement("a");
          a.href = url;
          a.download = "result.csv";
          a.click();
          URL.revokeObjectURL(url);
        }

        function copyCSV() {
          if (!lastSelectResult) return;
          var csv = toCSV(lastSelectResult.columns, lastSelectResult.values);
          navigator.clipboard
            .writeText(csv)
            .then(function () {
              showOk("CSV copied ‚úÖ");
            })
            .catch(function () {
              showErr("Clipboard blocked by browser.");
            });
        }

        // ===== Help
        var HELP = [
          {
            k: "select",
            d: "Retrieve rows: SELECT col FROM table WHERE ... ORDER BY ... LIMIT ...",
          },
          {
            k: "where",
            d: "Filter rows: WHERE condition (e.g., age > 18 AND city='Delhi')",
          },
          {
            k: "join",
            d: "Combine tables: INNER JOIN / LEFT JOIN using ON t1.id=t2.ref (SQLite: no native RIGHT/FULL join; emulate with LEFT JOIN + UNION).",
          },
          { k: "inner join", d: "Only matching rows from both tables." },
          {
            k: "left join",
            d: "All rows from left table + matching rows from right table.",
          },
          {
            k: "right join",
            d: "Not native in SQLite; emulate by swapping tables in a LEFT JOIN.",
          },
          {
            k: "full join",
            d: "Not native in SQLite; emulate with (A LEFT JOIN B) UNION (B LEFT JOIN A).",
          },
          {
            k: "group by",
            d: "Aggregate rows: GROUP BY col with COUNT/SUM/AVG/MAX/MIN",
          },
          {
            k: "having",
            d: "Filter groups (aggregate conditions): HAVING MAX(score) >= 100",
          },
          { k: "order by", d: "Sort rows: ORDER BY col ASC|DESC" },
          { k: "limit", d: "Limit output rows: LIMIT 10 OFFSET 20" },
          {
            k: "pragma",
            d: "SQLite settings & introspection: PRAGMA table_info(tbl); PRAGMA foreign_keys;",
          },

          {
            k: "primary key",
            d: "Primary key uniquely identifies a row. Composite PK can be (col1, col2).",
          },
          {
            k: "unique",
            d: "UNIQUE enforces that values (or combinations) cannot repeat (candidate key idea).",
          },
          {
            k: "foreign key",
            d: "FOREIGN KEY ensures child rows reference an existing parent row (referential integrity).",
          },

          {
            k: "union",
            d: "UNION combines rows from two SELECTs and removes duplicates.",
          },
          {
            k: "union all",
            d: "UNION ALL combines rows and keeps duplicates.",
          },
          {
            k: "intersect",
            d: "INTERSECT returns rows common to both SELECTs.",
          },
          {
            k: "except",
            d: "EXCEPT returns rows in first SELECT not present in second (Oracle MINUS).",
          },

          {
            k: "aggregate",
            d: "Aggregate functions operate on many rows: MAX, MIN, SUM, AVG, COUNT.",
          },
          {
            k: "max",
            d: "MAX(column) returns largest value in the group/result.",
          },
          {
            k: "min",
            d: "MIN(column) returns smallest value in the group/result.",
          },
          { k: "sum", d: "SUM(column) totals numeric values." },
          { k: "avg", d: "AVG(column) returns average of numeric values." },
          {
            k: "count",
            d: "COUNT(*) or COUNT(col) counts rows/non-null values.",
          },

          {
            k: "sqlite_master",
            d: "System catalog: SELECT name,type,sql FROM sqlite_master WHERE type='table';",
          },
        ];

        function renderHelp(q) {
          var query = (q || "").trim().toLowerCase();
          var items = HELP.filter(function (it) {
            return (
              !query ||
              it.k.includes(query) ||
              it.d.toLowerCase().includes(query)
            );
          }).slice(0, 12);

          helpResults.innerHTML =
            items
              .map(function (it) {
                return (
                  '<div class="helpitem"><b>' +
                  escapeHtml(it.k) +
                  "</b><div class='muted small' style='margin-top:6px'>" +
                  escapeHtml(it.d) +
                  "</div></div>"
                );
              })
              .join("") || '<div class="muted small">No matches.</div>';
        }

        // ===== Wire UI
        document.querySelectorAll("[data-sql]").forEach(function (b) {
          b.addEventListener("click", function () {
            sqlInput.value = b.getAttribute("data-sql") || "";
            sqlInput.focus();
          });
        });

        runBtn.onclick = runSQL;

        resetBtn.onclick = function () {
          clearOutput();
          if (!db) return;
          try {
            db.close();
          } catch (e) {}
          createFreshDB();
          lastSelectResult = null;
          downloadCsvBtn.disabled = true;
          copyCsvBtn.disabled = true;
          csvHint.textContent = "Run a SELECT";
          showOk("Database reset (tables + sample rows recreated).");
        };

        loadDbBtn.onclick = function () {
          clearOutput();
          if (!SQLlib) return;
          var file =
            sqliteFile && sqliteFile.files ? sqliteFile.files[0] : null;
          if (!file) {
            showErr("Please choose a .db/.sqlite file first.");
            return;
          }
          showInfo("Loading DB file: " + file.name + " ‚Ä¶");
          loadSelectedSQLiteFile(file);
        };

        useSampleBtn.onclick = function () {
          clearOutput();
          if (!SQLlib) return;
          try {
            if (db) {
              try {
                db.close();
              } catch (e) {}
            }
            createFreshDB();
            lastSelectResult = null;
            downloadCsvBtn.disabled = true;
            copyCsvBtn.disabled = true;
            csvHint.textContent = "Run a SELECT";
            showOk("Switched back to Sample DB ‚úÖ");
            runSQL();
          } catch (e) {
            showErr(
              "Failed to restore sample DB.\n\n" +
                (e && e.message ? e.message : String(e)),
            );
          }
        };

        copySqlBtn.onclick = function () {
          navigator.clipboard
            .writeText(sqlInput.value || "")
            .then(function () {
              showOk("SQL copied ‚úÖ");
            })
            .catch(function () {
              showErr("Clipboard blocked by browser.");
            });
        };

        downloadCsvBtn.onclick = downloadCSV;
        copyCsvBtn.onclick = copyCSV;

        tabSuccess.onclick = function () {
          setTab("success");
        };
        tabFail.onclick = function () {
          setTab("fail");
        };

        historyList.addEventListener("click", function (e) {
          var btn = e.target.closest("button[data-act]");
          if (!btn) return;
          var act = btn.getAttribute("data-act");
          var idx = parseInt(btn.getAttribute("data-idx") || "0", 10);
          var arr = readLS(activeTab === "success" ? LS_SUCCESS : LS_FAIL);
          var item = arr[idx];
          if (!item) return;

          if (act === "insert") {
            sqlInput.value = item.sql || "";
            sqlInput.focus();
          }
          if (act === "copy") {
            navigator.clipboard
              .writeText(item.sql || "")
              .then(function () {
                showOk("Copied ‚úÖ");
              })
              .catch(function () {
                showErr("Clipboard blocked by browser.");
              });
          }
        });

        exportHistoryBtn.onclick = exportHistory;
        importHistoryBtn.onclick = function () {
          importFile.click();
        };
        importFile.addEventListener("change", function () {
          var file = importFile.files && importFile.files[0];
          if (file) importHistoryFile(file);
          importFile.value = "";
        });
        clearHistoryBtn.onclick = clearHistory;

        toggleHelpBtn.onclick = function () {
          var show = helpBox.style.display === "none";
          helpBox.style.display = show ? "block" : "none";
          if (show) renderHelp(helpSearch.value);
        };
        helpSearch.addEventListener("input", function () {
          renderHelp(helpSearch.value);
        });

        // ===== Init sql.js
        setStatus(false);

        if (window.initSqlJs) {
          window
            .initSqlJs({
              locateFile: function (f) {
                return (
                  "https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/" + f
                );
              },
            })
            .then(function (SQL) {
              SQLlib = SQL;
              createFreshDB();
              setStatus(true);
              showOk("SQLite loaded. Sample DB created.");
              renderHistory();
              renderHelp("");
            })
            .catch(function (e) {
              showErr(
                "Failed to load sql.js\n\n" +
                  (e && e.message ? e.message : String(e)),
              );
              setStatus(false);
            });
        } else {
          showErr(
            "sql.js not available (initSqlJs missing). Check the script include.",
          );
          setStatus(false);
        }

        // Bonus: Ctrl/Cmd + Enter to run SQL
        sqlInput.addEventListener("keydown", function (ev) {
          var isMac = navigator.platform.toUpperCase().indexOf("MAC") >= 0;
          if ((isMac ? ev.metaKey : ev.ctrlKey) && ev.key === "Enter") {
            ev.preventDefault();
            if (!runBtn.disabled) runSQL();
          }
        });
      })();
    </script>
  </body>
</html>
