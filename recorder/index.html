<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Programmer‚Äôs Picnic ‚Äì Web Shorts Maker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family: system-ui, Segoe UI, Arial;
  background:#fffaf2;
}
header{
  padding:14px 20px;
  background:#ffedd5;
  font-size:20px;
  font-weight:700;
  color:#92400e;
}
main{
  display:flex;
  gap:20px;
  padding:20px;
}
.left{ width:40%; }
.right{
  width:60%;
  display:flex;
  flex-direction:column;
  align-items:center;
}

textarea{
  width:100%;
  height:160px;
  font-size:14px;
  padding:10px;
}

.controls button{
  padding:10px 16px;
  margin:6px 4px 6px 0;
  font-size:14px;
  cursor:pointer;
}

button.primary{
  background:#f59e0b;
  border:none;
  font-weight:600;
}
button.secondary{
  background:#e5e7eb;
  border:none;
}

canvas{
  background:#fff4dc;
  border-radius:14px;
  width:360px;
  height:640px;
}

#status{
  margin-top:8px;
  font-weight:600;
}

#spokenBox{
  margin-top:10px;
  padding:10px;
  background:#fff;
  border-radius:8px;
  min-height:80px;
  font-size:14px;
  border:1px solid #ddd;
}

#download{
  margin-top:10px;
  display:none;
}

small{ color:#555; }
</style>
</head>

<body>

<header>üé¨ Programmer‚Äôs Picnic ‚Äì Web Shorts Maker</header>

<main>

<div class="left">

  <p><b>Script</b> <small>(use ===SCREEN===)</small></p>
  <textarea id="script">
Python allows this mistake silently.

===SCREEN===

Mutable default arguments
are shared forever.

===SCREEN===

Now you know.
  </textarea>

  <div class="controls">
    <button class="secondary" onclick="loadMic()">üéô Load Mic</button><br>
    <button class="secondary" onclick="preview()">üëÅ Preview (with sound)</button><br>
    <button class="primary" onclick="startRecording()">‚è∫ Record Video</button>
    <button class="secondary" onclick="stopRecording()">‚èπ Stop</button>
  </div>

  <p id="status">Idle</p>

  <p><b>What you said:</b></p>
  <div id="spokenBox">‚Äî</div>

</div>

<div class="right">
  <canvas id="canvas" width="1080" height="1920"></canvas>
  <a id="download">‚¨á Download Video</a>
</div>

</main>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const status = document.getElementById("status");
const spokenBox = document.getElementById("spokenBox");

let screens = [];
let screenIndex = 0;
let intervalId;

let micStream = null;
let audioEl = null;

let recorder;
let chunks = [];

// Speech recognition
let recognition;
let finalTranscript = "";

// -----------------------------
function setupSpeechRecognition(){
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if(!SpeechRecognition){
    spokenBox.textContent = "Speech recognition not supported in this browser.";
    return;
  }

  recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    let interim = "";
    for(let i = event.resultIndex; i < event.results.length; i++){
      const txt = event.results[i][0].transcript;
      if(event.results[i].isFinal){
        finalTranscript += txt + " ";
      } else {
        interim += txt;
      }
    }
    spokenBox.textContent = finalTranscript + interim;
  };

  recognition.onerror = (e) => {
    console.error(e);
  };
}

// -----------------------------
function parseScreens(){
  screens = document.getElementById("script")
    .value.split("===SCREEN===")
    .map(s => s.trim())
    .filter(Boolean);
}

// -----------------------------
function drawScreen(text){
  ctx.fillStyle="#fff4dc";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="#000";
  ctx.textAlign="center";
  ctx.font="72px Arial";

  const lines = text.split("\n");
  let y = canvas.height/2 - lines.length*40;

  lines.forEach(line=>{
    ctx.fillText(line, canvas.width/2, y);
    y += 80;
  });

  ctx.font="28px Arial";
  ctx.globalAlpha=0.4;
  ctx.fillText(
    "Programmer‚Äôs Picnic ‚Ä¢ Champak Roy",
    canvas.width-380,
    canvas.height-40
  );
  ctx.globalAlpha=1;
}

// -----------------------------
async function loadMic(){
  micStream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioEl = new Audio();
  audioEl.srcObject = micStream;

  setupSpeechRecognition();

  status.textContent = "Mic ready";
}

// -----------------------------
function preview(){
  if(!micStream){
    alert("Load mic first");
    return;
  }

  parseScreens();
  screenIndex = 0;
  finalTranscript = "";
  spokenBox.textContent = "";

  recognition.start();
  audioEl.play();

  status.textContent = "Previewing‚Ä¶";
  drawScreen(screens[0]);

  intervalId = setInterval(()=>{
    screenIndex++;
    if(screenIndex < screens.length){
      drawScreen(screens[screenIndex]);
    }else{
      clearInterval(intervalId);
      recognition.stop();
      audioEl.pause();
      status.textContent = "Preview finished";
    }
  }, 3000);
}

// -----------------------------
async function startRecording(){
  if(!micStream){
    alert("Load mic first");
    return;
  }

  parseScreens();
  screenIndex = 0;
  chunks = [];
  finalTranscript = "";
  spokenBox.textContent = "";

  recognition.start();

  const stream = canvas.captureStream(30);
  micStream.getAudioTracks().forEach(t=>stream.addTrack(t));

  recorder = new MediaRecorder(stream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = saveVideo;
  recorder.start();

  status.textContent = "Recording‚Ä¶";
  drawScreen(screens[0]);

  intervalId = setInterval(()=>{
    screenIndex++;
    if(screenIndex < screens.length){
      drawScreen(screens[screenIndex]);
    }
  }, 3000);
}

// -----------------------------
function stopRecording(){
  clearInterval(intervalId);
  recognition.stop();
  recorder.stop();
  status.textContent = "Stopped";
}

// -----------------------------
function saveVideo(){
  const blob = new Blob(chunks, {type:"video/webm"});
  const url = URL.createObjectURL(blob);
  const a = document.getElementById("download");
  a.href = url;
  a.download = "short.webm";
  a.style.display = "block";
}
</script>

</body>
</html>