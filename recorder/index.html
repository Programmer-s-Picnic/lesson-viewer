<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Master â€” Tabla + Sitar (NO MIC)</title>
    <style>
      :root {
        --bg: #fff7e6;
        --card: #fff;
        --ink: #1f2937;
        --muted: #6b7280;
        --brand: #d97706;
        --brand2: #f59e0b;
        --border: #eadcc5;
        --shadow: 0 18px 40px rgba(31, 41, 55, 0.14);
        --ok: #166534;
        --danger: #b91c1c;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        background: var(--bg);
        color: var(--ink);
      }
      .wrap {
        max-width: 1250px;
        margin: 22px auto;
        padding: 18px;
      }
      .hero {
        background: linear-gradient(135deg, #fff1d6, #fff);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding: 16px;
      }
      h1 {
        margin: 0 0 6px;
        color: var(--brand);
      }
      .sub {
        margin: 0;
        color: var(--muted);
        line-height: 1.6;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding: 14px;
        margin-top: 14px;
      }
      label {
        display: block;
        font-weight: 900;
      }
      input[type="text"] {
        width: 100%;
        margin-top: 6px;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: #fffaf1;
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
        align-items: center;
      }
      .btn {
        border: 1px solid var(--border);
        background: #fff;
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 900;
      }
      .btn.primary {
        background: #fff1d6;
        border-color: rgba(217, 119, 6, 0.4);
      }
      .btn.ghost {
        background: #fffaf1;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
        margin-top: 14px;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      iframe {
        width: 100%;
        height: 720px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: #fff;
      }
      code {
        background: #fff;
        border: 1px solid var(--border);
        padding: 1px 6px;
        border-radius: 7px;
      }
      .small {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.7;
        margin-top: 8px;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px dashed rgba(217, 119, 6, 0.5);
        background: #fffaf1;
        padding: 7px 10px;
        border-radius: 999px;
        font-weight: 900;
        margin-top: 10px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--danger);
      }
      .dot.ok {
        background: var(--ok);
      }

      .help {
        margin-top: 12px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: #fffaf1;
        padding: 12px;
      }
      .help h2 {
        margin: 0 0 8px;
        font-size: 16px;
        color: var(--brand);
      }
      .help p {
        margin: 6px 0;
        color: var(--muted);
        line-height: 1.65;
        font-size: 13px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .chip {
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 999px;
        padding: 8px 10px;
        font-weight: 900;
        cursor: pointer;
      }
      .chip:hover {
        border-color: rgba(217, 119, 6, 0.45);
      }
      .twoCol {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 980px) {
        .twoCol {
          grid-template-columns: 1fr;
        }
      }
      .sectionTitle {
        margin: 10px 0 6px;
        font-weight: 1000;
        color: #92400e;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="hero">
        <h1>Master (NO MIC)</h1>
        <p class="sub">
          Controls Tabla + Sitar iframes. No recording, no microphone APIs.
        </p>
        <p class="small">
          Format: <code>T: ...</code> and <code>S: ...</code><br />
          Outer repeat: <code>(T: 1,2 x4 S: Sa Re x4) x50</code> â†’ sends
          <code>{repeat:50}</code> to both pages.
        </p>

        <div class="pill">
          <span class="dot" id="readyDot"></span>
          <span id="readyText">Waiting for tabla & sitar pagesâ€¦</span>
        </div>

        <div class="help" id="helpBox">
          <h2>Help</h2>
          <p>
            1) Click inside <b>Tabla</b> and <b>Sitar</b> iframe once to unlock
            audio (browser rule).<br />
            2) Use Master commands to play both together.
          </p>
          <p>
            <b>Tabla mapping:</b> <code>1=Na</code>, <code>2=Tin</code>,
            <code>3=Ge</code>, <code>4=Ke</code><br />
            <b>Sitar notes:</b> <code>Sa Re Ga Ma Pa Dha Ni</code><br />
            <b>Inner loops:</b> <code>xN</code> inside T or S (e.g.
            <code>1,2 x4</code> or <code>Sa Re x4</code>)
          </p>
          <p>
            <b>Outer loop:</b> Wrap combined pattern and repeat:
            <code>(T: 1,2 x4 S: Sa Re x4) x50</code>
          </p>
        </div>
      </div>

      <div class="card">
        <label>
          Master Command Box
          <input
            id="masterCmd"
            type="text"
            value="(T: 1,2 x4  S: Sa Re x4) x10"
          />
        </label>

        <div class="row">
          <button class="btn primary" id="playBoth">Play Both</button>
          <button class="btn" id="stopBoth">Stop Both</button>
          <button class="btn ghost" id="toggleHelp">Toggle Help</button>
          <button class="btn" id="preset1">Preset 1</button>
          <button class="btn" id="preset2">Preset 2</button>
        </div>

        <div class="twoCol">
          <div>
            <div class="sectionTitle">
              Music Samples (Master: Tabla + Sitar)
            </div>
            <div class="chips" id="masterSamples"></div>
          </div>
          <div>
            <div class="sectionTitle">Quick Tips</div>
            <div class="small">
              â€¢ If you hear only one instrument: click once inside the silent
              iframe.<br />
              â€¢ For long plays use outer repeat: <code>(...) x50</code> (fast +
              clean).<br />
              â€¢ Use a local server (Live Server /
              <code>python -m http.server</code>) not <code>file://</code>.
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <iframe id="tablaFrame" src="tabla/index.html" title="Tabla"></iframe>
        <iframe id="sitarFrame" src="sitar/index.html" title="Sitar"></iframe>
      </div>
    </div>

    <script>
      const tablaFrame = document.getElementById("tablaFrame");
      const sitarFrame = document.getElementById("sitarFrame");
      const masterCmd = document.getElementById("masterCmd");

      const readyDot = document.getElementById("readyDot");
      const readyText = document.getElementById("readyText");

      const helpBox = document.getElementById("helpBox");
      document.getElementById("toggleHelp").addEventListener("click", () => {
        helpBox.style.display =
          helpBox.style.display === "none" ? "block" : "none";
      });

      const TARGET_ORIGIN = window.location.origin;

      let tablaReady = false;
      let sitarReady = false;

      function updateReadyUI() {
        if (tablaReady && sitarReady) {
          readyDot.classList.add("ok");
          readyText.textContent = "Tabla + Sitar ready âœ…";
        } else {
          readyDot.classList.remove("ok");
          readyText.textContent =
            "Waiting: " +
            (tablaReady ? "" : "Tabla ") +
            (sitarReady ? "" : "Sitar ");
        }
      }

      function pingIframes() {
        tablaFrame.contentWindow?.postMessage(
          { type: "master:ping" },
          TARGET_ORIGIN
        );
        sitarFrame.contentWindow?.postMessage(
          { type: "master:ping" },
          TARGET_ORIGIN
        );
      }
      tablaFrame.addEventListener("load", pingIframes);
      sitarFrame.addEventListener("load", pingIframes);

      window.addEventListener("message", (ev) => {
        if (ev.origin !== TARGET_ORIGIN) return;
        const msg = ev.data;
        if (!msg || typeof msg !== "object") return;

        if (msg.type === "tabla:ready") tablaReady = true;
        if (msg.type === "sitar:ready") sitarReady = true;
        updateReadyUI();
      });

      // Outer repeat: ( ... ) xN
      function unwrapOuterRepeat(text) {
        const s = (text || "").trim();
        if (!s) return { innerText: "", repeat: 1 };

        const m = s.match(/^\(\s*([\s\S]*?)\s*\)\s*x\s*(\d+)\s*$/i);
        if (m) {
          const innerText = (m[1] || "").trim();
          const repeat = Math.max(1, Number(m[2]) || 1);
          return { innerText, repeat };
        }
        return { innerText: s, repeat: 1 };
      }

      function extractParts(innerText) {
        const s = (innerText || "").trim();
        let tCmd = "";
        let sCmd = "";

        const mt = s.match(/\bT\s*:\s*([\s\S]*)/i);
        if (mt) {
          tCmd = mt[1] || "";
          const msInside = tCmd.match(/\bS\s*:\s*([\s\S]*)/i);
          if (msInside) {
            sCmd = msInside[1] || "";
            tCmd = tCmd.slice(0, msInside.index).trim();
          }
        }
        if (!sCmd) {
          const ms = s.match(/\bS\s*:\s*([\s\S]*)/i);
          if (ms) sCmd = ms[1] || "";
        }
        return { tCmd: tCmd.trim(), sCmd: sCmd.trim() };
      }

      function playBoth() {
        const { innerText, repeat } = unwrapOuterRepeat(masterCmd.value);
        const { tCmd, sCmd } = extractParts(innerText);

        if (tCmd) {
          tablaFrame.contentWindow?.postMessage(
            { type: "tabla:play", text: tCmd, repeat },
            TARGET_ORIGIN
          );
        }
        if (sCmd) {
          sitarFrame.contentWindow?.postMessage(
            { type: "sitar:play", text: sCmd, repeat },
            TARGET_ORIGIN
          );
        }
      }

      function stopBoth() {
        tablaFrame.contentWindow?.postMessage(
          { type: "tabla:stop" },
          TARGET_ORIGIN
        );
        sitarFrame.contentWindow?.postMessage(
          { type: "sitar:stop" },
          TARGET_ORIGIN
        );
      }

      document.getElementById("playBoth").addEventListener("click", playBoth);
      document.getElementById("stopBoth").addEventListener("click", stopBoth);

      document.getElementById("preset1").addEventListener("click", () => {
        masterCmd.value = "(T: 1,1,1 2,2,1  S: Sa Re x3) x10";
      });
      document.getElementById("preset2").addEventListener("click", () => {
        masterCmd.value = "(T: 1,2 x8  S: Sa Re Ga Ma Pa Dha Ni) x5";
      });

      // -------- Music Samples (Master combined) --------
      const samples = [
        {
          name: "ðŸŽ‚ Birthday (classic)",
          cmd: "(T: 1 2 1 2  1 2 1 2  3 4 3 4  1 2 1 2  S: Sa Sa Re Sa  Ma Ga | Sa Sa Re Sa  Pa Ma) x4",
        },
        {
          name: "ðŸŽ‰ Happy (fast)",
          cmd: "(T: 1,2 x8  3,4 x4  1,2 x8  S: Sa Re Ga Ma Pa Ma Ga Re) x6",
        },
        {
          name: "ðŸ’ Wedding (steady)",
          cmd: "(T: 1 2 2 1  3 4 4 3  S: Sa Re | Ga Ma | Pa Dha | Ni Sa) x8",
        },
        {
          name: "ðŸ˜” Sad (slow feel)",
          cmd: "(T: 1 1 2 1  3 3 4 3  S: Sa | Re Sa | Re Ga | Ma Ga Re) x6",
        },
        {
          name: "ðŸ™ Bhajan vibe",
          cmd: "(T: 1 2 1 2  1 2 1 2  S: Sa Re Sa | Ma Ga Re | Sa Re Ga | Ma Pa) x8",
        },
        {
          name: "ðŸ•º Dance (dholak-ish)",
          cmd: "(T: 1 2 1 2  3 4 3 4  1 2 1 2  3 4 3 4  S: Sa Re Ga Re  Sa Re Ga Re) x6",
        },
      ];

      const holder = document.getElementById("masterSamples");
      samples.forEach((s) => {
        const b = document.createElement("button");
        b.className = "chip";
        b.type = "button";
        b.textContent = s.name;
        b.addEventListener("click", () => {
          masterCmd.value = s.cmd;
          masterCmd.focus();
        });
        holder.appendChild(b);
      });

      updateReadyUI();
      setTimeout(pingIframes, 300);
      setTimeout(pingIframes, 1200);
    </script>
  </body>
</html>
