<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabla + Sitar — Command Sequences (xN loops)</title>
  <meta name="description" content="Clickable Tabla + command loops + synthesized Sitar + sitar command sequences with xN repeat." />
  <meta name="author" content="Champak Roy" />

  <style>
    :root{
      /* Light saffron theme */
      --bg:#fff7e6;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --brand:#d97706;
      --brand2:#f59e0b;
      --border:#eadcc5;
      --shadow:0 18px 40px rgba(31,41,55,.14);
      --ok:#166534;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .container{max-width:1180px;margin:28px auto;padding:18px}
    .hero{
      background:linear-gradient(135deg,#fff1d6, #ffffff);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    h1{margin:0 0 6px;color:var(--brand);font-size:28px}
    .sub{margin:0;color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px dashed rgba(217,119,6,.5);
      border-radius:999px;background:#fffaf1;color:var(--ink);font-weight:700;margin-top:10px;
    }
    .dot{width:9px;height:9px;border-radius:50%;background:var(--danger)}
    .dot.ok{background:var(--ok)}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin-top:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}

    /* Tabla */
    .stage{display:flex;align-items:center;justify-content:center;gap:22px;padding:14px 6px;flex-wrap:wrap}
    .drumWrap{text-align:center}
    .drumLabel{margin-top:10px;font-weight:800;color:var(--brand);letter-spacing:.2px}
    .hint{margin-top:4px;color:var(--muted);font-size:13px}
    .drum{
      width:260px;height:260px;border-radius:50%;position:relative;
      border:1px solid var(--border);
      box-shadow:0 16px 30px rgba(31,41,55,.18);
      cursor:pointer;user-select:none;touch-action:manipulation;outline:none;transform:translateZ(0);
    }
    .drum:active{transform:scale(0.99)}
    .bayan{background:radial-gradient(circle at 40% 35%, #fff, #f6ede0 40%, #e3d2ba 70%, #d0b18c 100%)}
    .dayan{background:radial-gradient(circle at 40% 35%, #fff, #f3efe6 40%, #d8c29c 75%, #c09a5a 100%)}
    .ring{position:absolute;inset:14px;border-radius:50%;border:2px solid rgba(0,0,0,.10);box-shadow:inset 0 0 0 10px rgba(255,255,255,.25);pointer-events:none}
    .ring2{position:absolute;inset:34px;border-radius:50%;border:2px solid rgba(0,0,0,.10);pointer-events:none}
    .syahi{
      position:absolute;width:92px;height:92px;left:50%;top:50%;transform:translate(-50%,-50%);
      border-radius:50%;background:radial-gradient(circle at 35% 30%, #3b3b3b, #111 60%, #000 100%);
      box-shadow:inset 0 0 0 6px rgba(255,255,255,.05);pointer-events:none;
    }
    .zone{position:absolute;border-radius:50%;background:rgba(255,255,255,0);border:2px dashed rgba(217,119,6,0);color:transparent;cursor:pointer}
    .zone:focus-visible{outline:3px solid rgba(245,158,11,.55);outline-offset:3px}
    .zone.center{width:120px;height:120px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .zone.rim{inset:18px}
    .bayan .zone.center{width:132px;height:132px}
    .bayan .zone.rim{inset:16px}

    /* UI */
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg,#fff, #fff7ea);
      color:var(--ink);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;
    }
    .btn.primary{border-color:rgba(217,119,6,.45);background:linear-gradient(180deg,#fff1d6,#ffe8bf)}
    .btn:active{transform:translateY(1px)}
    .small{font-size:13px;color:var(--muted);margin:10px 0 0}
    .log{
      margin-top:12px;border:1px solid var(--border);background:#fffaf1;border-radius:12px;padding:10px;min-height:120px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:13px;color:#111827;white-space:pre-wrap;overflow:auto;
    }
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      border:1px solid var(--border);background:#fff;padding:2px 6px;border-radius:7px;font-size:12px
    }
    label{display:block;font-weight:800;color:var(--ink)}
    input[type="text"]{
      width:100%;margin-top:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:#fffaf1;font-size:15px
    }
    .bpmRow{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    input[type="range"]{width:min(520px,100%)}
    .chip{
      display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fffaf1;border-radius:999px;
      padding:6px 10px;font-weight:800;color:var(--ink)
    }
    .now{
      display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(217,119,6,.35);background:#fff1d6;border-radius:12px;
      padding:8px 10px;font-weight:900;color:#7c2d12;margin-top:10px;
    }
    .pulse{
      width:10px;height:10px;border-radius:50%;background:var(--brand2);
      box-shadow:0 0 0 0 rgba(245,158,11,.6);animation:pulse 1s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(245,158,11,.55)}
      70%{box-shadow:0 0 0 12px rgba(245,158,11,0)}
      100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}
    }
    code{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      background:#fff;border:1px solid var(--border);padding:1px 6px;border-radius:7px
    }

    /* Sitar */
    .sitarBoard{border:1px solid var(--border);border-radius:18px;background:linear-gradient(180deg,#fffaf1,#fff);box-shadow:var(--shadow);padding:14px;margin-top:14px}
    .strings{margin-top:12px;display:grid;gap:10px}
    .stringRow{display:grid;grid-template-columns: 70px 1fr 92px;gap:10px;align-items:center}
    .noteTag{
      font-weight:900;color:#7c2d12;background:#fff1d6;border:1px solid rgba(217,119,6,.35);
      border-radius:999px;padding:6px 10px;text-align:center;
    }
    .stringBtn{
      width:100%;border:1px solid var(--border);border-radius:14px;padding:10px 12px;
      background:linear-gradient(180deg,#fff,#fff7ea);
      cursor:pointer;font-weight:900;color:var(--ink);text-align:left;
    }
    .stringBtn:active{transform:translateY(1px)}
    .freqTag{text-align:right;color:var(--muted);font-weight:800;font-size:13px}
  </style>
</head>

<body>
  <div class="container">
    <div class="hero">
      <h1>Tabla + Sitar — Command Sequences</h1>
      <p class="sub">Tabla uses MP3 files. Sitar is synthesized. Both support commands with <code>xN</code> loops.</p>

      <div class="pill">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Audio not unlocked yet — click any drum or sitar string once</span>
      </div>

      <p class="small" style="margin-top:10px;line-height:1.7">
        Tabla keys: <span class="kbd">N</span> Na, <span class="kbd">T</span> Tin, <span class="kbd">G</span> Ge
        &nbsp;•&nbsp;
        Sitar keys: <span class="kbd">A</span> Sa, <span class="kbd">S</span> Re, <span class="kbd">D</span> Ga, <span class="kbd">F</span> Ma, <span class="kbd">J</span> Pa, <span class="kbd">K</span> Dha, <span class="kbd">L</span> Ni
      </p>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2 style="margin:0 0 10px;color:var(--brand)">Tabla</h2>

        <div class="stage" aria-label="Tabla stage">
          <!-- BAYAN -->
          <div class="drumWrap">
            <div class="drum bayan" role="group" aria-label="Bayan drum">
              <div class="ring"></div><div class="ring2"></div><div class="syahi"></div>
              <button class="zone rim" data-bol="Ke" data-sound="bayan_ke" aria-label="Bayan rim: Ke"></button>
              <button class="zone center" data-bol="Ge" data-sound="bayan_ge" aria-label="Bayan center: Ge"></button>
            </div>
            <div class="drumLabel">Bayan (Left)</div>
            <div class="hint">Rim: Ke • Center: Ge</div>
          </div>

          <!-- DAYAN -->
          <div class="drumWrap">
            <div class="drum dayan" role="group" aria-label="Dayan drum">
              <div class="ring"></div><div class="ring2"></div><div class="syahi"></div>
              <button class="zone rim" data-bol="Na" data-sound="dayan_na" aria-label="Dayan rim: Na"></button>
              <button class="zone center" data-bol="Tin" data-sound="dayan_tin" aria-label="Dayan center: Tin"></button>
            </div>
            <div class="drumLabel">Dayan (Right)</div>
            <div class="hint">Rim: Na • Center: Tin</div>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnTest">Test Tabla (Na Tin Ge Ke)</button>
          <button class="btn" id="btnClear">Clear Log</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:14px 0" />

        <h3 style="margin:0 0 10px;color:var(--brand)">Tabla Command Player (with loops)</h3>
        <label>
          Numbers 1–4. Loop with <code>xN</code> like <code>1,2 x4</code>
          <input id="cmdInput" type="text" value="1,1,1  2,2,1  1,2 x4" />
        </label>

        <div class="bpmRow" style="margin-top:10px">
          <label style="margin:0;min-width:160px">Tempo (BPM)</label>
          <input id="tablaBpm" type="range" min="40" max="240" value="120" />
          <span class="chip"><span id="tablaBpmLabel">120</span> BPM</span>
        </div>

        <div class="row">
          <button class="btn primary" id="cmdPlay">Play Tabla Commands</button>
          <button class="btn" id="cmdStop">Stop Tabla</button>
          <button class="btn" id="presetA">Preset: 1,2 x4</button>
          <button class="btn" id="presetB">Preset: 1,1,1 2,2,1</button>
        </div>

        <div class="small" style="margin-top:8px;line-height:1.55">
          Mapping: <b>1=Na</b>, <b>2=Tin</b>, <b>3=Ge</b>, <b>4=Ke</b>.
        </div>

        <!-- Sitar -->
        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0" />
        <h2 style="margin:0 0 10px;color:var(--brand)">Sitar</h2>

        <div class="sitarBoard">
          <div class="row" style="margin-top:0">
            <button class="btn primary" id="sitarDemo">Sitar Demo: Sa Re Ga Ma</button>
            <button class="btn" id="sitarStop">Stop Sitar</button>
          </div>

          <div class="strings" id="strings"></div>

          <hr style="border:none;border-top:1px solid var(--border);margin:14px 0" />

          <h3 style="margin:0 0 10px;color:var(--brand)">Sitar Command Player (with loops)</h3>
          <label>
            Use note names: <code>Sa Re Ga Ma Pa Dha Ni</code>. Loop with <code>xN</code> like <code>Sa Re x4</code>
            <input id="sitarCmdInput" type="text" value="Sa Re Ga Ma  Sa Re x3  Pa Dha Ni x2" />
          </label>

          <div class="bpmRow" style="margin-top:10px">
            <label style="margin:0;min-width:160px">Sitar Tempo (BPM)</label>
            <input id="sitarBpm" type="range" min="40" max="240" value="110" />
            <span class="chip"><span id="sitarBpmLabel">110</span> BPM</span>
          </div>

          <div class="row">
            <button class="btn primary" id="sitarCmdPlay">Play Sitar Commands</button>
            <button class="btn" id="sitarCmdStop">Stop Sitar Commands</button>
            <button class="btn" id="sitarPreset1">Preset: Sa Re x4</button>
            <button class="btn" id="sitarPreset2">Preset: Sa Re Ga Ma Pa Dha Ni</button>
          </div>

          <div class="small" style="margin-top:8px;line-height:1.55">
            Examples: <code>Sa Re x4</code>, <code>Sa Re Ga Ma | Pa Dha Ni</code> (you can type the <code>|</code> as a visual separator).
          </div>
        </div>

        <div class="now" id="nowPlaying" style="display:none">
          <span class="pulse"></span>
          <span id="nowText">Now: …</span>
        </div>

        <div class="log" id="log" aria-live="polite">Ready. Click a tabla zone, run tabla commands, or play sitar…</div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2 style="margin:0 0 10px;color:var(--brand)">Tabla Audio Files</h2>
        <p style="margin:0;color:var(--muted)">Put these MP3 files next to this HTML file:</p>
        <ul style="margin:10px 0 0;color:var(--ink)">
          <li><b>dayan_na.mp3</b></li>
          <li><b>dayan_tin.mp3</b></li>
          <li><b>bayan_ge.mp3</b></li>
          <li><b>bayan_ke.mp3</b></li>
        </ul>
        <p class="small">Sitar needs no files (it is synthesized).</p>

        <hr style="border:none;border-top:1px solid var(--border);margin:14px 0" />

        <h3 style="margin:0 0 8px;color:var(--brand)">Command Syntax</h3>
        <div class="small" style="line-height:1.8">
          • Tabla: numbers <code>1 2 3 4</code> + loops <code>xN</code><br/>
          • Sitar: note names <code>Sa Re Ga Ma Pa Dha Ni</code> + loops <code>xN</code><br/>
          • Separator <code>|</code> is allowed (ignored in playback)
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- Shared logging + unlocking ----------------
    const logEl = document.getElementById("log");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const nowPlaying = document.getElementById("nowPlaying");
    const nowText = document.getElementById("nowText");

    let audioUnlocked = false;

    function stamp() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${hh}:${mm}:${ss}`;
    }
    function log(msg) {
      logEl.textContent += `\n[${stamp()}] ${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setUnlocked(on) {
      audioUnlocked = on;
      statusDot.classList.toggle("ok", on);
      statusText.textContent = on
        ? "Audio unlocked — enjoy playing!"
        : "Audio not unlocked yet — click any drum or sitar string once";
    }

    // ---------------- Tabla (audio files) ----------------
    const sounds = {
      dayan_na: "dayan_na.mp3",
      dayan_tin: "dayan_tin.mp3",
      bayan_ge: "bayan_ge.mp3",
      bayan_ke: "bayan_ke.mp3",
    };
    const audioCache = {};

    function preloadTablaAudio() {
      for (const key of Object.keys(sounds)) {
        const a = new Audio(sounds[key]);
        a.preload = "auto";
        audioCache[key] = a;
      }
    }

    function playTabla(soundKey, bol) {
      const file = sounds[soundKey];
      if (!file) { log(`Missing tabla mapping for ${soundKey}`); return; }
      const base = audioCache[soundKey] || new Audio(file);
      const a = base.cloneNode(true);
      a.currentTime = 0;
      a.play().then(() => {
        nowText.textContent = `Now: Tabla ${bol}`;
        nowPlaying.style.display = "inline-flex";
        log(`Tabla: ${bol}`);
      }).catch(() => log(`Could not play Tabla "${bol}". File missing? (${file})`));
    }

    // ---------------- Sitar (WebAudio synth) ----------------
    let audioCtx = null;
    let sitarMaster = null;
    const activeSitarNodes = new Set();

    function ensureAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        sitarMaster = audioCtx.createGain();
        sitarMaster.gain.value = 0.85;
        sitarMaster.connect(audioCtx.destination);
      }
      if (audioCtx.state === "suspended") audioCtx.resume();
    }

    async function unlockAudioOnce() {
      if (audioUnlocked) return;
      try {
        ensureAudioContext();
        preloadTablaAudio();

        // attempt a muted play to unlock <audio>
        const a = audioCache.dayan_na || new Audio(sounds.dayan_na);
        a.muted = true;
        const p = a.play();
        if (p && typeof p.then === "function") await p;
        a.pause();
        a.currentTime = 0;
        a.muted = false;

        setUnlocked(true);
        log("Audio unlocked.");
      } catch (e) {
        log("Audio unlock attempt failed (click again).");
      }
    }

    // Tabla click zones
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".zone");
      if (!btn) return;
      await unlockAudioOnce();
      playTabla(btn.dataset.sound, btn.dataset.bol);
    });

    // Test Tabla
    document.getElementById("btnTest").addEventListener("click", async () => {
      await unlockAudioOnce();
      log("Testing Tabla: Na Tin Ge Ke");
      const seq = [
        ["dayan_na", "Na"],
        ["dayan_tin", "Tin"],
        ["bayan_ge", "Ge"],
        ["bayan_ke", "Ke"],
      ];
      let i = 0;
      const t = setInterval(() => {
        const item = seq[i++];
        if (!item) { clearInterval(t); return; }
        playTabla(item[0], item[1]);
      }, 350);
    });

    // Clear log
    document.getElementById("btnClear").addEventListener("click", () => {
      logEl.textContent = "Ready. Click a tabla zone, run tabla commands, or play sitar…";
      nowPlaying.style.display = "none";
    });

    // ---------------- Tabla Command Player (xN loops) ----------------
    const cmdInput = document.getElementById("cmdInput");
    const cmdPlay = document.getElementById("cmdPlay");
    const cmdStop = document.getElementById("cmdStop");
    const tablaBpm = document.getElementById("tablaBpm");
    const tablaBpmLabel = document.getElementById("tablaBpmLabel");
    const presetA = document.getElementById("presetA");
    const presetB = document.getElementById("presetB");

    tablaBpm.addEventListener("input", () => (tablaBpmLabel.textContent = tablaBpm.value));
    presetA.addEventListener("click", () => (cmdInput.value = "1,2 x4"));
    presetB.addEventListener("click", () => (cmdInput.value = "1,1,1  2,2,1"));

    const numToBol = {
      1: ["dayan_na", "Na"],
      2: ["dayan_tin", "Tin"],
      3: ["bayan_ge", "Ge"],
      4: ["bayan_ke", "Ke"],
    };

    let tablaTimer = null, tablaIdx = 0, tablaSeq = [];

    function stopTablaCommands() {
      if (tablaTimer) clearInterval(tablaTimer);
      tablaTimer = null;
      tablaIdx = 0;
    }

    function expandNumberCommands(text) {
      const tokens = (text || "").trim().split(/[\s,]+/).filter(Boolean);
      const out = [];
      let phraseStart = 0;

      for (const raw of tokens) {
        const t = raw.trim();
        if (!t) continue;

        if (t === "|" || t === "/") { // visual separators
          phraseStart = out.length;
          continue;
        }

        const m = /^x(\d+)$/i.exec(t);
        if (m) {
          const times = Math.max(0, Number(m[1]) || 0);
          const phrase = out.slice(phraseStart);
          if (phrase.length === 0) continue;
          for (let r = 1; r < times; r++) out.push(...phrase);
          phraseStart = out.length;
          continue;
        }

        const n = Number(t);
        if (Number.isFinite(n) && n >= 1 && n <= 4) {
          out.push(n);
          continue;
        }

        const digs = t.match(/[1-4]/g);
        if (digs) digs.forEach(d => out.push(Number(d)));
      }
      return out;
    }

    cmdStop.addEventListener("click", () => {
      stopTablaCommands();
      log("Tabla command player stopped.");
    });

    cmdPlay.addEventListener("click", async () => {
      await unlockAudioOnce();
      tablaSeq = expandNumberCommands(cmdInput.value);
      if (!tablaSeq.length) { log("No valid Tabla commands. Use 1-4 and xN."); return; }

      stopTablaCommands();
      tablaIdx = 0;

      const beatMs = Math.max(60, Math.round(60000 / Number(tablaBpm.value || 120)));
      log(`Tabla commands @ ${tablaBpm.value} BPM`);
      log(`Tabla expanded (${tablaSeq.length}): ${tablaSeq.join(",")}`);

      const first = numToBol[tablaSeq[0]];
      if (first) playTabla(first[0], first[1]);
      tablaIdx = 1;

      tablaTimer = setInterval(() => {
        if (tablaIdx >= tablaSeq.length) { stopTablaCommands(); log("Tabla sequence finished."); return; }
        const step = tablaSeq[tablaIdx++];
        const m = numToBol[step];
        if (m) playTabla(m[0], m[1]);
      }, beatMs);
    });

    // ---------------- Sitar Notes + Pluck ----------------
    const sitarNotes = [
      { name: "Sa", hz: 261.63 },
      { name: "Re", hz: 293.66 },
      { name: "Ga", hz: 329.63 },
      { name: "Ma", hz: 349.23 },
      { name: "Pa", hz: 392.00 },
      { name: "Dha", hz: 440.00 },
      { name: "Ni", hz: 493.88 },
    ];

    const sitarMap = Object.fromEntries(sitarNotes.map(n => [n.name.toLowerCase(), n]));
    const stringsEl = document.getElementById("strings");

    function renderSitar() {
      stringsEl.innerHTML = "";
      sitarNotes.forEach((n) => {
        const row = document.createElement("div");
        row.className = "stringRow";

        const tag = document.createElement("div");
        tag.className = "noteTag";
        tag.textContent = n.name;

        const btn = document.createElement("button");
        btn.className = "stringBtn";
        btn.type = "button";
        btn.textContent = `Pluck ${n.name}`;
        btn.addEventListener("click", async () => {
          await unlockAudioOnce();
          pluckSitar(n.hz, n.name);
        });

        const freq = document.createElement("div");
        freq.className = "freqTag";
        freq.textContent = `${n.hz.toFixed(2)} Hz`;

        row.appendChild(tag);
        row.appendChild(btn);
        row.appendChild(freq);
        stringsEl.appendChild(row);
      });
    }

    function pluckSitar(freq, label) {
      ensureAudioContext();
      const now = audioCtx.currentTime;

      const burstDur = 0.045;
      const noiseBuf = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * burstDur), audioCtx.sampleRate);
      const ch = noiseBuf.getChannelData(0);
      for (let i = 0; i < ch.length; i++) ch[i] = (Math.random() * 2 - 1) * 0.9;

      const src = audioCtx.createBufferSource();
      src.buffer = noiseBuf;

      const delay = audioCtx.createDelay(1.0);
      delay.delayTime.value = 1 / freq;

      const feedback = audioCtx.createGain();
      feedback.gain.value = 0.985;

      const damp = audioCtx.createBiquadFilter();
      damp.type = "lowpass";
      damp.frequency.value = 2200;
      damp.Q.value = 0.7;

      const zing = audioCtx.createBiquadFilter();
      zing.type = "bandpass";
      zing.frequency.value = Math.min(5200, freq * 8);
      zing.Q.value = 8;

      const amp = audioCtx.createGain();
      amp.gain.setValueAtTime(0.0001, now);
      amp.gain.exponentialRampToValueAtTime(0.9, now + 0.005);
      amp.gain.exponentialRampToValueAtTime(0.0001, now + 1.6);

      src.connect(delay);
      delay.connect(damp);
      damp.connect(zing);
      zing.connect(amp);
      amp.connect(sitarMaster);

      damp.connect(feedback);
      feedback.connect(delay);

      src.start(now);
      src.stop(now + burstDur);

      const pack = { src, delay, damp, zing, feedback, amp };
      activeSitarNodes.add(pack);

      src.onended = () => {
        setTimeout(() => {
          try{ src.disconnect(); delay.disconnect(); damp.disconnect(); zing.disconnect(); feedback.disconnect(); amp.disconnect(); }catch(_){}
          activeSitarNodes.delete(pack);
        }, 1800);
      };

      nowText.textContent = `Now: Sitar ${label}`;
      nowPlaying.style.display = "inline-flex";
      log(`Sitar: ${label}`);
    }

    function pluckSitarByName(name) {
      const n = sitarMap[(name || "").toLowerCase()];
      if (!n) return false;
      pluckSitar(n.hz, n.name);
      return true;
    }

    function stopSitarAll() {
      if (!audioCtx) return;
      activeSitarNodes.forEach(pack => {
        try {
          pack.amp.gain.cancelScheduledValues(audioCtx.currentTime);
          pack.amp.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        } catch(_){}
      });
      log("Sitar stopped (fade out).");
    }

    document.getElementById("sitarStop").addEventListener("click", async () => {
      await unlockAudioOnce();
      stopSitarAll();
    });

    document.getElementById("sitarDemo").addEventListener("click", async () => {
      await unlockAudioOnce();
      log("Sitar demo: Sa Re Ga Ma");
      const seq = ["Sa","Re","Ga","Ma"];
      let i = 0;
      const t = setInterval(() => {
        const name = seq[i++];
        if (!name) { clearInterval(t); return; }
        pluckSitarByName(name);
      }, 420);
    });

    // ---------------- Sitar Command Player (xN loops) ----------------
    const sitarCmdInput = document.getElementById("sitarCmdInput");
    const sitarCmdPlay = document.getElementById("sitarCmdPlay");
    const sitarCmdStop = document.getElementById("sitarCmdStop");
    const sitarBpm = document.getElementById("sitarBpm");
    const sitarBpmLabel = document.getElementById("sitarBpmLabel");
    const sitarPreset1 = document.getElementById("sitarPreset1");
    const sitarPreset2 = document.getElementById("sitarPreset2");

    sitarBpm.addEventListener("input", () => (sitarBpmLabel.textContent = sitarBpm.value));
    sitarPreset1.addEventListener("click", () => (sitarCmdInput.value = "Sa Re x4"));
    sitarPreset2.addEventListener("click", () => (sitarCmdInput.value = "Sa Re Ga Ma Pa Dha Ni"));

    let sitarTimer = null, sitarIdx = 0, sitarSeq = [];

    function stopSitarCommands() {
      if (sitarTimer) clearInterval(sitarTimer);
      sitarTimer = null;
      sitarIdx = 0;
      log("Sitar command player stopped.");
    }

    // Expand sitar tokens: note names + xN loops. Ignores unknown tokens.
    // Accept separators: spaces/commas. Visual separators "|" reset phrase boundary.
    // Example: "Sa Re x4" => Sa Re Sa Re Sa Re Sa Re
    function expandSitarCommands(text) {
      const tokens = (text || "")
        .replace(/[,]+/g, " ")
        .trim()
        .split(/\s+/)
        .filter(Boolean);

      const out = [];
      let phraseStart = 0;

      for (const raw of tokens) {
        const t = raw.trim();
        if (!t) continue;

        if (t === "|" || t === "/") { // visual boundary
          phraseStart = out.length;
          continue;
        }

        const m = /^x(\d+)$/i.exec(t);
        if (m) {
          const times = Math.max(0, Number(m[1]) || 0);
          const phrase = out.slice(phraseStart);
          if (!phrase.length) continue;
          for (let r = 1; r < times; r++) out.push(...phrase);
          phraseStart = out.length;
          continue;
        }

        // normalize: allow SA, sa, Sa, and also "dha", etc.
        const key = t.toLowerCase();
        if (sitarMap[key]) {
          out.push(sitarMap[key].name); // store canonical name
          continue;
        }

        // allow "SARE" pasted? try split by non-letters? (skip for safety)
      }
      return out;
    }

    sitarCmdStop.addEventListener("click", () => stopSitarCommands());

    sitarCmdPlay.addEventListener("click", async () => {
      await unlockAudioOnce();

      sitarSeq = expandSitarCommands(sitarCmdInput.value);
      if (!sitarSeq.length) { log("No valid Sitar commands. Use Sa Re Ga Ma Pa Dha Ni and xN."); return; }

      stopSitarCommands();
      sitarIdx = 0;

      const beatMs = Math.max(60, Math.round(60000 / Number(sitarBpm.value || 110)));
      log(`Sitar commands @ ${sitarBpm.value} BPM`);
      log(`Sitar expanded (${sitarSeq.length}): ${sitarSeq.join(" ")}`);

      // play immediately
      pluckSitarByName(sitarSeq[0]);
      sitarIdx = 1;

      sitarTimer = setInterval(() => {
        if (sitarIdx >= sitarSeq.length) {
          stopSitarCommands();
          log("Sitar sequence finished.");
          return;
        }
        pluckSitarByName(sitarSeq[sitarIdx++]);
      }, beatMs);
    });

    // Keyboard shortcuts (Sitar)
    document.addEventListener("keydown", async (e) => {
      const k = e.key.toLowerCase();

      // Tabla quick keys
      if (["n","t","g"].includes(k)) {
        await unlockAudioOnce();
        if (k === "n") playTabla("dayan_na", "Na");
        if (k === "t") playTabla("dayan_tin", "Tin");
        if (k === "g") playTabla("bayan_ge", "Ge");
      }

      // Sitar keys
      const keyToSitar = { a:"Sa", s:"Re", d:"Ga", f:"Ma", j:"Pa", k:"Dha", l:"Ni" };
      if (keyToSitar[k]) {
        await unlockAudioOnce();
        pluckSitarByName(keyToSitar[k]);
      }
    });

    // Initial render
    renderSitar();
  </script>
</body>
</html>