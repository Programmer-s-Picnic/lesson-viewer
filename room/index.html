<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Virtual Classroom Board</title>

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui;
        background: #111;
      }

      .topbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
      }
      button {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        background: #fff;
        font-weight: 600;
        cursor: pointer;
      }
      button.primary {
        border: none;
        background: linear-gradient(145deg, #ffb020, #ff7a18);
      }
      button.active {
        outline: 2px solid orange;
      }
      input[type="range"] {
        width: 100px;
      }

      .stage {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }

      .bg {
        position: absolute;
        inset: 0;
        background: url("classroom.jpg") center/cover no-repeat;
      }

      .boardBox {
        position: absolute;
        left: 40%;
        top: 55%;
        width: 45%;
        height: 30%;
        border-radius: 8px;
      }

      canvas {
        width: 100%;
        height: 100%;
        display: block;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
      }

      .calibOutline {
        position: absolute;
        inset: -2px;
        border: 2px dashed orange;
        display: none;
      }

      .handle {
        position: absolute;
        width: 16px;
        height: 16px;
        background: orange;
        border-radius: 50%;
        display: none;
      }
      .h-se {
        right: -8px;
        bottom: -8px;
        cursor: nwse-resize;
      }
    </style>
  </head>

  <body>
    <div class="topbar">
      <button id="penBtn" class="primary active">Pen</button>
      <button id="eraserBtn">Eraser</button>

      <input type="color" id="color" value="#111827" />
      <input type="range" id="size" min="2" max="30" value="6" />
      <span id="sizeVal">6</span>

      <button id="clearBtn">Clear</button>
      <button id="saveBtn">Save PNG</button>
      <button id="calibBtn">Calibrate</button>
    </div>

    <div class="stage">
      <div class="bg"></div>

      <div class="boardBox" id="boardBox">
        <div class="calibOutline" id="outline"></div>
        <div class="handle h-se" id="resizeHandle"></div>
        <canvas id="board"></canvas>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("board");
      const ctx = canvas.getContext("2d");
      const boardBox = document.getElementById("boardBox");

      const penBtn = document.getElementById("penBtn");
      const eraserBtn = document.getElementById("eraserBtn");
      const colorEl = document.getElementById("color");
      const sizeEl = document.getElementById("size");
      const sizeVal = document.getElementById("sizeVal");
      const clearBtn = document.getElementById("clearBtn");
      const saveBtn = document.getElementById("saveBtn");
      const calibBtn = document.getElementById("calibBtn");

      const outline = document.getElementById("outline");
      const resizeHandle = document.getElementById("resizeHandle");

      let tool = "pen";
      let drawing = false;
      let last = null;
      let calibrate = false;

      function resizeCanvas() {
        const rect = boardBox.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      new ResizeObserver(resizeCanvas).observe(boardBox);

      function getPos(e) {
        const r = canvas.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      }

      function stroke(a, b) {
        ctx.lineWidth = Number(sizeEl.value);
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        if (tool === "eraser") {
          ctx.globalCompositeOperation = "destination-out";
          ctx.strokeStyle = "rgba(0,0,0,1)";
        } else {
          ctx.globalCompositeOperation = "source-over";
          ctx.strokeStyle = colorEl.value;
        }
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
      }

      canvas.addEventListener("pointerdown", (e) => {
        if (calibrate) return;
        drawing = true;
        last = getPos(e);
      });
      canvas.addEventListener("pointermove", (e) => {
        if (!drawing || calibrate) return;
        const p = getPos(e);
        stroke(last, p);
        last = p;
      });
      window.addEventListener("pointerup", () => (drawing = false));

      penBtn.onclick = () => {
        tool = "pen";
        penBtn.classList.add("active");
        eraserBtn.classList.remove("active");
      };
      eraserBtn.onclick = () => {
        tool = "eraser";
        eraserBtn.classList.add("active");
        penBtn.classList.remove("active");
      };
      sizeEl.oninput = () => (sizeVal.textContent = sizeEl.value);
      clearBtn.onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

      calibBtn.onclick = () => {
        calibrate = !calibrate;
        outline.style.display = calibrate ? "block" : "none";
        resizeHandle.style.display = calibrate ? "block" : "none";
      };

      let resizing = false;
      resizeHandle.addEventListener("pointerdown", () => (resizing = true));
      window.addEventListener("pointermove", (e) => {
        if (!resizing) return;
        const rect = boardBox.getBoundingClientRect();
        boardBox.style.width = e.clientX - rect.left + "px";
        boardBox.style.height = e.clientY - rect.top + "px";
      });
      window.addEventListener("pointerup", () => (resizing = false));

      saveBtn.onclick = () => {
        const stage = document.querySelector(".stage");
        const stageRect = stage.getBoundingClientRect();

        const output = document.createElement("canvas");
        const dpr = window.devicePixelRatio || 1;
        output.width = stageRect.width * dpr;
        output.height = stageRect.height * dpr;
        const octx = output.getContext("2d");
        octx.scale(dpr, dpr);

        const img = new Image();
        img.onload = function () {
          octx.drawImage(img, 0, 0, stageRect.width, stageRect.height);
          const boardRect = boardBox.getBoundingClientRect();
          const x = boardRect.left - stageRect.left;
          const y = boardRect.top - stageRect.top;
          octx.drawImage(canvas, x, y, boardRect.width, boardRect.height);

          const link = document.createElement("a");
          link.download = "full-classroom-board.png";
          link.href = output.toDataURL("image/png");
          link.click();
        };
        img.src = "classroom.jpg";
      };
    </script>
  </body>
</html>
