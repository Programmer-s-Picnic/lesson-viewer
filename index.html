<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Programmer's Picnic ‚Äì Lesson Viewer</title>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff7e6;
            font-family: system-ui, sans-serif;
            color: #3a2a1a;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 20px;
            background: #fffaf0;
            border-radius: 16px;
            border: 1px solid #f3c26b;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .section-box {
            margin-top: 12px;
            padding: 12px;
            background: #fff3d1;
            border-radius: 10px;
            border: 1px solid #f1b14b;
        }

        iframe {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            border: none;
        }

        .tag {
            background: #ffe7b3;
            padding: 3px 7px;
            margin: 3px;
            border-radius: 6px;
            display: inline-block;
            font-size: 0.8rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        td {
            padding: 6px;
            border-bottom: 1px solid #e9c48f;
        }

        .short-item {
            background: #fff8dd;
            padding: 6px;
            margin: 4px 0;
            border-radius: 6px;
        }

        pre {
            position: relative;
            background: #fff1c9;
            padding: 12px;
            white-space: pre-wrap;
            border-radius: 10px;
            border: 1px dashed #e0a850;
        }

        .copy-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #ffd27f;
            border: 1px solid #bb7a00;
            padding: 3px 7px;
            font-size: 0.7rem;
            border-radius: 6px;
            cursor: pointer;
        }

        #editor {
            width: 100%;
            height: 220px;
            border: 1px solid #c9992f;
            border-radius: 8px;
            background: #fff8e1;
            padding: 10px;
            font-family: monospace;
            overflow-y: auto;
        }

        #output {
            background: #0f172a;
            color: #e5e7eb;
            padding: 10px;
            border-radius: 10px;
            min-height: 120px;
            white-space: pre-wrap;
        }

        .wrong {
            color: #FF7F7F;
        }

        .correct {
            color: lightgreen;
        }

        .lesson-meta-panel h3 {
            margin-top: 0;
        }

        .meta-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .meta-chip {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            background: #ffe7b3;
            border: 1px solid #f1b14b;
        }

        .xp-chip {
            background: #dcfce7;
            border-color: #16a34a;
            color: #166534;
            font-weight: 600;
        }

        .badge-chip {
            background: #fee2e2;
            border-color: #ef4444;
            color: #b91c1c;
            font-weight: 600;
        }

        .keyword-chip {
            background: #fff;
            border-style: dashed;
        }

        .quiz-item {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background: #fff8dd;
            border: 1px solid #f3c26b;
        }

        .quiz-item.correct {
            border-color: #16a34a;
            background: #dcfce7;
        }

        .quiz-item.wrong {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .explanation {
            margin-top: 4px;
            font-size: 0.85rem;
        }

        .nav-lessons .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-nav {
            flex: 1;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid #b57400;
            background: #ffcc73;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-nav[disabled] {
            opacity: 0.5;
            cursor: default;
            background: #ffeac0;
        }

        .slide-svg-wrapper {
            margin-bottom: 8px;
            animation: fadeInSlide 0.3s ease-out;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="container">

        <h1>Programmer‚Äôs Picnic ‚Äî Lesson Viewer</h1>

        <div id="content">
            <p>Loading lesson content...</p>
        </div>

        <hr style="margin:30px 0;">

        <h2>Python Playground (Pyodide)</h2>

        <div id="editor" contenteditable="true">print("Welcome!")</div>

        <button type='button'  id="runBtn">‚ñ∂ Run Code</button>
        <button  type='button' id="testBtn">üß† Test Code</button>
        <button type='button'  id="shareBtn">üîó Share Code</button>

        <h3>Output:</h3>
        <div id="output"></div>
        <p id="testMsg" style="font-weight:bold;"></p>

    </div>

    <script>
        const MAX_LESSON_ID = 22;
        const MIN_LESSON_ID = 1;

        /* ------------------ Pyodide ------------------ */
        let pyodide = null, pyodideReady = false;

        async function loadPy() {
            try {
                pyodide = await loadPyodide();
                pyodide.setStdout({ batched: msg => output.innerText += msg });
                pyodide.setStderr({ batched: msg => output.innerText += "Error: " + msg });
                pyodideReady = true;
            } catch (e) {
                output.innerText = "Failed to load Pyodide: " + e;
            }
        }
        loadPy();

        /* ------------------ URL + Lesson Loading ------------------ */
        const url = new URL(window.location.href);
        const lessonURL = url.searchParams.get("json");
        let lessonData = null;

        if (lessonURL) {
            fetch(lessonURL)
                .then(r => r.json())
                .then(data => {
                    lessonData = data;
                    renderLesson(data);
                })
                .catch(err => {
                    document.getElementById("content").innerHTML =
                        "<p>Failed to load lesson JSON.</p><pre>" + err + "</pre>";
                });
        } else {
            document.getElementById("content").innerHTML =
                "<p>No JSON URL provided.</p>";
        }

        /* ------------------ Render Helpers ------------------ */
        function renderMeta(lesson) {
            const chips = [];

            if (lesson.duration) {
                chips.push(`<span class="meta-chip">‚è± ${lesson.duration}</span>`);
            }
            if (lesson.difficulty) {
                chips.push(`<span class="meta-chip">üéØ Difficulty: ${lesson.difficulty}</span>`);
            }
            if (lesson.category) {
                chips.push(`<span class="meta-chip">üìÇ ${lesson.category}</span>`);
            }
            if (lesson.rewardXP) {
                chips.push(`<span class="meta-chip xp-chip">‚≠ê ${lesson.rewardXP} XP</span>`);
            }
            if (lesson.badge) {
                chips.push(`<span class="meta-chip badge-chip">üèÖ ${lesson.badge}</span>`);
            }

            let keywordHTML = "";
            if (Array.isArray(lesson.keywords) && lesson.keywords.length > 0) {
                keywordHTML = `
                    <div style="margin-top:8px;">
                        ${lesson.keywords.map(k => `<span class="meta-chip keyword-chip">#${k}</span>`).join("")}
                    </div>
                `;
            }

            if (!chips.length && !keywordHTML) return "";

            return `
                <div class="section-box lesson-meta-panel">
                    <h3>Lesson Meta</h3>
                    <div class="meta-chips">
                        ${chips.join("")}
                    </div>
                    ${keywordHTML}
                </div>
            `;
        }

        function renderNav(lesson) {
            const id = lesson.id;
            if (!id) return "";

            const prevId = id > MIN_LESSON_ID ? id - 1 : null;
            const nextId = id < MAX_LESSON_ID ? id + 1 : null;

            return `
                <div class="section-box nav-lessons">
                    <h3>Continue Learning</h3>
                    <div class="nav-buttons">
                        <button  type='button'  class="btn-nav" ${prevId ? `onclick="goToLesson(${prevId})"` : "disabled"}>
                            ‚¨Ö ${prevId ? `Lesson ${prevId}` : "No previous"}
                        </button>
                        <button type='button'  class="btn-nav" ${nextId ? `onclick="goToLesson(${nextId})"` : "disabled"}>
                            ${nextId ? `Lesson ${nextId} ‚û°` : "Last lesson"}
                        </button>
                    </div>
                </div>
            `;
        }

        /* ------------------ Render Lesson ------------------ */
        function renderLesson(lesson) {
            const c = document.getElementById("content");

            c.innerHTML = `
                <h2>${lesson.title}</h2>

                ${renderMeta(lesson)}

                ${renderVideosSection(lesson.youtubeVideos)}

                <div class='section-box'>
                    <h3>Video Script</h3>
                    <pre>${lesson.videoScript || "No video script provided."}</pre>
                </div>

                <div class='section-box'>
                    <h3>Blog Article</h3>
                    <div id="blogArticleBox"></div>
                </div>

                ${Array.isArray(lesson.practiceProblems) ? `
                <div class='section-box'>
                    <h3>Practice Problems</h3>
                    <ul>${lesson.practiceProblems.map(p => `<li>${p}</li>`).join("")}</ul>
                </div>` : ""}

                ${Array.isArray(lesson.homework) ? `
                <div class='section-box'>
                    <h3>Homework</h3>
                    <ul>${lesson.homework.map(p => `<li>${p}</li>`).join("")}</ul>
                </div>` : ""}

                <div class='section-box' id='quizBox' style='display:none;'>
                    <h3>Quick Quiz</h3>
                    <div id='quizQuestions'></div>
                    <button type='button'  id="submitQuizBtn">Submit Quiz</button>
                    <p id='quizResult'></p>
                </div>

                <div class='section-box' id='slidesSection' style='display:none;'>
                    <h3>Slides</h3>
                    <div id='slideViewer'></div>
                    <div style="text-align:center;">
                        <button type='button' id='prevSlideBtn'>‚¨Ö Prev</button>
                        <span id='slideCounter'></span>
                        <button  type='button'  id='nextSlideBtn'>Next ‚û°</button>
                    </div>
                </div>

                ${renderNav(lesson)}
            `;

            document.getElementById("blogArticleBox").innerHTML =
                lesson.blogArticle ? marked.parse(lesson.blogArticle) : "<p>No article provided.</p>";

            if (Array.isArray(lesson.quiz) && lesson.quiz.length) renderQuiz(lesson.quiz);
            if (Array.isArray(lesson.slidesSVG) && lesson.slidesSVG.length) setupSlides();

            addCopyButtons();
        }

        /* ------------------ Videos Section ------------------ */
        function renderVideosSection(videos) {
            if (!Array.isArray(videos) || videos.length === 0) return "";

            return `
                <div class='section-box'>
                    <h3>Videos</h3>
                    ${videos.map(v => `
                        <div class='video-block' style="margin-bottom:16px;">
                            <h4>${v.title}</h4>
                            <iframe src="https://www.youtube.com/embed/${v.videoId}" allowfullscreen></iframe>

                            <p>${v.description || ""}</p>

                            <div>
                                ${Array.isArray(v.tags) ? v.tags.map(t => `<span class='tag'>${t}</span>`).join("") : ""}
                            </div>

                            ${v.chapters?.length ? `
                                <table>
                                    ${v.chapters.map(ch => `
                                        <tr><td>${ch.time}</td><td>${ch.title}</td></tr>
                                    `).join("")}
                                </table>
                            ` : ""}

                            ${v.shorts?.length ? `
                                <h5>Shorts</h5>
                                ${v.shorts.map(s => `
                                    <div class='short-item'>
                                        üé¨ <b>${s.title}</b> ‚Äî <code>${s.id}</code>
                                    </div>
                                `).join("")}
                            ` : ""}
                        </div>
                    `).join("")}
                </div>
            `;
        }

        /* ------------------ Quiz Rendering ------------------ */
        function renderQuiz(quiz) {
            const box = document.getElementById("quizBox");
            box.style.display = "block";

            document.getElementById("quizQuestions").innerHTML =
                quiz.map((q, i) => `
                    <div class="quiz-item" id="quiz-${i}">
                        <strong>${q.question}</strong><br>
                        ${q.options.map((op, j) =>
                    `<label><input type='radio' name='q${i}' value='${j}'> ${op}</label><br>`
                ).join("")}
                        <div class="explanation" id="exp-${i}" style="display:none;"></div>
                    </div>
                `).join("");

            document.getElementById("submitQuizBtn").onclick = submitQuiz;
        }

        function submitQuiz() {
            const quiz = (lessonData && Array.isArray(lessonData.quiz)) ? lessonData.quiz : null;
            const resultEl = document.getElementById("quizResult");
            if (!quiz || !quiz.length) {
                if (resultEl) {
                    resultEl.innerText = "No quiz for this lesson.";
                }
                return;
            }

            let score = 0;
            let attempted = 0;

            quiz.forEach((q, i) => {
                const chosen = document.querySelector(`input[name="q${i}"]:checked`);
                const expBox = document.getElementById(`exp-${i}`);
                const questionDiv = document.getElementById(`quiz-${i}`);
                if (questionDiv) {
                    questionDiv.classList.remove("correct", "wrong");
                }

                if (chosen) attempted++;

                const explanation = q.explanation || "";

                if (chosen && parseInt(chosen.value, 10) === q.correct) {
                    score++;
                    if (expBox) {
                        expBox.innerHTML = `<span class='correct'>Correct!</span>${explanation ? "<br>" + explanation : ""}`;
                        expBox.style.display = "block";
                    }
                    if (questionDiv) questionDiv.classList.add("correct");
                } else {
                    if (expBox) {
                        expBox.innerHTML = `
                        <span class='wrong'>Incorrect</span><br>
                        Correct answer: <b>${q.options[q.correct]}</b>${explanation ? "<br>" + explanation : ""}
                    `;
                        expBox.style.display = "block";
                    }
                    if (questionDiv) questionDiv.classList.add("wrong");
                }
            });

            if (resultEl) {
                resultEl.innerText =
                    `Score: ${score}/${quiz.length} ¬∑ Attempted: ${attempted}/${quiz.length}`;
            }
        }

        /* ------------------ Slides ------------------ */
        let currentSlide = 0;

        
        function setupSlides() {
    document.getElementById("slidesSection").style.display = "block";

    prevSlideBtn.addEventListener("click", (e) => {
        e.preventDefault();  // stop form-submit reload
        e.stopPropagation();
        changeSlide(-1);
    });

    nextSlideBtn.addEventListener("click", (e) => {
        e.preventDefault();  // stop form-submit reload
        e.stopPropagation();
        changeSlide(+1);
    });

    renderSlide();
}




        function changeSlide(n) {
            const total = lessonData.slidesSVG.length;
            currentSlide = (currentSlide + n + total) % total;
            renderSlide();
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function renderSlide() {
            const svg = lessonData.slidesSVG[currentSlide];
            const codes = lessonData.slideCodes?.[currentSlide] || [];

            const slideHTML = `
                <div class='slide-svg-wrapper'>${svg}</div>
                <div class='slide-code-box'>
                    ${codes.map(code => `<pre>${code}</pre>`).join("")}
                </div>
            `;

            document.getElementById("slideViewer").innerHTML = slideHTML;
            document.getElementById("slideCounter").innerText =
                `${currentSlide + 1} / ${lessonData.slidesSVG.length}`;

            addCopyButtons();
        }

        /* ------------------ Copy Buttons ------------------ */
        function addCopyButtons() {
            document.querySelectorAll("pre").forEach(pre => {
                if (pre.querySelector(".copy-btn")) return;

                const btn = document.createElement("button");
                btn.className = "copy-btn";
                btn.innerText = "Copy";
                btn.onclick = () => navigator.clipboard.writeText(pre.innerText);

                pre.appendChild(btn);
            });
        }

        /* ------------------ Run Code ------------------ */
        runBtn.onclick = async () => {
            output.innerText = "";
            if (!pyodideReady) {
                output.innerText = "Loading Pyodide... please wait.";
                return;
            }
            try {
                await pyodide.runPythonAsync(editor.innerText);
            } catch (err) {
                output.innerText = "Error: " + err;
            }
        };

        /* ------------------ Test Code ------------------ */
        testBtn.onclick = async () => {
            if (!lessonData || !lessonData.codingChallenge) {
                testMsg.innerText = "No coding challenge for this lesson.";
                return;
            }
            if (!pyodideReady) {
                testMsg.innerText = "Pyodide is still loading. Try again in a few seconds.";
                return;
            }
            try {
                const userOut = await pyodide.runPythonAsync(editor.innerText);
                const expected = await pyodide.runPythonAsync(
                    lessonData.codingChallenge.solution
                );
                testMsg.innerText =
                    String(userOut).trim() === String(expected).trim()
                        ? "Correct! ‚úî"
                        : "Incorrect ‚ùå";
            } catch (err) {
                testMsg.innerText = "Error: " + err;
            }
        };

        /* ------------------ Share Code ------------------ */
        shareBtn.onclick = () => {
            const code = encodeURIComponent(editor.innerText);
            const link = `${window.location.pathname}?json=${lessonURL}&code=${code}`;
            navigator.clipboard.writeText(link);
            alert("Share link copied!");
        };

        const shared = url.searchParams.get("code");
        if (shared) editor.innerText = decodeURIComponent(shared);

        /* ------------------ Lesson Navigation ------------------ */
        function goToLesson(id) {
            if (!lessonURL) return;
            const newJson = lessonURL.replace(/lesson-\d+\.json/, `lesson-${id}.json`);
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set("json", newJson);
            newUrl.searchParams.delete("code");
            window.location.href = newUrl.toString();
        }

        window.goToLesson = goToLesson;
    </script>

</body>

</html>