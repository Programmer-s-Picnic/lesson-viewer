<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Programmer's Picnic ‚Äì Excel Lesson Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, sans-serif;
      background: #fff7e6;
      color: #3a2a1a;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      background: #fffaf0;
      border-radius: 16px;
      border: 1px solid #f3c26b;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      margin-top: 10px;
      margin-bottom: 20px;
    }
    h1, h2, h3 {
      color: #b35a00;
    }
    .section-box {
      margin-top: 12px;
      padding: 12px;
      background: #fff3d1;
      border-radius: 10px;
      border: 1px solid #f1b14b;
    }
    .meta-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .meta-chip {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.8rem;
      background: #ffe7b3;
      border: 1px solid #f1b14b;
    }
    .xp-chip {
      background: #dcfce7;
      border-color: #16a34a;
      color: #166534;
      font-weight: 600;
    }
    .badge-chip {
      background: #fee2e2;
      border-color: #ef4444;
      color: #b91c1c;
      font-weight: 600;
    }
    pre {
      background: #fff1c9;
      border-radius: 10px;
      border: 1px dashed #e0a850;
      padding: 10px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      position: relative;
    }
    .copy-btn {
      position: absolute;
      right: 6px;
      top: 6px;
      padding: 3px 7px;
      font-size: 0.7rem;
      border-radius: 6px;
      border: 1px solid #bb7a00;
      background: #ffd27f;
      cursor: pointer;
    }
    .quiz-item {
      background: #fff8dd;
      border-radius: 8px;
      border: 1px solid #f3c26b;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    details {
      margin-top: 4px;
    }
    details summary {
      cursor: pointer;
    }
    .nav-lessons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 16px;
    }
    .btn-nav {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #b57400;
      background: #ffcc73;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-nav[disabled] {
      opacity: 0.5;
      cursor: default;
      background: #ffeac0;
    }
    a {
      color: #a14c00;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">Loading Excel lesson‚Ä¶</h1>
    <div id="meta"></div>
    <div id="content"></div>
    <div id="nav"></div>
  </div>

  <script>
    const url = new URL(window.location.href);
    const lessonURL = url.searchParams.get("json");
    let lessonData = null;

    function metaHTML(lesson) {
      const chips = [];
      if (lesson.duration) chips.push(`<span class="meta-chip">‚è± ${lesson.duration}</span>`);
      if (lesson.difficulty) chips.push(`<span class="meta-chip">üéØ ${lesson.difficulty}</span>`);
      if (lesson.category) chips.push(`<span class="meta-chip">üìÇ ${lesson.category}</span>`);
      if (lesson.rewardXP) chips.push(`<span class="meta-chip xp-chip">‚≠ê ${lesson.rewardXP} XP</span>`);
      if (lesson.badge) chips.push(`<span class="meta-chip badge-chip">üèÖ ${lesson.badge}</span>`);
      let keywords = "";
      if (Array.isArray(lesson.keywords) && lesson.keywords.length) {
        keywords = `<div style="margin-top:6px;">${lesson.keywords.map(k => `<span class="meta-chip">#${k}</span>`).join("")}</div>`;
      }
      if (!chips.length && !keywords) return "";
      return `<div class="section-box"><div class="meta-chips">${chips.join("")}</div>${keywords}</div>`;
    }

    function downloadsHTML(downloads) {
      if (!Array.isArray(downloads) || !downloads.length) return "";
      return `
        <div class="section-box">
          <h3>Downloads & Classroom Files</h3>
          <ul>
            ${downloads.map(d => `
              <li style="margin-bottom:6px;">
                <strong>${d.title}</strong><br>
                <span style="font-size:0.9rem;">${d.description || ""}</span><br>
                ${d.classroomLink ? `<a href="${d.classroomLink}" target="_blank">üì• Open in Google Classroom</a><br>` : ""}
                ${d.classroomCode ? `<span style="font-size:0.8rem;opacity:0.8;">Classroom code: <code>${d.classroomCode}</code></span>` : ""}
              </li>
            `).join("")}
          </ul>
        </div>
      `;
    }

    function jobAssignmentsHTML(assignments) {
      if (!Array.isArray(assignments) || !assignments.length) return "";
      return `
        <div class="section-box">
          <h3>Job-Style Assignments</h3>
          ${assignments.map(a => `
            <div class="quiz-item">
              <strong>${a.title}</strong>
              ${a.level ? `<span class="meta-chip" style="margin-left:6px;">Level: ${a.level}</span>` : ""}
              ${a.estimatedTime ? `<span class="meta-chip" style="margin-left:6px;">‚è± ${a.estimatedTime}</span>` : ""}
              <p style="margin-top:6px;">${a.brief || ""}</p>
              ${Array.isArray(a.tasks) ? `<ul>${a.tasks.map(t => `<li>${t}</li>`).join("")}</ul>` : ""}
              ${a.hints && a.hints.length ? `
                <details>
                  <summary>Show hint(s)</summary>
                  <ul>${a.hints.map(h => `<li>${h}</li>`).join("")}</ul>
                </details>` : ""}
              ${a.hiddenSolution ? `
                <details>
                  <summary>Show solution (after trying!)</summary>
                  <p style="margin-top:4px;">${a.hiddenSolution}</p>
                </details>` : ""}
            </div>
          `).join("")}
        </div>
      `;
    }

    function interviewHTML(qa) {
      if (!Array.isArray(qa) || !qa.length) return "";
      return `
        <div class="section-box">
          <h3>Interview Practice</h3>
          ${qa.map((q, i) => `
            <div class="quiz-item">
              <strong>Q${i+1}. ${q.question}</strong>
              ${q.hint ? `<p style="font-size:0.85rem;opacity:0.85;">Hint: ${q.hint}</p>` : ""}
              <details>
                <summary>Show answer</summary>
                <p style="margin-top:4px;">${q.answer}</p>
              </details>
            </div>
          `).join("")}
        </div>
      `;
    }

    function jobLinksHTML(links) {
      if (!Array.isArray(links) || !links.length) return "";
      return `
        <div class="section-box">
          <h3>Job & Internship Links</h3>
          <ul>
            ${links.map(j => `
              <li style="margin-bottom:6px;">
                ${j.url ? `<a href="${j.url}" target="_blank">${j.label || j.url}</a>` : `<span>${j.label || "Job link (coming soon)"}</span>`}
                ${j.notes ? `<br><span style="font-size:0.8rem;opacity:0.8;">${j.notes}</span>` : ""}
              </li>
            `).join("")}
          </ul>
        </div>
      `;
    }

    function quizHTML(quiz) {
      if (!Array.isArray(quiz) || !quiz.length) return "";
      return `
        <div class="section-box">
          <h3>Quick Quiz</h3>
          ${quiz.map(q => `
            <div class="quiz-item">
              <strong>${q.question}</strong>
              <ul>
                ${q.options.map((op, idx) => `<li>${String.fromCharCode(65+idx)}. ${op}</li>`).join("")}
              </ul>
              <details>
                <summary>Show correct answer</summary>
                <p>Correct: <strong>${q.options[q.correct]}</strong><br>${q.explanation || ""}</p>
              </details>
            </div>
          `).join("")}
        </div>
      `;
    }

    function navHTML(lesson) {
      const id = lesson.id;
      if (!id) return "";
      const prev = id > 1 && id <= 15 ? id - 1 : null;
      const next = id < 15 ? id + 1 : null;
      function linkFor(i) {
        if (!i) return "#";
        const jsonURL = "./json/excel-lesson-" + i + ".json";
        return "excel-viewer.html?json=" + encodeURIComponent(jsonURL);
      }
      return `
        <div class="nav-lessons">
          <button class="btn-nav" ${prev ? `onclick="location.href='${linkFor(prev)}'"` : "disabled"}>
            ‚¨Ö ${prev ? "Lesson " + prev : "First lesson"}
          </button>
          <button class="btn-nav" ${next ? `onclick="location.href='${linkFor(next)}'"` : "disabled"}>
            ${next ? "Lesson " + next + " ‚û°" : "No next lesson"}
          </button>
        </div>
      `;
    }

    function addCopyButtons() {
      document.querySelectorAll("pre").forEach(pre => {
        if (pre.querySelector(".copy-btn")) return;
        const btn = document.createElement("button");
        btn.textContent = "Copy";
        btn.className = "copy-btn";
        btn.addEventListener("click", () => {
          navigator.clipboard.writeText(pre.innerText);
        });
        pre.appendChild(btn);
      });
    }

    function renderLesson(lesson) {
      lessonData = lesson;
      document.getElementById("title").textContent = lesson.title || "Excel Lesson";
      document.getElementById("meta").innerHTML = metaHTML(lesson);
      const content = document.getElementById("content");
      const blog = lesson.blogArticle || "";
      const practice = Array.isArray(lesson.practiceProblems) ? lesson.practiceProblems : [];
      const homework = Array.isArray(lesson.homework) ? lesson.homework : [];

      content.innerHTML = `
        ${downloadsHTML(lesson.downloads)}
        <div class="section-box">
          <h3>Lesson Notes</h3>
          <pre>${blog}</pre>
        </div>
        ${practice.length ? `
          <div class="section-box">
            <h3>Practice Tasks</h3>
            <ul>${practice.map(p => `<li>${p}</li>`).join("")}</ul>
          </div>` : ""}
        ${homework.length ? `
          <div class="section-box">
            <h3>Homework</h3>
            <ul>${homework.map(h => `<li>${h}</li>`).join("")}</ul>
          </div>` : ""}
        ${jobAssignmentsHTML(lesson.jobAssignments)}
        ${quizHTML(lesson.quiz)}
        ${interviewHTML(lesson.interviewQA)}
        ${jobLinksHTML(lesson.jobLinks)}
      `;
      document.getElementById("nav").innerHTML = navHTML(lesson);
      addCopyButtons();
    }

    if (lessonURL) {
      fetch(lessonURL)
        .then(r => r.json())
        .then(data => {
          renderLesson(data);
        })
        .catch(err => {
          document.getElementById("content").innerHTML = "<p>Failed to load lesson JSON.</p><pre>" + err + "</pre>";
        });
    } else {
      document.getElementById("content").innerHTML = "<p>No JSON URL provided.</p>";
    }
  </script>
</body>
</html>
