<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#d97706" />
  <title>Programmerâ€™s Picnic â€” HTML + JS Runner + JSON UI (Merged)</title>

  <!-- CodeMirror (CDN) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css"/>

  <style>
    :root{
      --bg0:#fff7e6; --bg1:#fff1d6;
      --card:rgba(255,255,255,.9);
      --ink:#1f2937; --muted:#6b7280;
      --brand:#d97706; --brand2:#f59e0b;
      --border:rgba(31,41,55,.12);
      --shadow:0 14px 40px rgba(17,24,39,.10);
      --ring:0 0 0 4px rgba(217,119,6,.18);
      --r2:18px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --danger:#9a3412; --ok:#065f46;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background:
        radial-gradient(1100px 520px at 12% 0%, rgba(245,158,11,.22), transparent 60%),
        radial-gradient(900px 420px at 92% 18%, rgba(217,119,6,.18), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    .wrap{max-width:1600px;margin:0 auto;padding:14px 14px 60px}
    .card{
      border:1px solid var(--border); border-radius:24px; background:var(--card);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .hd{
      padding:14px 16px 10px;
      border-bottom:1px solid rgba(31,41,55,.10);
      background:
        radial-gradient(900px 360px at 10% 0%, rgba(245,158,11,.18), transparent 55%),
        radial-gradient(800px 320px at 92% 10%, rgba(217,119,6,.14), transparent 55%);
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    h1{margin:0 0 6px;font-size:clamp(20px,2.6vw,34px);letter-spacing:-.4px}
    .sub{margin:0;color:var(--muted);font-weight:750}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(217,119,6,.25);
      background:rgba(255,255,255,.70);
      font-weight:900;color:#92400e;
      user-select:none; white-space:nowrap;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .btn{
      border:1px solid var(--border);
      background:white;
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(17,24,39,.06);
      cursor:pointer;
      font-weight:900;
    }
    .btn.primary{
      border-color:rgba(217,119,6,.35);
      background:linear-gradient(135deg, rgba(217,119,6,.12), rgba(245,158,11,.16));
    }
    .btn.danger{
      border-color:rgba(185,28,28,.20);
      background:linear-gradient(135deg, rgba(185,28,28,.06), rgba(245,158,11,.08));
      color:var(--danger);
    }
    .btn.tiny{
      padding:7px 10px;
      border-radius:12px;
      font-size:12px;
      box-shadow:0 6px 14px rgba(17,24,39,.05);
    }
    .btn:focus-visible{outline:none;box-shadow:var(--shadow),var(--ring)}
    select, input[type="number"]{
      border:1px solid rgba(31,41,55,.14);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.75);
      font-family:var(--sans);
      font-weight:800;
    }
    input[type="checkbox"]{transform:translateY(1px)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:12px;
      padding:14px;
    }
    @media (max-width: 1400px){
      .grid{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid rgba(31,41,55,.12);
      border-radius:18px;
      background:rgba(255,255,255,.78);
      overflow:hidden;
      min-height:600px;
      display:flex;
      flex-direction:column;
    }
    .ph{
      padding:10px 12px;
      border-bottom:1px solid rgba(31,41,55,.10);
      background:#fffaf0;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .ph strong{color:var(--brand); font-size:13px; letter-spacing:.2px}
    .hint{color:var(--muted); font-size:12px; font-weight:700}
    .ph-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .cm-wrap{flex:1; display:flex}
    .CodeMirror{
      height:100%;
      width:100%;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.45;
      background:#fff;
    }
    .CodeMirror-gutters{
      background:#fffaf0;
      border-right:1px solid rgba(31,41,55,.10);
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
      background:#fff;
      flex:1;
    }
    .out{
      border-top:1px solid rgba(31,41,55,.10);
      background:rgba(255,255,255,.80);
      padding:10px 12px;
      font-family:var(--mono);
      font-size:12.5px;
      white-space:pre-wrap;
      overflow:auto;
      max-height:240px;
    }
    .ok{color:var(--ok); font-weight:800}
    .bad{color:var(--danger); font-weight:800}
    .mini{color:var(--muted); font-weight:750; font-size:12px}
    textarea.stdin{
      width:100%;
      border:1px solid rgba(31,41,55,.14);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(255,255,255,.75);
      font-family:var(--mono);
      font-weight:800;
      line-height:1.35;
      resize:vertical;
      min-height:90px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grow{flex:1; min-width:220px}
    .note{
      padding:10px 12px;
      border-top:1px solid rgba(31,41,55,.10);
      background:#fffaf0;
      color:var(--muted);
      font-size:12px;
      font-weight:750;
      line-height:1.35;
    }
    .note code{
      font-family:var(--mono);
      background:#fff7ea;
      border:1px solid rgba(217,119,6,.18);
      padding:1px 6px;
      border-radius:8px;
      color:#111827;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="card">
      <div class="hd">
        <div>
          <div class="pill">ðŸŸ  Programmerâ€™s Picnic</div>
          <h1>Merged Editor: HTML Preview + JS Runner + JSON UI Builder</h1>
          <p class="sub">HTML/CSS preview + safe JS sandbox + JSON â†’ UI (createElement) rendering inside preview.</p>
        </div>

        <div class="actions">
          <span class="pill">Timeout: <span id="tLabel">2000</span> ms</span>

          <label class="pill" title="Auto-update iframe while typing (debounced)">
            <input type="checkbox" id="autoPreview" checked />
            Auto Preview
          </label>

          <label class="pill" title="Inject JS editor into preview (DOM lessons). Not sandboxed.">
            <input type="checkbox" id="injectJs" />
            Inject JS into Preview
          </label>

          <label class="pill" title="Render JSON into preview as UI elements">
            <input type="checkbox" id="renderJson" checked />
            Render JSON UI
          </label>

          <button class="btn" id="btnClearConsole">Clear Console</button>
          <button class="btn" id="btnSave">Save</button>
          <button class="btn" id="btnLoad">Load</button>
          <button class="btn" id="btnShare">Share</button>
          <button class="btn danger" id="btnReset">Reset</button>

          <button class="btn primary" id="btnRunJson">â–¶ Render JSON</button>
          <button class="btn primary" id="btnRunJs">â–¶ Run JS (Sandbox)</button>
          <button class="btn primary" id="btnRunAll">â–¶ Run Preview</button>

          <span class="pill mini" id="status">Ready</span>
        </div>
      </div>

      <div class="grid">
        <!-- HTML/CSS -->
        <section class="panel" aria-label="HTML editor">
          <div class="ph">
            <strong>HTML / CSS Editor</strong>
            <div class="ph-actions">
              <button class="btn tiny danger" id="btnClearHtml" title="Clear HTML editor">Clear</button>
              <span class="hint">Ctrl/âŒ˜ + Enter = Run Preview</span>
            </div>
          </div>
          <div class="cm-wrap"><textarea id="htmlEditor"></textarea></div>
        </section>

        <!-- JS -->
        <section class="panel" aria-label="JS editor">
          <div class="ph">
            <strong>JavaScript Editor</strong>
            <div class="ph-actions">
              <button class="btn tiny danger" id="btnClearJs" title="Clear JS editor">Clear</button>
              <span class="hint">Ctrl/âŒ˜ + Enter = Run JS Sandbox</span>
            </div>
          </div>
          <div class="cm-wrap"><textarea id="jsEditor"></textarea></div>

          <div style="padding:10px 12px;border-top:1px solid rgba(31,41,55,.10);background:#fffaf0">
            <div class="row">
              <div class="grow">
                <div class="mini">stdin (each line = one input())</div>
                <textarea class="stdin" id="stdin" placeholder="Example:
Champak
25"></textarea>
              </div>
              <div style="min-width:160px">
                <div class="mini">Timeout (ms)</div>
                <input id="timeoutMs" type="number" min="50" step="50" value="2000" />
              </div>
            </div>
          </div>
        </section>

        <!-- JSON -->
        <section class="panel" aria-label="JSON editor">
          <div class="ph">
            <strong>JSON Editor (UI Schema)</strong>
            <div class="ph-actions">
              <button class="btn tiny danger" id="btnClearJson" title="Clear JSON editor">Clear</button>
              <span class="hint">Ctrl/âŒ˜ + Enter = Render JSON</span>
            </div>
          </div>
          <div class="cm-wrap"><textarea id="jsonEditor"></textarea></div>

          <div class="note">
            JSON format:
            <code>{ "mountId":"pp_json_root", "nodes":[ ... ] }</code><br/>
            Each node:
            <code>{ "tag":"div", "text":"Hello", "attrs":{...}, "style":{...}, "children":[...] }</code>
          </div>
        </section>

        <!-- Preview + Console -->
        <section class="panel" aria-label="Preview panel">
          <div class="ph">
            <strong>Preview (iframe)</strong>
            <span class="hint">srcdoc + sandbox</span>
          </div>

          <iframe
            id="preview"
            sandbox="allow-forms allow-modals allow-pointer-lock allow-presentation allow-scripts allow-popups"
          ></iframe>

          <div class="out" id="consoleOut"></div>
        </section>
      </div>
    </section>
  </main>

  <!-- CodeMirror JS (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

  <script>
    /* ==========================
       PP Mini Runner (Worker Sandbox)
       ========================== */
    (function () {
      "use strict";

      function nowMs() {
        return typeof performance !== "undefined" && performance.now ? performance.now() : Date.now();
      }
      function splitLines(s) {
        if (!s) return [];
        return String(s).replace(/\r\n/g, "\n").split("\n");
      }
      function createWorkerURL() {
        var workerCode =
          '"use strict";\n' +
          "function send(type, payload){ postMessage(Object.assign({type:type}, payload||{})); }\n" +
          "function safeStringify(v){\n" +
          "  try {\n" +
          "    if (typeof v === 'string') return v;\n" +
          "    if (v && v.name && v.message && (v.stack || (v.constructor && v.constructor.name==='Error'))){\n" +
          "      return v.stack || (v.name + ': ' + v.message);\n" +
          "    }\n" +
          "    var seen=[];\n" +
          "    return JSON.stringify(v, function(k,val){\n" +
          "      if (typeof val === 'function') return '[Function]';\n" +
          "      if (val && typeof val === 'object'){\n" +
          "        if (seen.indexOf(val)>=0) return '[Circular]';\n" +
          "        seen.push(val);\n" +
          "      }\n" +
          "      return val;\n" +
          "    });\n" +
          "  } catch(e){\n" +
          "    try { return String(v); } catch(_) { return '[Unserializable]'; }\n" +
          "  }\n" +
          "}\n" +
          "function makeConsole(warnToStderr){\n" +
          "  function mk(level){\n" +
          "    return function(){\n" +
          "      var args = Array.prototype.slice.call(arguments);\n" +
          "      var safe = args.map(function(a){ return safeStringify(a); });\n" +
          "      send('log',{level:level,args:safe});\n" +
          "    };\n" +
          "  }\n" +
          "  return { log:mk('log'), info:mk('info'), warn:mk(warnToStderr?'error':'warn'), error:mk('error') };\n" +
          "}\n" +
          "onmessage = function(ev){\n" +
          "  var msg = ev.data || {};\n" +
          "  if(msg.type !== 'run') return;\n" +
          "  var code = String(msg.code || '');\n" +
          "  var stdinLines = Array.isArray(msg.stdinLines) ? msg.stdinLines : [];\n" +
          "  var stdinIndex = 0;\n" +
          "  var warnToStderr = !!msg.warnToStderr;\n" +
          "  var consoleProxy = makeConsole(warnToStderr);\n" +
          "  function input(promptText){\n" +
          "    if (promptText != null && String(promptText).length) send('log',{level:'log',args:[String(promptText)]});\n" +
          "    var v = (stdinIndex < stdinLines.length) ? String(stdinLines[stdinIndex]) : '';\n" +
          "    stdinIndex++;\n" +
          "    return v;\n" +
          "  }\n" +
          "  try {\n" +
          "    var wrapped = 'return (async function(console,input){\\n\"use strict\";\\n' + code + '\\n});';\n" +
          "    var factory = new Function(wrapped);\n" +
          "    var fn = factory();\n" +
          "    Promise.resolve(fn(consoleProxy, input)).then(function(){ send('done',{ok:true}); })\n" +
          "    .catch(function(err){ var t=(err&&(err.stack||err.message))?(err.stack||err.message):String(err); send('done',{ok:false,error:t}); });\n" +
          "  } catch(err){\n" +
          "    var text=(err&&(err.stack||err.message))?(err.stack||err.message):String(err);\n" +
          "    send('done',{ok:false,error:text});\n" +
          "  }\n" +
          "};";

        var blob = new Blob([workerCode], { type: "application/javascript" });
        return URL.createObjectURL(blob);
      }

      function runUserCode(options) {
        options = options || {};
        var start = nowMs();
        var workerURL = createWorkerURL();
        var worker = new Worker(workerURL);

        var timeoutMs = Number(options.timeoutMs || 2000);
        var onStdout = options.onStdout || function () {};
        var onStderr = options.onStderr || function () {};
        var warnToStderr = options.warnToStderr !== false;

        var finished = false;
        function finish(payload) {
          if (finished) return;
          finished = true;
          try { worker.terminate(); } catch (_) {}
          try { URL.revokeObjectURL(workerURL); } catch (_) {}
          payload.ms = Math.max(0, nowMs() - start);
          return payload;
        }

        return new Promise(function (resolve) {
          var timer = setTimeout(function () {
            resolve(finish({ ok: false, timeout: true, error: "Timeout exceeded" }));
          }, Math.max(50, timeoutMs));

          worker.onmessage = function (ev) {
            var msg = ev.data || {};
            if (msg.type === "log") {
              var line = (msg.args || []).join(" ");
              if (msg.level === "error") onStderr(line);
              else onStdout(line);
              return;
            }
            if (msg.type === "done") {
              clearTimeout(timer);
              if (msg && msg.ok) resolve(finish({ ok: true }));
              else resolve(finish({ ok: false, timeout: false, error: msg.error || "Error" }));
            }
          };

          worker.onerror = function (err) {
            clearTimeout(timer);
            var message = (err && err.message) ? err.message : "Worker error";
            resolve(finish({ ok: false, timeout: false, error: message }));
          };

          worker.postMessage({
            type: "run",
            code: options.code || "",
            stdinLines: splitLines(options.stdin || ""),
            warnToStderr: warnToStderr
          });
        });
      }

      window.PP_MINI_RUNNER = { runUserCode: runUserCode };
    })();

    /* ==========================
       Merged App Logic
       ========================== */
    const STORAGE_KEY = "pp_merged_html_js_json_editor_v1";
    const $ = (id) => document.getElementById(id);

    const status = $("status");
    const consoleOut = $("consoleOut");
    const preview = $("preview");
    const autoPreview = $("autoPreview");
    const injectJs = $("injectJs");
    const renderJson = $("renderJson");
    const timeoutMsEl = $("timeoutMs");

    function setStatus(text, kind){
      status.textContent = text;
      status.classList.remove("ok","bad");
      if (kind === "ok") status.classList.add("ok");
      if (kind === "bad") status.classList.add("bad");
    }

    function appendConsole(line, cls){
      const div = document.createElement("div");
      if (cls) div.className = cls;
      div.textContent = line;
      consoleOut.appendChild(div);
      consoleOut.scrollTop = consoleOut.scrollHeight;
    }
    function clearConsole(){
      consoleOut.innerHTML = "";
    }

    function debounce(fn, ms){
      let t=null;
      return (...args)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...args), ms);
      };
    }

    // Starters
    const starterHTML = `<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My UI</title>
  <style>
    :root{ --brand:#d97706; }
    body{font-family:system-ui;margin:0;padding:24px;background:#fff}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:16px;max-width:980px}
    h1{margin:0 0 8px;color:var(--brand)}
    button{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer}
    .muted{color:#6b7280}
    #pp_json_root{margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Preview + JSON UI</h1>
    <p class="muted">JSON UI will mount into <code>#pp_json_root</code> (below).</p>

    <div id="pp_json_root"></div>
  </div>
</body>
</html>`;

    const starterJS = `// JS Sandbox demo (safe worker: console + input + timeout)
console.log("Hello from JS sandbox!");

const name = input("Enter your name:");
const age = input("Enter your age:");
console.log("Hi", name, "- age", age);

// Try timeout:
// while(true){};`;

    const starterJSON = `{
  "mountId": "pp_json_root",
  "nodes": [
    {
      "tag": "div",
      "attrs": { "class": "card" },
      "style": {
        "border": "1px solid #e5e7eb",
        "borderRadius": "14px",
        "padding": "14px",
        "background": "#fffaf0"
      },
      "children": [
        { "tag": "h2", "text": "Hello from JSON UI", "style": { "margin": "0 0 6px", "color": "#d97706" } },
        { "tag": "p", "text": "This UI was created using createElement() from JSON.", "style": { "margin": "0 0 10px", "color": "#6b7280" } },
        {
          "tag": "button",
          "text": "Click me",
          "attrs": { "id": "jsonBtn" },
          "style": { "padding": "10px 12px", "borderRadius": "12px", "border": "1px solid #e5e7eb", "background": "#fff", "cursor": "pointer" }
        },
        { "tag": "div", "attrs": { "id": "jsonOut" }, "style": { "marginTop": "10px", "color": "#111827", "fontWeight": "700" } }
      ]
    }
  ]
}`;

    // Initialize CodeMirror editors
    const htmlCM = CodeMirror.fromTextArea($("htmlEditor"), {
      mode:"htmlmixed", theme:"eclipse",
      lineNumbers:true, lineWrapping:true,
      tabSize:2, indentUnit:2, indentWithTabs:false
    });

    const jsCM = CodeMirror.fromTextArea($("jsEditor"), {
      mode:"javascript", theme:"eclipse",
      lineNumbers:true, lineWrapping:true,
      tabSize:2, indentUnit:2, indentWithTabs:false
    });

    // JSON mode: CodeMirror JS mode supports JSON via option
    const jsonCM = CodeMirror.fromTextArea($("jsonEditor"), {
      mode:{ name:"javascript", json:true },
      theme:"eclipse",
      lineNumbers:true, lineWrapping:true,
      tabSize:2, indentUnit:2, indentWithTabs:false
    });

    // Clear buttons
    $("btnClearHtml").addEventListener("click", () => {
      htmlCM.setValue("");
      setStatus("HTML cleared.", "ok");
      if (autoPreview.checked) runPreview();
    });
    $("btnClearJs").addEventListener("click", () => {
      jsCM.setValue("");
      setStatus("JS cleared.", "ok");
    });
    $("btnClearJson").addEventListener("click", () => {
      jsonCM.setValue("");
      setStatus("JSON cleared.", "ok");
      if (autoPreview.checked) runPreview();
    });

    // Share encode/decode for HTML+JS+JSON+stdin+toggles
    function b64EncodeUnicode(str){
      const utf8 = new TextEncoder().encode(str);
      let bin=""; utf8.forEach(b=>bin+=String.fromCharCode(b));
      return btoa(bin);
    }
    function b64DecodeUnicode(b64){
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
      return new TextDecoder().decode(bytes);
    }
    function packState(){
      const state = {
        html: htmlCM.getValue(),
        js: jsCM.getValue(),
        json: jsonCM.getValue(),
        stdin: $("stdin").value,
        timeout: Number(timeoutMsEl.value || 2000),
        autoPreview: !!autoPreview.checked,
        injectJs: !!injectJs.checked,
        renderJson: !!renderJson.checked
      };
      return encodeURIComponent(b64EncodeUnicode(JSON.stringify(state)));
    }
    function unpackState(packed){
      const json = b64DecodeUnicode(decodeURIComponent(packed));
      return JSON.parse(json);
    }

    // JSON -> DOM builder injected into preview
    function jsonBuilderScript(jsonText){
      // jsonText is embedded as string; parse inside iframe
      return `
<script>
(function(){
  function isObj(x){ return x && typeof x === "object" && !Array.isArray(x); }
  function applyStyles(el, styleObj){
    if(!isObj(styleObj)) return;
    for (var k in styleObj){
      try { el.style[k] = String(styleObj[k]); } catch(_) {}
    }
  }
  function applyAttrs(el, attrs){
    if(!isObj(attrs)) return;
    for (var k in attrs){
      try{
        if(k === "class") el.className = String(attrs[k]);
        else if(k === "text") el.textContent = String(attrs[k]);
        else el.setAttribute(k, String(attrs[k]));
      }catch(_){}
    }
  }
  function makeNode(doc, node){
    if(typeof node === "string") return doc.createTextNode(node);
    if(!node || typeof node !== "object") return doc.createTextNode("");
    var tag = String(node.tag || "div");
    var el = doc.createElement(tag);
    if(node.text != null) el.textContent = String(node.text);
    applyAttrs(el, node.attrs);
    applyStyles(el, node.style);
    var kids = Array.isArray(node.children) ? node.children : [];
    for (var i=0;i<kids.length;i++){
      el.appendChild(makeNode(doc, kids[i]));
    }
    return el;
  }

  function mount(schema){
    var doc = document;
    var mountId = (schema && schema.mountId) ? String(schema.mountId) : "pp_json_root";
    var root = doc.getElementById(mountId);
    if(!root){
      root = doc.createElement("div");
      root.id = mountId;
      doc.body.appendChild(root);
    }
    // clear mount
    while(root.firstChild) root.removeChild(root.firstChild);

    var nodes = (schema && Array.isArray(schema.nodes)) ? schema.nodes : [];
    for (var i=0;i<nodes.length;i++){
      root.appendChild(makeNode(doc, nodes[i]));
    }

    // optional: tiny demo hook if present
    var btn = doc.getElementById("jsonBtn");
    if(btn){
      btn.addEventListener("click", function(){
        var out = doc.getElementById("jsonOut");
        if(out) out.textContent = "Clicked at " + new Date().toLocaleTimeString();
      });
    }
  }

  try{
    var schema = JSON.parse(${JSON.stringify(jsonText)});
    mount(schema);
  }catch(e){
    try{
      var root = document.getElementById("pp_json_root");
      if(!root){ root = document.createElement("pre"); document.body.appendChild(root); }
      root.textContent = "JSON parse error: " + (e && (e.message||e) ? (e.message||e) : "Invalid JSON");
      root.style.color = "#b91c1c";
      root.style.whiteSpace = "pre-wrap";
    }catch(_){}
    try{ parent.postMessage({type:"pp_preview_error", message:"JSON parse error"}, "*"); }catch(_){}
  }
})();
<\/script>
`;
    }

    function safePreviewHTML(html, jsInject, jsonText, doJson){
      const shim = `
<script>
(function(){
  window.addEventListener("error", function(ev){
    try{ parent.postMessage({type:"pp_preview_error", message:String(ev.message||"Error")}, "*"); }catch(_){}
  });
  window.addEventListener("unhandledrejection", function(ev){
    try{ parent.postMessage({type:"pp_preview_error", message:String((ev.reason&&ev.reason.message)||ev.reason||"Promise rejection")}, "*"); }catch(_){}
  });
})();
<\/script>
`;
      let out = String(html || "");
      if (/<\/head\s*>/i.test(out)) out = out.replace(/<\/head\s*>/i, shim + "\n</head>");
      else out = shim + "\n" + out;

      // JSON UI render (before optional injected JS so injected JS can interact with JSON DOM)
      if (doJson) {
        const jsonScript = jsonBuilderScript(jsonText || "");
        if (/<\/body\s*>/i.test(out)) out = out.replace(/<\/body\s*>/i, "\n" + jsonScript + "\n</body>");
        else out += "\n" + jsonScript + "\n";
      }

      // Optional JS injection into preview (unsafe but useful for DOM lessons)
      if (jsInject && jsInject.trim()) {
        const scriptTag = `\n<script>\n${jsInject}\n<\/script>\n`;
        if (/<\/body\s*>/i.test(out)) out = out.replace(/<\/body\s*>/i, scriptTag + "</body>");
        else out += scriptTag;
      }

      return out;
    }

    function runPreview(){
      const html = htmlCM.getValue();
      const js = injectJs.checked ? jsCM.getValue() : "";
      const json = jsonCM.getValue();
      const doJson = !!renderJson.checked;

      preview.srcdoc = safePreviewHTML(html, js, json, doJson);
      setStatus("Preview updated âœ…", "ok");
    }

    function runJsonOnly(){
      // Render preview but with the same current HTML and JS toggle state,
      // ensures JSON changes reflect immediately even if autoPreview is off.
      runPreview();
      setStatus("JSON rendered âœ…", "ok");
    }

    async function runJsSandbox(){
      clearConsole();
      setStatus("Running JS sandboxâ€¦", "");
      const t = Number(timeoutMsEl.value || 2000);
      $("tLabel").textContent = String(t);

      const result = await window.PP_MINI_RUNNER.runUserCode({
        code: jsCM.getValue(),
        stdin: $("stdin").value,
        timeoutMs: t,
        warnToStderr: true,
        onStdout: (s)=>appendConsole(s),
        onStderr: (s)=>appendConsole(s, "bad"),
      });

      if (result.ok){
        setStatus(`âœ… JS done in ${result.ms} ms`, "ok");
      } else {
        if (result.timeout) setStatus(`â±ï¸ ${result.error} (killed safely)`, "bad");
        else setStatus(`âŒ ${result.error}`, "bad");
      }
    }

    const runPreviewDebounced = debounce(()=>{ if(autoPreview.checked) runPreview(); }, 300);

    htmlCM.on("change", ()=>{ setStatus("Editing HTMLâ€¦", ""); runPreviewDebounced(); });
    jsCM.on("change", ()=>{ setStatus("Editing JSâ€¦", ""); });
    jsonCM.on("change", ()=>{ setStatus("Editing JSONâ€¦", ""); runPreviewDebounced(); });

    // Keyboard shortcuts
    htmlCM.addKeyMap({ "Ctrl-Enter": ()=>runPreview(), "Cmd-Enter": ()=>runPreview() });
    jsCM.addKeyMap({ "Ctrl-Enter": ()=>runJsSandbox(), "Cmd-Enter": ()=>runJsSandbox() });
    jsonCM.addKeyMap({ "Ctrl-Enter": ()=>runJsonOnly(), "Cmd-Enter": ()=>runJsonOnly() });

    // Buttons
    $("btnRunAll").addEventListener("click", runPreview);
    $("btnRunJs").addEventListener("click", runJsSandbox);
    $("btnRunJson").addEventListener("click", runJsonOnly);

    $("btnClearConsole").addEventListener("click", ()=>{ clearConsole(); setStatus("Console cleared.", "ok"); });

    $("btnSave").addEventListener("click", ()=>{
      const payload = {
        html: htmlCM.getValue(),
        js: jsCM.getValue(),
        json: jsonCM.getValue(),
        stdin: $("stdin").value,
        timeout: Number(timeoutMsEl.value || 2000),
        autoPreview: !!autoPreview.checked,
        injectJs: !!injectJs.checked,
        renderJson: !!renderJson.checked
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      setStatus("Saved âœ…", "ok");
    });

    $("btnLoad").addEventListener("click", ()=>{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ setStatus("Nothing saved yet.", "bad"); return; }
      try{
        const payload = JSON.parse(raw);
        htmlCM.setValue(payload.html || starterHTML);
        jsCM.setValue(payload.js || starterJS);
        jsonCM.setValue(payload.json || starterJSON);
        $("stdin").value = payload.stdin || "";
        timeoutMsEl.value = String(payload.timeout || 2000);
        autoPreview.checked = !!payload.autoPreview;
        injectJs.checked = !!payload.injectJs;
        renderJson.checked = payload.renderJson !== false;
        $("tLabel").textContent = String(timeoutMsEl.value);
        runPreview();
        setStatus("Loaded âœ…", "ok");
      }catch(e){
        setStatus("Load failed.", "bad");
      }
    });

    $("btnReset").addEventListener("click", ()=>{
      htmlCM.setValue(starterHTML);
      jsCM.setValue(starterJS);
      jsonCM.setValue(starterJSON);
      $("stdin").value = "Champak\n25";
      timeoutMsEl.value = "2000";
      autoPreview.checked = true;
      injectJs.checked = false;
      renderJson.checked = true;
      $("tLabel").textContent = "2000";
      clearConsole();
      runPreview();
      setStatus("Reset âœ…", "ok");
    });

    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); return true; }
      catch(_){
        const ta=document.createElement("textarea");
        ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.select();
        try{ document.execCommand("copy"); document.body.removeChild(ta); return true; }
        catch(e){ document.body.removeChild(ta); return false; }
      }
    }

    $("btnShare").addEventListener("click", async ()=>{
      const packed = packState();
      const url = location.origin + location.pathname + "#pp=" + packed;

      if (navigator.share){
        try{
          await navigator.share({
            title:"PP Merged Editor â€” shared code",
            text:"Open this link to load HTML + JS + JSON + stdin.",
            url
          });
          setStatus("Shared âœ…", "ok");
          return;
        }catch(e){}
      }
      const ok = await copyToClipboard(url);
      setStatus(ok ? "Share link copied âœ…" : "Could not copy link", ok ? "ok":"bad");
    });

    // Preview error bridge
    window.addEventListener("message", (ev)=>{
      const d = ev.data || {};
      if (d.type === "pp_preview_error"){
        setStatus("Preview error: " + d.message, "bad");
      }
    });

    // Init: load share hash or localStorage or defaults
    (function init(){
      let loaded = false;
      if (location.hash && location.hash.startsWith("#pp=")){
        const packed = location.hash.slice(4);
        try{
          const state = unpackState(packed);
          htmlCM.setValue(state.html || starterHTML);
          jsCM.setValue(state.js || starterJS);
          jsonCM.setValue(state.json || starterJSON);
          $("stdin").value = state.stdin || "";
          timeoutMsEl.value = String(state.timeout || 2000);
          autoPreview.checked = !!state.autoPreview;
          injectJs.checked = !!state.injectJs;
          renderJson.checked = state.renderJson !== false;
          $("tLabel").textContent = String(timeoutMsEl.value);
          loaded = true;
          setStatus("Loaded from shared link âœ…", "ok");
        }catch(e){
          setStatus("Share link invalid.", "bad");
        }
      }

      if (!loaded){
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw){
          try{
            const payload = JSON.parse(raw);
            htmlCM.setValue(payload.html || starterHTML);
            jsCM.setValue(payload.js || starterJS);
            jsonCM.setValue(payload.json || starterJSON);
            $("stdin").value = payload.stdin || "Champak\n25";
            timeoutMsEl.value = String(payload.timeout || 2000);
            autoPreview.checked = !!payload.autoPreview;
            injectJs.checked = !!payload.injectJs;
            renderJson.checked = payload.renderJson !== false;
            $("tLabel").textContent = String(timeoutMsEl.value);
          }catch(_){
            htmlCM.setValue(starterHTML);
            jsCM.setValue(starterJS);
            jsonCM.setValue(starterJSON);
            $("stdin").value = "Champak\n25";
          }
        } else {
          htmlCM.setValue(starterHTML);
          jsCM.setValue(starterJS);
          jsonCM.setValue(starterJSON);
          $("stdin").value = "Champak\n25";
        }
      }

      runPreview();
    })();
  </script>
</body>
</html>