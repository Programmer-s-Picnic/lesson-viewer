<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Voice Recorder Pro â€“ Programmerâ€™s Picnic</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,#fff7ed,#ffedd5);
  display:flex;
  justify-content:center;
  padding:20px;
}
.card{
  width:100%;
  max-width:1000px;
  background:#fff;
  border-radius:22px;
  padding:20px;
  box-shadow:0 18px 48px rgba(0,0,0,.18);
}
.brand{font-weight:800;color:#92400e}
h1{margin:6px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
button{
  border:none;
  padding:10px 14px;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
}
.primary{background:#f59e0b}
.danger{background:#ef4444;color:white}
.ok{background:#10b981;color:white}
canvas{
  width:100%;
  height:120px;
  background:#0b0b0b;
  border-radius:12px;
}
audio{width:100%;margin-top:8px}
.slider{
  display:flex;
  align-items:center;
  gap:10px;
  margin:6px 0;
}
label{font-weight:700;font-size:14px}
input[type=range]{width:100%}
</style>
</head>

<body>
<div class="card">

<div class="brand">Programmerâ€™s Picnic</div>
<h1>ðŸŽ™ Voice Recorder Pro</h1>

<div class="row">
  <button class="primary" id="rec">Record</button>
  <button class="danger" id="stop" style="display:none">Stop</button>
  <button class="ok" id="dlWav" style="display:none">WAV</button>
  <button class="ok" id="dlMp3" style="display:none">MP3</button>
</div>

<canvas id="wave"></canvas>

<div class="slider">
  <label>Volume</label>
  <input type="range" id="gain" min="0" max="2" step="0.01" value="1">
</div>

<div class="slider">
  <label>Speed</label>
  <input type="range" id="speed" min="0.5" max="1.5" step="0.01" value="1">
</div>

<audio id="player" controls></audio>

<script>
let mediaRec, chunks=[], audioBuf;
let ctx=new AudioContext();
let analyser, dataArray, srcNode;
let canvas=document.getElementById("wave");
let cctx=canvas.getContext("2d");
let anim;

rec.onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  analyser=ctx.createAnalyser();
  analyser.fftSize=2048;
  dataArray=new Uint8Array(analyser.fftSize);
  srcNode=ctx.createMediaStreamSource(stream);
  srcNode.connect(analyser);

  mediaRec=new MediaRecorder(stream);
  chunks=[];
  mediaRec.ondataavailable=e=>chunks.push(e.data);
  mediaRec.onstop=async()=>{
    cancelAnimationFrame(anim);
    const blob=new Blob(chunks);
    audioBuf=await ctx.decodeAudioData(await blob.arrayBuffer());
    updatePlayer();
    dlWav.style.display=dlMp3.style.display="inline-block";
  };
  mediaRec.start();
  draw();
  rec.style.display="none";
  stop.style.display="inline-block";
};

stop.onclick=()=>{
  mediaRec.stop();
  rec.style.display="inline-block";
  stop.style.display="none";
};

function draw(){
  anim=requestAnimationFrame(draw);
  analyser.getByteTimeDomainData(dataArray);
  cctx.fillStyle="#0b0b0b";
  cctx.fillRect(0,0,canvas.width,canvas.height);
  cctx.strokeStyle="#f59e0b";
  cctx.beginPath();
  let x=0, slice=canvas.width/dataArray.length;
  for(let i=0;i<dataArray.length;i++){
    let v=(dataArray[i]-128)/128;
    let y=canvas.height/2+v*canvas.height/2;
    if(i===0)cctx.moveTo(x,y);
    else cctx.lineTo(x,y);
    x+=slice;
  }
  cctx.stroke();
}

function applyEffects(){
  const gain=parseFloat(gainSlider.value);
  const speed=parseFloat(speedSlider.value);

  const len=Math.floor(audioBuf.length/speed);
  const out=ctx.createBuffer(1,len,audioBuf.sampleRate);
  const ch=audioBuf.getChannelData(0);
  const outCh=out.getChannelData(0);

  for(let i=0;i<len;i++){
    let srcIdx=Math.floor(i*speed);
    outCh[i]=(ch[srcIdx]||0)*gain;
  }
  return out;
}

function updatePlayer(){
  const buf=applyEffects();
  player.src=URL.createObjectURL(toWav(buf));
}

gainSlider.oninput=speedSlider.oninput=updatePlayer;

dlWav.onclick=()=>{
  download(toWav(applyEffects()),"voice.wav");
};
dlMp3.onclick=()=>{
  download(toMp3(applyEffects()),"voice.mp3");
};

function download(b,n){
  const u=URL.createObjectURL(b);
  const a=document.createElement("a");
  a.href=u;a.download=n;a.click();
  URL.revokeObjectURL(u);
}

/* WAV */
function toWav(b){
  const l=b.length*2+44;
  const a=new ArrayBuffer(l),v=new DataView(a);
  let o=0;
  const w=s=>{for(let i=0;i<s.length;i++)v.setUint8(o++,s.charCodeAt(i))};
  w("RIFF");v.setUint32(o,l-8,true);o+=4;
  w("WAVEfmt ");v.setUint32(o,16,true);o+=4;
  v.setUint16(o,1,true);o+=2;
  v.setUint16(o,1,true);o+=2;
  v.setUint32(o,b.sampleRate,true);o+=4;
  v.setUint32(o,b.sampleRate*2,true);o+=4;
  v.setUint16(o,2,true);o+=2;
  v.setUint16(o,16,true);o+=2;
  w("data");v.setUint32(o,l-o-4,true);o+=4;
  const ch=b.getChannelData(0);
  for(let i=0;i<ch.length;i++){
    v.setInt16(o,Math.max(-1,Math.min(1,ch[i]))*32767,true);
    o+=2;
  }
  return new Blob([v],{type:"audio/wav"});
}

/* MP3 */
function toMp3(b){
  const enc=new lamejs.Mp3Encoder(1,b.sampleRate,128);
  const ch=b.getChannelData(0);
  let mp3=[],i=0;
  while(i<ch.length){
    const slice=ch.subarray(i,i+1152);
    const pcm=new Int16Array(slice.length);
    for(let j=0;j<slice.length;j++)pcm[j]=slice[j]*32767;
    const buf=enc.encodeBuffer(pcm);
    if(buf.length)mp3.push(new Uint8Array(buf));
    i+=1152;
  }
  const end=enc.flush();
  if(end.length)mp3.push(new Uint8Array(end));
  return new Blob(mp3,{type:"audio/mp3"});
}

const gainSlider=document.getElementById("gain");
const speedSlider=document.getElementById("speed");
</script>

</div>
</body>
</html>