.<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saturday Questions — Spiral Challenge</title>
  <meta name="description" content="Programmer’s Picnic — Saturday Questions. SVG targets only. Solve in embedded Python editor." />

  <style>
    :root{
      --bg:#fff7e6;
      --panel:rgba(255,255,255,.78);
      --ink:#1f2328;
      --muted:#5b6570;
      --line:rgba(31,35,40,.12);
      --saffron:#ff9f1c;
      --saffron2:#ffb74d;
      --shadow:0 12px 34px rgba(31,35,40,.12);
      --radius:18px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 12% 0%,rgba(255,159,28,.22),transparent 60%),
        radial-gradient(900px 600px at 92% 10%,rgba(255,183,77,.20),transparent 55%),
        var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter:blur(10px);
      background:rgba(255,247,230,.80);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1400px; margin:0 auto;
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:240px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(145deg,var(--saffron),var(--saffron2));
      display:grid;place-items:center;
      font-weight:900;color:#111;
      box-shadow:0 10px 18px rgba(255,159,28,.25);
      user-select:none;
    }
    .brand-title{font-weight:950;letter-spacing:.2px;font-size:18px;line-height:1.05}
    .brand-sub{color:var(--muted);font-size:12px;margin-top:2px;line-height:1.2}

    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .date-pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.65);
      padding:9px 12px;
      border-radius:999px;
      font-weight:950;
      white-space:nowrap;
    }
    .btn{
      border:1px solid rgba(255,159,28,.30);
      background:linear-gradient(180deg,rgba(255,159,28,.22),rgba(255,183,77,.14));
      color:#111;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:transform .15s ease, filter .15s ease;
    }
    .btn.ghost{
      border:1px solid var(--line);
      background:rgba(255,255,255,.65);
      color:var(--ink);
    }
    .btn:hover{filter:brightness(.985); transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    .wrap{max-width:1400px;margin:0 auto;padding:14px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:14px}

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.62);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .panel-title{font-weight:950;font-size:16px}
    .panel-sub{color:var(--muted);font-size:12px;margin-top:4px}
    code{font-family:var(--mono);font-size:12px}

    .filters{
      padding:12px 14px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.52);
    }
    .row{display:flex;gap:10px;margin-top:10px}
    .input,.select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.90);
      outline:none;
      font-family:var(--sans);
    }
    .input:focus,.select:focus{
      border-color:rgba(255,159,28,.55);
      box-shadow:0 0 0 4px rgba(255,159,28,.16);
    }

    .q-list{padding:10px;max-height:calc(100vh - 270px);overflow:auto}
    .q-item{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.86);
      padding:10px;
      margin-bottom:10px;
      cursor:pointer;
      transition:transform .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .q-item:hover{border-color:rgba(255,159,28,.40);transform:translateY(-1px)}
    .q-item.active{
      border-color:rgba(255,159,28,.75);
      box-shadow:0 0 0 4px rgba(255,159,28,.12);
    }
    .q-title{font-weight:950;font-size:13px}
    .q-meta{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;color:var(--muted);font-size:11px}
    .pill{
      padding:2px 8px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      color:#111;
      font-weight:950;
    }
    .tip{
      padding:10px 14px 14px;
      color:var(--muted);
      font-size:12px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.52);
    }

    .work{min-height:calc(100vh - 160px)}
    .work-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .work-grid{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:12px;
      padding:12px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.88);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:340px;
    }
    .card.editor{min-height:580px}
    .card-head{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.72);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card-title{font-weight:950}
    .card-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.88);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:950;
    }
    .chip:hover{border-color:rgba(255,159,28,.40)}
    .chip:disabled{opacity:.55;cursor:not-allowed}

    .content{padding:12px 14px;font-size:14px;line-height:1.55;color:var(--muted)}
    .svg-wrap{padding:12px 14px 14px}
    .svg-card{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.84);
      padding:10px;
      overflow:auto;
    }

    .section{
      display:none;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background:rgba(255,247,230,.40);
    }
    .section-title{font-weight:950;margin:0 0 8px;color:var(--ink)}
    .codeblock{
      font-family:var(--mono);
      font-size:13px;
      line-height:1.5;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.82);
      overflow:auto;
      margin:0;
      color:#111;
      white-space:pre;
    }

    .small{padding:0 12px 12px;font-size:12px;color:var(--muted)}
    .editor-iframe-wrap{padding:10px;flex:1;min-height:420px}
    iframe.editor{
      width:100%;
      height:100%;
      min-height:420px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.95);
    }
    .footer{
      padding:12px 14px 16px;
      color:var(--muted);
      font-size:12px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.58);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
      font-weight:950;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}

    @media (max-width:1020px){
      .grid{grid-template-columns:1fr}
      .q-list{max-height:42vh}
      .work-grid{grid-template-columns:1fr}
      .work{min-height:auto}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">PP</div>
        <div>
          <!-- From JSON -->
          <div class="brand-title" id="brandTitle"></div>
          <div class="brand-sub" id="brandSub"></div>
        </div>
      </div>
      <div class="actions">
        <!-- From JSON -->
        <div class="date-pill" id="todayDate"></div>
        <button class="btn ghost" id="btnTeacher" type="button">Teacher</button>
        <button class="btn" id="btnShare" type="button">Share</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Left -->
      <aside class="panel" aria-label="Question Bank">
        <div class="panel-head">
          <div>
            <!-- From JSON -->
            <div class="panel-title" id="bankTitle"></div>
            <div class="panel-sub" id="bankSub"></div>
          </div>
        </div>

        <div class="filters">
          <label id="searchLabel" style="display:block; font-size:12px; color: var(--muted); font-weight:950;"></label>
          <input id="qSearch" class="input" autocomplete="off" />
          <div class="row" style="margin-top:10px;">
            <select id="qDifficulty" class="select" aria-label="Difficulty"></select>
            <select id="qTag" class="select" aria-label="Tag"></select>
          </div>
        </div>

        <div id="qList" class="q-list" role="list"></div>

        <!-- From JSON -->
        <div class="tip" id="bankTip"></div>
      </aside>

      <!-- Right -->
      <section class="panel work" aria-label="Work Area">
        <div class="panel-head">
          <div>
            <div id="qTitle" class="panel-title"></div>
            <div id="qMeta" class="panel-sub"></div>
          </div>
          <div class="work-actions">
            <button class="btn ghost" id="btnCopyStarter" type="button" disabled></button>
            <a class="btn" id="btnOpenEditor" href="#" target="_blank" rel="noopener noreferrer"></a>
          </div>
        </div>

        <div class="work-grid">
          <!-- Target -->
          <div class="card">
            <div class="card-head">
              <!-- From JSON -->
              <div class="card-title" id="targetTitle"></div>
              <div class="card-actions">
                <button class="chip" id="btnHints" type="button" disabled></button>
                <button class="chip" id="btnSolution" type="button" disabled></button>
              </div>
            </div>

            <!-- From JSON -->
            <div class="content" id="targetSub"></div>

            <div class="svg-wrap">
              <div class="svg-card" id="svgTarget" aria-label="SVG target output"></div>
            </div>

            <div class="section" id="hintsSection">
              <!-- From JSON -->
              <div class="section-title" id="hintsTitle"></div>
              <ol id="qHints" style="margin:0; padding-left:18px;"></ol>
            </div>

            <div class="section" id="solutionSection">
              <!-- From JSON -->
              <div class="section-title" id="solutionTitle"></div>
              <pre class="codeblock" id="qSolution"></pre>
            </div>
          </div>

          <!-- Editor -->
          <div class="card editor">
            <div class="card-head">
              <!-- From JSON -->
              <div class="card-title" id="editorTitle"></div>
              <div class="card-actions">
                <span class="pill" id="editorStatus"></span>
                <button class="chip" id="btnCopyQuestionLink" type="button" disabled></button>
              </div>
            </div>

            <div class="editor-iframe-wrap">
              <iframe
                id="ppEditorFrame"
                class="editor"
                title="Programmer’s Picnic Python Editor"
                loading="lazy"
                referrerpolicy="no-referrer-when-downgrade"
                sandbox="allow-scripts allow-forms allow-popups allow-modals allow-downloads allow-same-origin"
              ></iframe>
            </div>

            <!-- From JSON -->
            <div class="small" id="editorTip"></div>

            <div class="footer">
              © Programmer’s Picnic • <span id="publishedLabel"></span>: <span id="publishedDate"></span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite"></div>

  <!-- ✅ EVERYTHING comes from this JSON -->
  <script id="app-json" type="application/json">
{
  "meta": {
    "site_title": "Saturday Questions",
    "subtitle": "Spiral Patterns • Solve in the embedded Python editor",
    "published_label": "",
    "published_date": "Saturday, 21 February 2026",
    "today_date": "Saturday, 21 February 2026",
    "version": 5
  },
  "config": {
    "editor_url": "https://programmer-s-picnic.github.io/lesson-viewer/python-starter/editor/super/?tmode=0"
  },
  "ui": {
    "bank_title": "",
    "bank_sub": "",
    "bank_tip": "",
    "search_label": "Search",
    "search_placeholder": "Title or tags...",
    "difficulty_all": "All levels",
    "difficulty_values": ["medium", "hard"],
    "difficulty_labels": {"medium":"Medium","hard":"Hard"},
    "tag_all": "All tags",
    "btn_teacher_off": "Teacher",
    "btn_teacher_on": "Teacher: ON",
    "btn_share": "Share",
    "btn_copy_starter": "Copy starter",
    "btn_open_editor": "Open editor",
    "target_title": "Target Output",
    "target_sub": "The target output is shown as an SVG grid.",
    "btn_hints": "Hints",
    "btn_solution": "Solution",
    "hints_title": "Hints",
    "solution_title": "Solution (Teacher mode)",
    "editor_title": "Python Editor",
    "editor_status": "iframe",
    "btn_copy_q_link": "Copy Q link",
    "editor_tip": "Paste starter code into the editor. Share this page with a question selected for direct access."
  },
  "questions": [
    {
      "id": "Q3-spiral-direct-4x4",
      "title": "Spiral 4×4 (Direct / Clockwise)",
      "difficulty": "medium",
      "tags": ["loops", "matrix", "spiral"],
      "estimated_minutes": 15,
      "svg_type": "spiral_direct",
      "n": 4,
      "hints": [
        "Use boundaries: top, bottom, left, right.",
        "Fill: top row → right column → bottom row → left column.",
        "Shrink boundaries after each side."
      ],
      "starter_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\n# TODO: fill mat in direct spiral order (clockwise)\n\nfor row in mat:\n    print(*row)\n",
      "solution_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\nnum = 1\ntop, bottom = 0, n-1\nleft, right = 0, n-1\n\nwhile left <= right and top <= bottom:\n    for j in range(left, right+1):\n        mat[top][j] = num; num += 1\n    top += 1\n\n    for i in range(top, bottom+1):\n        mat[i][right] = num; num += 1\n    right -= 1\n\n    for j in range(right, left-1, -1):\n        mat[bottom][j] = num; num += 1\n    bottom -= 1\n\n    for i in range(bottom, top-1, -1):\n        mat[i][left] = num; num += 1\n    left += 1\n\nfor row in mat:\n    print(*row)\n"
    },
    {
      "id": "Q4-spiral-reverse-4x4",
      "title": "Spiral 4×4 (Reverse / Counter-Clockwise)",
      "difficulty": "hard",
      "tags": ["loops", "matrix", "spiral"],
      "estimated_minutes": 20,
      "svg_type": "spiral_reverse",
      "n": 4,
      "hints": [
        "Use boundaries: top, bottom, left, right.",
        "Fill: left column → bottom row → right column → top row.",
        "Shrink boundaries after each side."
      ],
      "starter_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\n# TODO: fill mat in reverse spiral order (counter-clockwise)\n\nfor row in mat:\n    print(*row)\n",
      "solution_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\nnum = 1\ntop, bottom = 0, n-1\nleft, right = 0, n-1\n\nwhile left <= right and top <= bottom:\n    for i in range(top, bottom+1):\n        mat[i][left] = num; num += 1\n    left += 1\n\n    for j in range(left, right+1):\n        mat[bottom][j] = num; num += 1\n    bottom -= 1\n\n    for i in range(bottom, top-1, -1):\n        mat[i][right] = num; num += 1\n    right -= 1\n\n    for j in range(right, left-1, -1):\n        mat[top][j] = num; num += 1\n    top += 1\n\nfor row in mat:\n    print(*row)\n"
    },
    {
      "id": "Q5-spiral-direct-4x4-inverted",
      "title": "Spiral 4×4 (Direct) — Inverted Series",
      "difficulty": "medium",
      "tags": ["loops", "matrix", "spiral"],
      "estimated_minutes": 18,
      "svg_type": "spiral_direct_inverted",
      "n": 4,
      "hints": [
        "Generate normal direct spiral values first (1..n*n).",
        "Then convert each cell: new = (n*n + 1) - old.",
        "Now 1↔16, 2↔15, …"
      ],
      "starter_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\n# TODO:\n# 1) Fill direct spiral (1..n*n)\n# 2) Invert values: v = (n*n + 1) - v\n\nfor row in mat:\n    print(*row)\n",
      "solution_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\nnum = 1\ntop, bottom = 0, n-1\nleft, right = 0, n-1\n\nwhile left <= right and top <= bottom:\n    for j in range(left, right+1):\n        mat[top][j] = num; num += 1\n    top += 1\n\n    for i in range(top, bottom+1):\n        mat[i][right] = num; num += 1\n    right -= 1\n\n    for j in range(right, left-1, -1):\n        mat[bottom][j] = num; num += 1\n    bottom -= 1\n\n    for i in range(bottom, top-1, -1):\n        mat[i][left] = num; num += 1\n    left += 1\n\nmx = n*n + 1\nfor i in range(n):\n    for j in range(n):\n        mat[i][j] = mx - mat[i][j]\n\nfor row in mat:\n    print(*row)\n"
    },
    {
      "id": "Q6-spiral-reverse-4x4-inverted",
      "title": "Spiral 4×4 (Reverse) — Inverted Series",
      "difficulty": "hard",
      "tags": ["loops", "matrix", "spiral"],
      "estimated_minutes": 22,
      "svg_type": "spiral_reverse_inverted",
      "n": 4,
      "hints": [
        "Generate normal reverse spiral first (1..n*n).",
        "Then invert values: new = (n*n + 1) - old.",
        "Check: 1 becomes 16 and 16 becomes 1."
      ],
      "starter_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\n# TODO:\n# 1) Fill reverse spiral (1..n*n)\n# 2) Invert values: v = (n*n + 1) - v\n\nfor row in mat:\n    print(*row)\n",
      "solution_code": "n = 4\nmat = [[0]*n for _ in range(n)]\n\nnum = 1\ntop, bottom = 0, n-1\nleft, right = 0, n-1\n\nwhile left <= right and top <= bottom:\n    for i in range(top, bottom+1):\n        mat[i][left] = num; num += 1\n    left += 1\n\n    for j in range(left, right+1):\n        mat[bottom][j] = num; num += 1\n    bottom -= 1\n\n    for i in range(bottom, top-1, -1):\n        mat[i][right] = num; num += 1\n    right -= 1\n\n    for j in range(right, left-1, -1):\n        mat[top][j] = num; num += 1\n    top += 1\n\nmx = n*n + 1\nfor i in range(n):\n    for j in range(n):\n        mat[i][j] = mx - mat[i][j]\n\nfor row in mat:\n    print(*row)\n"
    }
  ]
}
  </script>

  <script>
    const $ = (sel) => document.querySelector(sel);

    const els = {
      brandTitle: $("#brandTitle"),
      brandSub: $("#brandSub"),
      todayDate: $("#todayDate"),

      bankTitle: $("#bankTitle"),
      bankSub: $("#bankSub"),
      bankTip: $("#bankTip"),
      searchLabel: $("#searchLabel"),

      qSearch: $("#qSearch"),
      qDifficulty: $("#qDifficulty"),
      qTag: $("#qTag"),
      qList: $("#qList"),

      qTitle: $("#qTitle"),
      qMeta: $("#qMeta"),

      btnTeacher: $("#btnTeacher"),
      btnShare: $("#btnShare"),
      btnCopyStarter: $("#btnCopyStarter"),
      btnOpenEditor: $("#btnOpenEditor"),
      btnCopyQuestionLink: $("#btnCopyQuestionLink"),
      btnHints: $("#btnHints"),
      btnSolution: $("#btnSolution"),

      targetTitle: $("#targetTitle"),
      targetSub: $("#targetSub"),

      hintsTitle: $("#hintsTitle"),
      solutionTitle: $("#solutionTitle"),
      hintsSection: $("#hintsSection"),
      solutionSection: $("#solutionSection"),
      qHints: $("#qHints"),
      qSolution: $("#qSolution"),

      editorTitle: $("#editorTitle"),
      editorStatus: $("#editorStatus"),
      editorTip: $("#editorTip"),
      publishedLabel: $("#publishedLabel"),
      publishedDate: $("#publishedDate"),

      svgTarget: $("#svgTarget"),
      editorFrame: $("#ppEditorFrame"),
      toast: $("#toast")
    };

    let QUESTIONS = [];
    let CONFIG = { editor_url: "" };
    let UI = {};
    let META = {};
    let activeId = null;
    let teacherMode = false;

    function toast(msg){
      els.toast.textContent = String(msg || "");
      els.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => els.toast.classList.remove("show"), 1400);
    }

    function getQueryParam(name){
      return new URL(location.href).searchParams.get(name);
    }
    function setQueryParam(name, value){
      const u = new URL(location.href);
      if (value == null || value === "") u.searchParams.delete(name);
      else u.searchParams.set(name, value);
      history.replaceState({}, "", u.toString());
    }
    function currentShareLink(){
      const u = new URL(location.href);
      if(activeId) u.searchParams.set("q", activeId);
      return u.toString();
    }
    async function copyText(text){
      const t = String(text || "");
      try{
        await navigator.clipboard.writeText(t);
      }catch{
        const ta = document.createElement("textarea");
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch{}
        ta.remove();
      }
    }

    function readAppJSON(){
      const raw = $("#app-json")?.textContent;
      if(!raw) throw new Error("Missing app JSON");
      return JSON.parse(raw);
    }

    function safeText(el, v){ el.textContent = String(v ?? ""); }
    function clearEl(el){ while(el.firstChild) el.removeChild(el.firstChild); }

    // SVG generator (trusted)
    function makeGridSVG(matrix, opts = {}){
      const n = matrix.length;
      const cell = opts.cell ?? 64;
      const pad = opts.pad ?? 14;
      const r = opts.radius ?? 14;
      const w = pad*2 + n*cell;
      const h = pad*2 + n*cell;

      const maxVal = Math.max(...matrix.flat());
      const digits = String(maxVal).length;
      const font = digits <= 2 ? 18 : 16;

      const bg1 = "rgba(255,159,28,0.10)";
      const bg2 = "rgba(255,255,255,0.78)";
      const stroke = "rgba(31,35,40,0.18)";
      const strokeBold = "rgba(255,159,28,0.75)";
      const text = "#1f2328";

      let cells = "";
      for(let i=0;i<n;i++){
        for(let j=0;j<n;j++){
          const x = pad + j*cell;
          const y = pad + i*cell;
          const v = matrix[i][j];
          cells += `
            <g>
              <rect x="${x}" y="${y}" width="${cell}" height="${cell}" rx="${r}" ry="${r}"
                    fill="${(i+j)%2===0?bg2:bg1}" stroke="${stroke}" stroke-width="1.2"/>
              <text x="${x + cell/2}" y="${y + cell/2}"
                    font-family="ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial"
                    font-size="${font}" font-weight="900"
                    fill="${text}" text-anchor="middle" dominant-baseline="central">${v}</text>
            </g>`;
        }
      }

      const outer = `
        <rect x="${pad-6}" y="${pad-6}" width="${n*cell+12}" height="${n*cell+12}"
              rx="${r+6}" ry="${r+6}" fill="none" stroke="${strokeBold}" stroke-width="2"/>`;

      return `
        <svg viewBox="0 0 ${w} ${h}" width="100%" height="auto" role="img" aria-label="Target grid">
          <defs>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="10" stdDeviation="10" flood-color="rgba(31,35,40,0.12)"/>
            </filter>
          </defs>
          <rect x="0" y="0" width="${w}" height="${h}" rx="18" ry="18" fill="rgba(255,255,255,0.52)"/>
          <g filter="url(#shadow)">
            ${outer}
            ${cells}
          </g>
        </svg>`;
    }

    function buildSpiralDirect(n){
      const a = Array.from({length:n}, ()=>Array(n).fill(0));
      let num = 1, top = 0, bottom = n-1, left = 0, right = n-1;
      while(left <= right && top <= bottom){
        for(let j=left;j<=right;j++) a[top][j]=num++;
        top++;
        for(let i=top;i<=bottom;i++) a[i][right]=num++;
        right--;
        for(let j=right;j>=left;j--) a[bottom][j]=num++;
        bottom--;
        for(let i=bottom;i>=top;i--) a[i][left]=num++;
        left++;
      }
      return a;
    }
    function buildSpiralReverse(n){
      const a = Array.from({length:n}, ()=>Array(n).fill(0));
      let num = 1, top = 0, bottom = n-1, left = 0, right = n-1;
      while(left <= right && top <= bottom){
        for(let i=top;i<=bottom;i++) a[i][left]=num++;
        left++;
        for(let j=left;j<=right;j++) a[bottom][j]=num++;
        bottom--;
        for(let i=bottom;i>=top;i--) a[i][right]=num++;
        right--;
        for(let j=right;j>=left;j--) a[top][j]=num++;
        top++;
      }
      return a;
    }
    function invertMatrix(mat){
      const n = mat.length;
      const mx = n*n + 1;
      return mat.map(row => row.map(v => mx - v));
    }
    function getMatrixForQuestion(q){
      const n = Number(q.n || 4) || 4;
      if(q.svg_type === "spiral_direct") return buildSpiralDirect(n);
      if(q.svg_type === "spiral_reverse") return buildSpiralReverse(n);
      if(q.svg_type === "spiral_direct_inverted") return invertMatrix(buildSpiralDirect(n));
      if(q.svg_type === "spiral_reverse_inverted") return invertMatrix(buildSpiralReverse(n));
      return Array.from({length:n}, ()=>Array(n).fill(0));
    }

    function setupFromJSON(){
      // Meta
      safeText(els.brandTitle, META.site_title);
      safeText(els.brandSub, META.subtitle);
      safeText(els.todayDate, META.today_date);
      safeText(els.publishedLabel, META.published_label);
      safeText(els.publishedDate, META.published_date);

      // Bank UI
      safeText(els.bankTitle, UI.bank_title);
      safeText(els.bankSub, UI.bank_sub);
      safeText(els.bankTip, UI.bank_tip);
      safeText(els.searchLabel, UI.search_label);
      els.qSearch.placeholder = String(UI.search_placeholder || "");
      els.qSearch.value = "";

      // Buttons / labels
      safeText(els.btnTeacher, UI.btn_teacher_off);
      safeText(els.btnShare, UI.btn_share);
      safeText(els.btnCopyStarter, UI.btn_copy_starter);
      safeText(els.btnOpenEditor, UI.btn_open_editor);

      safeText(els.targetTitle, UI.target_title);
      safeText(els.targetSub, UI.target_sub);
      safeText(els.btnHints, UI.btn_hints);
      safeText(els.btnSolution, UI.btn_solution);
      safeText(els.hintsTitle, UI.hints_title);
      safeText(els.solutionTitle, UI.solution_title);

      safeText(els.editorTitle, UI.editor_title);
      safeText(els.editorStatus, UI.editor_status);
      safeText(els.btnCopyQuestionLink, UI.btn_copy_q_link);
      safeText(els.editorTip, UI.editor_tip);

      // Difficulty options
      clearEl(els.qDifficulty);
      const d0 = document.createElement("option");
      d0.value = "";
      d0.textContent = UI.difficulty_all || "All levels";
      els.qDifficulty.appendChild(d0);

      (UI.difficulty_values || []).forEach(v => {
        const opt = document.createElement("option");
        opt.value = String(v);
        opt.textContent = (UI.difficulty_labels && UI.difficulty_labels[v]) ? UI.difficulty_labels[v] : String(v);
        els.qDifficulty.appendChild(opt);
      });

      // Tag options (from questions)
      const tags = new Set();
      QUESTIONS.forEach(q => (q.tags || []).forEach(t => tags.add(String(t))));
      clearEl(els.qTag);
      const t0 = document.createElement("option");
      t0.value = "";
      t0.textContent = UI.tag_all || "All tags";
      els.qTag.appendChild(t0);
      Array.from(tags).sort((a,b)=>a.localeCompare(b)).forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        els.qTag.appendChild(opt);
      });

      // Defaults
      safeText(els.qTitle, "Select a question");
      safeText(els.qMeta, "Difficulty • Tags • Estimated time");
      els.btnCopyStarter.disabled = true;
      els.btnCopyQuestionLink.disabled = true;
      els.btnHints.disabled = true;
      els.btnSolution.disabled = true;
      els.hintsSection.style.display = "none";
      els.solutionSection.style.display = "none";
      clearEl(els.qHints);
      safeText(els.qSolution, "");
      els.svgTarget.innerHTML = "";
    }

    function initEditor(){
      const override = getQueryParam("editor");
      const editorUrl = override || CONFIG.editor_url;

      const safeUrl = (typeof editorUrl === "string" && editorUrl.startsWith("https://")) ? editorUrl : "";
      els.editorFrame.src = safeUrl;
      els.btnOpenEditor.href = safeUrl || "#";
    }

    function filterQuestions(){
      const s = (els.qSearch.value || "").trim().toLowerCase();
      const diff = els.qDifficulty.value;
      const tag = els.qTag.value;

      return QUESTIONS.filter(q => {
        const qdiff = String(q.difficulty || "").toLowerCase();
        if (diff && qdiff !== diff) return false;
        if (tag && !(q.tags || []).includes(tag)) return false;
        if (!s) return true;

        const hay = [q.id, q.title, q.difficulty, (q.tags||[]).join(" ")].join(" ").toLowerCase();
        return hay.includes(s);
      });
    }

    function renderList(){
      const list = filterQuestions();
      clearEl(els.qList);

      if(!list.length){
        const div = document.createElement("div");
        div.style.padding = "10px";
        div.style.color = "var(--muted)";
        div.textContent = "No questions match.";
        els.qList.appendChild(div);
        return;
      }

      list.forEach(q => {
        const item = document.createElement("div");
        item.className = "q-item" + (q.id === activeId ? " active" : "");
        item.setAttribute("role","listitem");
        item.setAttribute("tabindex","0");
        item.dataset.id = q.id;

        const t = document.createElement("div");
        t.className = "q-title";
        t.textContent = q.title || q.id;

        const meta = document.createElement("div");
        meta.className = "q-meta";

        const p1 = document.createElement("span");
        p1.className = "pill";
        p1.textContent = q.difficulty || "level";

        const p2 = document.createElement("span");
        p2.className = "pill";
        p2.textContent = (q.tags && q.tags[0]) ? q.tags[0] : "tag";

        const p3 = document.createElement("span");
        p3.className = "pill";
        p3.textContent = q.estimated_minutes ? (q.estimated_minutes + " min") : "time";

        meta.appendChild(p1); meta.appendChild(p2); meta.appendChild(p3);

        item.appendChild(t);
        item.appendChild(meta);

        item.addEventListener("click", () => selectQuestion(q.id));
        item.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " ") selectQuestion(q.id);
        });

        els.qList.appendChild(item);
      });
    }

    function setQuestionButtons(q){
      els.btnCopyStarter.disabled = !q;
      els.btnCopyQuestionLink.disabled = !q;
      els.btnHints.disabled = !(q && q.hints && q.hints.length);
      els.btnSolution.disabled = !(q && q.solution_code && String(q.solution_code).trim().length);
    }

    function selectQuestion(id){
      const q = QUESTIONS.find(x => x.id === id);
      if(!q) return;

      activeId = id;
      setQueryParam("q", id);
      renderList();

      safeText(els.qTitle, q.title || q.id);
      safeText(els.qMeta, `${String(q.difficulty || "level").toUpperCase()} • ${(q.tags || []).join(", ") || "no tags"} • ${q.estimated_minutes ? (q.estimated_minutes + " min") : "time n/a"}`);

      const mat = getMatrixForQuestion(q);
      els.svgTarget.innerHTML = makeGridSVG(mat, { cell: 64, pad: 14, radius: 14 });

      // hints (text only)
      clearEl(els.qHints);
      (q.hints || []).forEach(h => {
        const li = document.createElement("li");
        li.textContent = String(h);
        els.qHints.appendChild(li);
      });

      // solution (text only)
      els.qSolution.textContent = String(q.solution_code || "").trim();

      els.hintsSection.style.display = "none";
      els.solutionSection.style.display = "none";

      setQuestionButtons(q);
      toast("Loaded: " + (q.title || q.id));
    }

    function toggleTeacherMode(){
      teacherMode = !teacherMode;
      els.btnTeacher.textContent = teacherMode ? (UI.btn_teacher_on || "Teacher: ON") : (UI.btn_teacher_off || "Teacher");
      if(!teacherMode) els.solutionSection.style.display = "none";
      toast(teacherMode ? "Teacher mode ON" : "Teacher mode OFF");
    }

    // Events
    els.qSearch.addEventListener("input", renderList);
    els.qDifficulty.addEventListener("change", renderList);
    els.qTag.addEventListener("change", renderList);

    els.btnShare.addEventListener("click", async () => {
      await copyText(currentShareLink());
      toast("Share link copied!");
    });

    els.btnTeacher.addEventListener("click", toggleTeacherMode);

    els.btnHints.addEventListener("click", () => {
      els.hintsSection.style.display = (els.hintsSection.style.display === "none") ? "block" : "none";
    });

    els.btnSolution.addEventListener("click", () => {
      if(!teacherMode){
        toast("Turn on Teacher mode to view solution");
        return;
      }
      els.solutionSection.style.display = (els.solutionSection.style.display === "none") ? "block" : "none";
    });

    els.btnCopyStarter.addEventListener("click", async () => {
      const q = QUESTIONS.find(x => x.id === activeId);
      await copyText(q?.starter_code || "");
      toast("Starter code copied!");
    });

    els.btnCopyQuestionLink.addEventListener("click", async () => {
      await copyText(currentShareLink());
      toast("Question link copied!");
    });

    // Boot
    (function boot(){
      const data = readAppJSON();
      META = data.meta || {};
      UI = data.ui || {};
      CONFIG = data.config || { editor_url: "" };
      QUESTIONS = Array.isArray(data.questions) ? data.questions : [];

      setupFromJSON();
      initEditor();
      renderList();

      const fromUrl = getQueryParam("q");
      if(fromUrl && QUESTIONS.some(q => q.id === fromUrl)){
        selectQuestion(fromUrl);
      }else if(QUESTIONS[0]){
        selectQuestion(QUESTIONS[0].id);
      }else{
        setQuestionButtons(null);
      }
    })();
  </script>
</body>
</html>