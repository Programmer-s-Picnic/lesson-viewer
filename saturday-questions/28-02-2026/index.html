<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Saturday Questions</title>
    <meta
      name="description"
      content="Programmerâ€™s Picnic â€” Saturday Questions. Solve in embedded Python editor."
    />
    <meta name="theme-color" content="#d97706" />

    <style>
      :root {
        --bg: #fff7e6;
        --panel: rgba(255, 255, 255, 0.78);
        --ink: #1f2328;
        --muted: #5b6570;
        --line: rgba(31, 35, 40, 0.12);
        --saffron: #ff9f1c;
        --saffron2: #ffb74d;
        --shadow: 0 12px 34px rgba(31, 35, 40, 0.12);
        --radius: 18px;
        --mono:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        --sans:
          ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      * {
        box-sizing: border-box;
      }
      .codelink{
        
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--sans);
        color: var(--ink);
        background:
          radial-gradient(
            1200px 700px at 12% 0%,
            rgba(255, 159, 28, 0.22),
            transparent 60%
          ),
          radial-gradient(
            900px 600px at 92% 10%,
            rgba(255, 183, 77, 0.2),
            transparent 55%
          ),
          var(--bg);
      }

      .topbar {
        position: sticky;
        top: 0;
        z-index: 30;
        backdrop-filter: blur(10px);
        background: rgba(255, 247, 230, 0.8);
        border-bottom: 1px solid var(--line);
      }
      .topbar-inner {
        max-width: 1400px;
        margin: 0 auto;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 240px;
      }
      .logo {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: linear-gradient(145deg, var(--saffron), var(--saffron2));
        display: grid;
        place-items: center;
        font-weight: 900;
        color: #111;
        box-shadow: 0 10px 18px rgba(255, 159, 28, 0.25);
        user-select: none;
      }
      .brand-title {
        font-weight: 950;
        letter-spacing: 0.2px;
        font-size: 18px;
        line-height: 1.05;
      }
      .brand-sub {
        color: var(--muted);
        font-size: 12px;
        margin-top: 2px;
        line-height: 1.2;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .date-pill {
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.65);
        padding: 9px 12px;
        border-radius: 999px;
        font-weight: 950;
        white-space: nowrap;
      }
      .btn {
        border: 1px solid rgba(255, 159, 28, 0.3);
        background: linear-gradient(
          180deg,
          rgba(255, 159, 28, 0.22),
          rgba(255, 183, 77, 0.14)
        );
        color: #111;
        padding: 10px 12px;
        border-radius: 14px;
        cursor: pointer;
        font-weight: 950;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition:
          transform 0.15s ease,
          filter 0.15s ease;
      }
      .btn.ghost {
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.65);
        color: var(--ink);
      }
      .btn:hover {
        filter: brightness(0.985);
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
      }

      .wrap {
        max-width: 1400px;
        margin: 0 auto;
        padding: 14px;
      }
      .banner {
        display: none;
        margin: 14px 0 0;
        border-radius: var(--radius);
        border: 1px solid var(--line);
        overflow: hidden;
        box-shadow: var(--shadow);
        background: rgba(255, 255, 255, 0.55);
      }
      .banner a {
        display: block;
        text-decoration: none;
        color: inherit;
      }
      .banner img {
        display: block;
        width: 100%;
        height: auto;
      }

      .grid {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 14px;
        margin-top: 14px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .panel-head {
        padding: 14px 14px 10px;
        border-bottom: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.62);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
      }
      .panel-title {
        font-weight: 950;
        font-size: 16px;
      }
      .panel-sub {
        color: var(--muted);
        font-size: 12px;
        margin-top: 4px;
      }
      code {
        font-family: var(--mono);
        font-size: 12px;
      }

      .filters {
        padding: 12px 14px 10px;
        border-bottom: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.52);
      }
      .row {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .input,
      .select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.9);
        outline: none;
        font-family: var(--sans);
      }
      .input:focus,
      .select:focus {
        border-color: rgba(255, 159, 28, 0.55);
        box-shadow: 0 0 0 4px rgba(255, 159, 28, 0.16);
      }

      .q-list {
        padding: 10px;
        max-height: calc(100vh - 270px);
        overflow: auto;
      }
      .q-item {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.86);
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition:
          transform 0.15s ease,
          border-color 0.15s ease,
          box-shadow 0.15s ease;
      }
      .q-item:hover {
        border-color: rgba(255, 159, 28, 0.4);
        transform: translateY(-1px);
      }
      .q-item.active {
        border-color: rgba(255, 159, 28, 0.75);
        box-shadow: 0 0 0 4px rgba(255, 159, 28, 0.12);
      }
      .q-title {
        font-weight: 950;
        font-size: 13px;
      }
      .q-meta {
        margin-top: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        color: var(--muted);
        font-size: 11px;
      }
      .pill {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.86);
        color: #111;
        font-weight: 950;
      }
      .tip {
        padding: 10px 14px 14px;
        color: var(--muted);
        font-size: 12px;
        border-top: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.52);
      }

      .work {
        min-height: calc(100vh - 160px);
      }
      .work-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .work-grid {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 12px;
        padding: 12px;
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.88);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 340px;
      }
      .card.editor {
        min-height: 580px;
      }
      .card-head {
        padding: 10px 12px;
        border-bottom: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.72);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .card-title {
        font-weight: 950;
      }
      .card-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      .chip {
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.88);
        padding: 8px 10px;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 950;
      }
      .chip:hover {
        border-color: rgba(255, 159, 28, 0.4);
      }
      .chip:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .content {
        padding: 12px 14px;
        font-size: 14px;
        line-height: 1.55;
        color: var(--ink);
      }
      .muted {
        color: var(--muted);
      }
      .content h3 {
        margin: 0 0 6px;
        font-size: 14px;
      }
      .content p {
        margin: 0 0 10px;
      }
      .content ul {
        margin: 0;
        padding-left: 18px;
      }
      .content li {
        margin: 4px 0;
      }

      .svg-wrap {
        padding: 12px 14px 14px;
      }
      .svg-card {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.84);
        padding: 10px;
        overflow: auto;
      }

      .section {
        display: none;
        padding: 12px 14px;
        border-top: 1px solid var(--line);
        background: rgba(255, 247, 230, 0.4);
      }
      .section-title {
        font-weight: 950;
        margin: 0 0 8px;
        color: var(--ink);
      }
      .codeblock {
        font-family: var(--mono);
        font-size: 13px;
        line-height: 1.5;
        padding: 12px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.82);
        overflow: auto;
        margin: 0;
        color: #111;
        white-space: pre;
      }

      .small {
        padding: 0 12px 12px;
        font-size: 12px;
        color: var(--muted);
      }
      .editor-iframe-wrap {
        padding: 10px;
        flex: 1;
        min-height: 420px;
      }
      iframe.editor {
        width: 100%;
        height: 100%;
        min-height: 420px;
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.95);
      }
      .footer {
        padding: 12px 14px 16px;
        color: var(--muted);
        font-size: 12px;
        border-top: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.58);
      }

      .replies {
        padding: 12px;
        border-top: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.7);
      }
      .reply {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.86);
        padding: 10px;
        margin: 10px 0 0;
      }
      .reply-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        font-size: 12px;
        color: var(--muted);
      }
      .reply-student {
        font-weight: 950;
        color: #111;
      }
      .reply-msg {
        margin-top: 6px;
        color: var(--ink);
        font-size: 13px;
        line-height: 1.45;
      }
      .reply-code {
        margin-top: 10px;
        display: none;
      }
      .reply-code pre {
        margin: 0;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.92);
        box-shadow: var(--shadow);
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
        font-weight: 950;
        z-index: 50;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(-2px);
      }

      @media (max-width: 1020px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .q-list {
          max-height: 42vh;
        }
        .work-grid {
          grid-template-columns: 1fr;
        }
        .work {
          min-height: auto;
        }
      }
    </style>
  </head>

  <body>
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true">PP</div>
          <div>
            <div class="brand-title" id="brandTitle">Saturday Questions</div>
            <div class="brand-sub" id="brandSub">Loadingâ€¦</div>
          </div>
        </div>
        <div class="actions">
          <div class="date-pill" id="todayDate">â€”</div>
          <button class="btn ghost" id="btnTeacher" type="button">
            Teacher
          </button>
          <button class="btn" id="btnShare" type="button">Share</button>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="banner" id="banner"></div>

      <div class="grid">
        <!-- Left -->
        <aside class="panel" aria-label="Question Bank">
          <div class="panel-head">
            <div>
              <div class="panel-title" id="bankTitle">Question Bank</div>
              <div class="panel-sub" id="bankSub">
                Search and select a question.
              </div>
            </div>
          </div>

          <div class="filters">
            <label
              id="searchLabel"
              style="
                display: block;
                font-size: 12px;
                color: var(--muted);
                font-weight: 950;
              "
              >Search</label
            >
            <input id="qSearch" class="input" autocomplete="off" />
            <div class="row" style="margin-top: 10px">
              <select
                id="qDifficulty"
                class="select"
                aria-label="Difficulty"
              ></select>
              <select id="qTag" class="select" aria-label="Tag"></select>
            </div>
          </div>

          <div id="qList" class="q-list" role="list"></div>
          <div class="tip" id="bankTip"></div>
        </aside>

        <!-- Right -->
        <section class="panel work" aria-label="Work Area">
          <div class="panel-head">
            <div>
              <div id="qTitle" class="panel-title">Select a question</div>
              <div id="qMeta" class="panel-sub">
                Difficulty â€¢ Tags â€¢ Estimated time
              </div>
            </div>
            <div class="work-actions">
              <button
                class="btn ghost"
                id="btnCopyStarter"
                type="button"
                disabled
              >
                Copy starter
              </button>
              <a
                class="btn"
                id="btnOpenEditor"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                >Open editor</a
              >
            </div>
          </div>

          <div class="work-grid">
            <!-- Problem -->
            <div class="card">
              <div class="card-head">
                <div class="card-title" id="targetTitle">Problem</div>
                <div class="card-actions">
                  <button class="chip" id="btnHints" type="button" disabled>
                    Hints
                  </button>
                  <button class="chip" id="btnSolution" type="button" disabled>
                    Solution
                  </button>
                </div>
              </div>

              <!-- âœ… This is where prompt + examples will appear -->
              <div class="content" id="problemBox">
                <div class="muted">
                  Select a question to view its statement.
                </div>
              </div>

              <!-- âœ… This is where SVG will appear -->
              <div class="svg-wrap">
                <div
                  class="svg-card"
                  id="svgTarget"
                  aria-label="SVG illustration"
                ></div>
              </div>

              <div class="section" id="hintsSection">
                <div class="section-title" id="hintsTitle">Hints</div>
                <ol id="qHints" style="margin: 0; padding-left: 18px"></ol>
              </div>

              <div class="section" id="solutionSection">
                <div class="section-title" id="solutionTitle">
                  Solution (Teacher mode)
                </div>
                <pre class="codeblock" id="qSolution"></pre>
              </div>
            </div>

            <!-- Editor + Replies -->
            <div class="card editor">
              <div class="card-head">
                <div class="card-title" id="editorTitle">Python Editor</div>
                <div class="card-actions">
                  <span class="pill" id="editorStatus">ðŸ™‚</span>
                  <button
                    class="chip"
                    id="btnCopyQuestionLink"
                    type="button"
                    disabled
                  >
                    Copy Q link
                  </button>
                  <button
                    class="chip"
                    id="btnSubmitReply"
                    type="button"
                    disabled
                  >
                    Submit reply
                  </button>
                </div>
              </div>

              <div class="editor-iframe-wrap">
                <iframe
                  id="ppEditorFrame"
                  class="editor"
                  title="Programmerâ€™s Picnic Python Editor"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  sandbox="allow-scripts allow-forms allow-popups allow-modals allow-downloads allow-same-origin"
                ></iframe>
              </div>

              <div class="small" id="editorTip">Loadingâ€¦</div>

              <div class="replies">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 10px;
                  "
                >
                  <div
                    class="card-title"
                    id="repliesTitle"
                    style="font-size: 14px"
                  >
                    Replies
                  </div>
                  <button class="chip" id="btnReloadReplies" type="button">
                    Reload
                  </button>
                </div>
                <div
                  id="repliesList"
                  style="margin-top: 6px; color: var(--muted); font-size: 12px"
                ></div>
              </div>

              <div class="footer">
                Â© Programmerâ€™s Picnic â€¢ <span id="publishedLabel"></span>:
                <span id="publishedDate"></span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="toast" id="toast" aria-live="polite"></div>

    <script>
      const $ = (sel) => document.querySelector(sel);

      const els = {
        brandTitle: $("#brandTitle"),
        brandSub: $("#brandSub"),
        todayDate: $("#todayDate"),

        banner: $("#banner"),

        bankTitle: $("#bankTitle"),
        bankSub: $("#bankSub"),
        bankTip: $("#bankTip"),
        searchLabel: $("#searchLabel"),

        qSearch: $("#qSearch"),
        qDifficulty: $("#qDifficulty"),
        qTag: $("#qTag"),
        qList: $("#qList"),

        qTitle: $("#qTitle"),
        qMeta: $("#qMeta"),

        btnTeacher: $("#btnTeacher"),
        btnShare: $("#btnShare"),
        btnCopyStarter: $("#btnCopyStarter"),
        btnOpenEditor: $("#btnOpenEditor"),
        btnCopyQuestionLink: $("#btnCopyQuestionLink"),
        btnHints: $("#btnHints"),
        btnSolution: $("#btnSolution"),

        targetTitle: $("#targetTitle"),

        // âœ… NEW: problem box
        problemBox: $("#problemBox"),

        hintsTitle: $("#hintsTitle"),
        solutionTitle: $("#solutionTitle"),
        hintsSection: $("#hintsSection"),
        solutionSection: $("#solutionSection"),
        qHints: $("#qHints"),
        qSolution: $("#qSolution"),

        editorTitle: $("#editorTitle"),
        editorStatus: $("#editorStatus"),
        editorTip: $("#editorTip"),
        publishedLabel: $("#publishedLabel"),
        publishedDate: $("#publishedDate"),

        svgTarget: $("#svgTarget"),
        editorFrame: $("#ppEditorFrame"),
        toast: $("#toast"),

        repliesTitle: $("#repliesTitle"),
        repliesList: $("#repliesList"),
        btnReloadReplies: $("#btnReloadReplies"),
        btnSubmitReply: $("#btnSubmitReply"),
      };

      const QUESTIONS_URL = "./questions.json";
      const REPLIES_URL = "./replies.json";

      let QUESTIONS = [];
      let REPLIES = [];
      let CONFIG = { editor_url: "" };
      let UI = {};
      let META = {};
      let activeId = null;
      let teacherMode = false;

      function toast(msg) {
        els.toast.textContent = String(msg || "");
        els.toast.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => els.toast.classList.remove("show"), 1400);
      }

      function escapeHTML(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function getQueryParam(name) {
        return new URL(location.href).searchParams.get(name);
      }
      function setQueryParam(name, value) {
        const u = new URL(location.href);
        if (value == null || value === "") u.searchParams.delete(name);
        else u.searchParams.set(name, value);
        history.replaceState({}, "", u.toString());
      }
      function currentShareLink() {
        const u = new URL(location.href);
        if (activeId) u.searchParams.set("q", activeId);
        return u.toString();
      }

      async function copyText(text) {
        const t = String(text || "");
        try {
          await navigator.clipboard.writeText(t);
        } catch {
          const ta = document.createElement("textarea");
          ta.value = t;
          document.body.appendChild(ta);
          ta.select();
          try {
            document.execCommand("copy");
          } catch {}
          ta.remove();
        }
      }

      function safeText(el, v) {
        el.textContent = String(v ?? "");
      }
      function clearEl(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
      }

      async function fetchJSON(url) {
        const u = new URL(url, location.href);
        u.searchParams.set("_ts", String(Date.now()));
        const res = await fetch(u.toString(), { cache: "no-store" });
        if (!res.ok)
          throw new Error("Failed to load " + url + " (" + res.status + ")");
        return await res.json();
      }

      // Keep compatibility with older/minimal question objects
      function normalizeQuestions(rawQuestions) {
        return (Array.isArray(rawQuestions) ? rawQuestions : [])
          .map((q) => {
            const id = String(q.id || "").trim();
            return {
              id,
              title: q.title || id,
              difficulty: q.difficulty || "",
              tags: Array.isArray(q.tags) ? q.tags.map(String) : [],
              estimated_minutes: q.estimated_minutes ?? q.minutes ?? "",
              prompt: q.prompt || q.question || q.problem || "",
              examples: Array.isArray(q.examples) ? q.examples : [],
              svg_html: q.svg_html || q.svg || "",
              hints: Array.isArray(q.hints) ? q.hints : [],
              starter_code: q.starter_code || "",
              solution_code: q.solution_code || "",
            };
          })
          .filter((q) => q.id);
      }

      function applyMetaUI() {
        document.title = META.site_title
          ? String(META.site_title)
          : "Saturday Questions";

        safeText(els.brandTitle, META.site_title || "Saturday Questions");
        safeText(els.brandSub, META.subtitle || "");
        safeText(els.todayDate, META.today_date || META.last_updated || "");

        safeText(els.bankTitle, UI.bank_title || "Question Bank");
        safeText(els.bankSub, UI.bank_sub || "Search and select a question.");
        safeText(els.bankTip, UI.bank_tip || "");

        safeText(els.searchLabel, UI.search_label || "Search");
        els.qSearch.placeholder = String(
          UI.search_placeholder || "Title or tagsâ€¦",
        );
        els.qSearch.value = "";

        safeText(
          els.btnTeacher,
          teacherMode
            ? UI.teacher_on || "Teacher Mode ON"
            : UI.teacher_off || "Teacher Mode OFF",
        );
        safeText(els.targetTitle, UI.target_title || "Problem");
        safeText(els.hintsTitle, UI.hints_title || "Hints");
        safeText(
          els.solutionTitle,
          UI.solution_title || "Solution (Teacher mode)",
        );
        safeText(els.editorTitle, UI.editor_title || "Python Editor");
        safeText(els.editorStatus, UI.editor_status || "ðŸ™‚");
        safeText(
          els.editorTip,
          UI.editor_tip || "Paste starter code into the editor.",
        );

        safeText(els.repliesTitle, UI.replies_title || "Replies");
        safeText(
          els.publishedLabel,
          META.published_label || UI.published_label || "Published",
        );
        safeText(
          els.publishedDate,
          META.published_date || META.last_updated || "",
        );

        const b = META.banner || {};
        if (b && b.enabled && b.image_url) {
          const link = b.link_url ? String(b.link_url) : "";
          const imgUrl = String(b.image_url);
          els.banner.style.display = "block";
          els.banner.innerHTML = `
          <a href="${link ? link : "#"}" ${link ? 'target="_blank" rel="noopener noreferrer"' : ""}>
            <img src="${imgUrl}" alt="Banner" loading="lazy">
          </a>`;
          if (!link) {
            const a = els.banner.querySelector("a");
            if (a) {
              a.removeAttribute("href");
              a.style.cursor = "default";
            }
          }
        } else {
          els.banner.style.display = "none";
          els.banner.innerHTML = "";
        }
      }

      function initEditor() {
        const override = getQueryParam("editor");
        const editorUrl = override || CONFIG.editor_url;
        const safeUrl =
          typeof editorUrl === "string" && editorUrl.startsWith("https://")
            ? editorUrl
            : "";
        els.editorFrame.src = safeUrl;
        els.btnOpenEditor.href = safeUrl || "#";
      }

      function populateFilters() {
        clearEl(els.qDifficulty);
        const d0 = document.createElement("option");
        d0.value = "";
        d0.textContent = UI.difficulty_all || "All levels";
        els.qDifficulty.appendChild(d0);

        const values = Array.isArray(UI.difficulty_values)
          ? UI.difficulty_values
          : Array.from(
              new Set(
                QUESTIONS.map((q) =>
                  String(q.difficulty || "").toLowerCase(),
                ).filter(Boolean),
              ),
            );

        values.forEach((v) => {
          const vv = String(v);
          const opt = document.createElement("option");
          opt.value = vv.toLowerCase();
          const labels = UI.difficulty_labels || {};
          opt.textContent = labels[vv] || labels[vv.toLowerCase()] || vv;
          els.qDifficulty.appendChild(opt);
        });

        const tags = new Set();
        QUESTIONS.forEach((q) =>
          (q.tags || []).forEach((t) => tags.add(String(t))),
        );
        clearEl(els.qTag);
        const t0 = document.createElement("option");
        t0.value = "";
        t0.textContent = UI.tag_all || "All tags";
        els.qTag.appendChild(t0);
        Array.from(tags)
          .sort((a, b) => a.localeCompare(b))
          .forEach((t) => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            els.qTag.appendChild(opt);
          });
      }

      function filterQuestions() {
        const s = (els.qSearch.value || "").trim().toLowerCase();
        const diff = (els.qDifficulty.value || "").toLowerCase();
        const tag = els.qTag.value;

        return QUESTIONS.filter((q) => {
          const qdiff = String(q.difficulty || "").toLowerCase();
          if (diff && qdiff !== diff) return false;
          if (tag && !(q.tags || []).includes(tag)) return false;
          if (!s) return true;

          const hay = [q.id, q.title, q.difficulty, (q.tags || []).join(" ")]
            .join(" ")
            .toLowerCase();
          return hay.includes(s);
        });
      }

      function renderList() {
        const list = filterQuestions();
        clearEl(els.qList);

        if (!list.length) {
          const div = document.createElement("div");
          div.style.padding = "10px";
          div.style.color = "var(--muted)";
          div.textContent = UI.no_match || "No questions match.";
          els.qList.appendChild(div);
          return;
        }

        list.forEach((q) => {
          const item = document.createElement("div");
          item.className = "q-item" + (q.id === activeId ? " active" : "");
          item.setAttribute("role", "listitem");
          item.setAttribute("tabindex", "0");
          item.dataset.id = q.id;

          const t = document.createElement("div");
          t.className = "q-title";
          t.textContent = q.title || q.id;

          const meta = document.createElement("div");
          meta.className = "q-meta";

          const p1 = document.createElement("span");
          p1.className = "pill";
          p1.textContent = q.difficulty || "level";

          const p2 = document.createElement("span");
          p2.className = "pill";
          p2.textContent = q.tags && q.tags[0] ? q.tags[0] : "tag";

          const p3 = document.createElement("span");
          p3.className = "pill";
          p3.textContent = q.estimated_minutes
            ? q.estimated_minutes + " min"
            : "time";

          meta.appendChild(p1);
          meta.appendChild(p2);
          meta.appendChild(p3);

          item.appendChild(t);
          item.appendChild(meta);

          item.addEventListener("click", () => selectQuestion(q.id));
          item.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") selectQuestion(q.id);
          });

          els.qList.appendChild(item);
        });
      }

      function setQuestionButtons(q) {
        els.btnCopyStarter.disabled = !q;
        els.btnCopyQuestionLink.disabled = !q;
        els.btnSubmitReply.disabled = !q;
        els.btnHints.disabled = !(q && q.hints && q.hints.length);
        els.btnSolution.disabled = !(
          q &&
          q.solution_code &&
          String(q.solution_code).trim().length
        );
      }

      function renderReplies() {
        const qid = activeId;
        if (!qid) {
          els.repliesList.textContent = UI.replies_empty || "No replies yet.";
          return;
        }

        const list = REPLIES.filter(
          (r) => String(r.q_id || "") === String(qid),
        ).sort((a, b) =>
          String(a.created_at || "").localeCompare(String(b.created_at || "")),
        );

        clearEl(els.repliesList);

        if (!list.length) {
          els.repliesList.textContent = UI.replies_empty || "No replies yet.";
          return;
        }

        list.forEach((r) => {
          const box = document.createElement("div");
          box.className = "reply";

          const head = document.createElement("div");
          head.className = "reply-head";

          const left = document.createElement("div");
          left.innerHTML = `<span class="reply-student"></span>`;

          const student = left.querySelector(".reply-student");
          student.textContent = String(r.student || "Student");

          const right = document.createElement("div");
          right.textContent = String(r.created_at || "");

          head.appendChild(left);
          head.appendChild(right);

          const msg = document.createElement("div");
          msg.className = "reply-msg";
          msg.textContent = String(r.message || "");

          const codeWrap = document.createElement("div");
          codeWrap.className = "reply-code";
          const pre = document.createElement("pre");
          pre.className = "codeblock";
          // pre.textContent = String(r.code || "").trim();
          pre.innerHTML = `${r.code}`;
          codeWrap.appendChild(pre);

          const teacherOnly = !!UI.replies_code_teacher_only;
          const hasCode = String(r.code || "").trim().length > 0;

          if (hasCode) {
            if (!teacherOnly) {
              codeWrap.style.display = "block";
            } else {
              codeWrap.style.display = teacherMode ? "block" : "none";
            }
          } else {
            codeWrap.style.display = "none";
          }

          box.appendChild(head);
          box.appendChild(msg);
          box.appendChild(codeWrap);

          els.repliesList.appendChild(box);
        });
      }

      // âœ… MAIN FIX: prompt + examples + svg are rendered here
      function renderProblem(q) {
        const prompt = String(q.prompt || "").trim();
        const examples = Array.isArray(q.examples) ? q.examples : [];

        let html = "";
        if (prompt) {
          html += `<h3>Question</h3>`;
          html += `<p style="white-space:pre-wrap;margin-top:0;">${escapeHTML(prompt)}</p>`;
        } else {
          html += `<div class="muted">No prompt found for this question.</div>`;
        }

        if (examples.length) {
          html += `<h3 style="margin-top:12px;">Examples</h3>`;
          html += `<ul>`;
          for (const ex of examples) {
            if (
              ex &&
              typeof ex === "object" &&
              ("input" in ex || "output" in ex)
            ) {
              html += `<li><b>Input:</b> ${escapeHTML(ex.input ?? "")}<br><b>Output:</b> ${escapeHTML(ex.output ?? "")}</li>`;
            } else {
              html += `<li>${escapeHTML(String(ex))}</li>`;
            }
          }
          html += `</ul>`;
        }

        els.problemBox.innerHTML = html;

        // SVG
        const svg = String(q.svg_html || "").trim();
        els.svgTarget.innerHTML = svg
          ? svg
          : `<div class="muted">No SVG provided for this question.</div>`;
      }

      function selectQuestion(id) {
        const q = QUESTIONS.find((x) => x.id === id);
        if (!q) return;

        activeId = id;
        setQueryParam("q", id);
        renderList();

        safeText(els.qTitle, q.title || q.id);
        const diff = String(q.difficulty || "level").toUpperCase();
        const tags = (q.tags || []).join(", ") || "no tags";
        const mins = q.estimated_minutes
          ? q.estimated_minutes + " min"
          : "time n/a";
        safeText(els.qMeta, `${diff} â€¢ ${tags} â€¢ ${mins}`);

        // âœ… Render problem statement + examples + svg
        renderProblem(q);

        // Hints
        clearEl(els.qHints);
        (q.hints || []).forEach((h) => {
          const li = document.createElement("li");
          li.textContent = String(h);
          els.qHints.appendChild(li);
        });

        // Solution
        els.qSolution.textContent = String(q.solution_code || "").trim();

        els.hintsSection.style.display = "none";
        els.solutionSection.style.display = "none";

        setQuestionButtons(q);
        renderReplies();
        toast("Loaded: " + (q.title || q.id));
      }

      function toggleTeacherMode() {
        teacherMode = !teacherMode;
        els.btnTeacher.textContent = teacherMode
          ? UI.teacher_on || "Teacher Mode ON"
          : UI.teacher_off || "Teacher Mode OFF";

        if (!teacherMode) els.solutionSection.style.display = "none";
        renderReplies();
        toast(teacherMode ? "Teacher mode ON" : "Teacher mode OFF");
      }

      async function loadReplies() {
        try {
          const rData = await fetchJSON(REPLIES_URL);
          REPLIES = Array.isArray(rData.replies) ? rData.replies : [];
          renderReplies();
        } catch (err) {
          console.error(err);
          REPLIES = [];
          renderReplies();
        }
      }

      async function loadAll() {
        try {
          safeText(els.brandSub, "Loading questions.jsonâ€¦");
          const qData = await fetchJSON(QUESTIONS_URL);

          META = qData.meta || {};
          UI = qData.ui || {};
          CONFIG = qData.config || { editor_url: "" };
          QUESTIONS = normalizeQuestions(qData.questions || []);

          applyMetaUI();
          initEditor();
          populateFilters();
          renderList();

          await loadReplies();

          const fromUrl = getQueryParam("q");
          if (fromUrl && QUESTIONS.some((q) => q.id === fromUrl)) {
            selectQuestion(fromUrl);
          } else if (QUESTIONS[0]) {
            selectQuestion(QUESTIONS[0].id);
          } else {
            setQuestionButtons(null);
            safeText(
              els.brandSub,
              UI.no_questions || "No questions found in questions.json",
            );
            els.problemBox.innerHTML = `<div class="muted">No questions.</div>`;
            els.svgTarget.innerHTML = "";
          }

          safeText(
            els.editorTip,
            UI.editor_tip || "Paste starter code into the editor.",
          );
        } catch (err) {
          console.error(err);
          safeText(els.brandSub, "Failed to load external JSON.");
          els.problemBox.innerHTML = `<div class="muted">Load error: check questions.json path</div>`;
          els.svgTarget.innerHTML = "";
          els.repliesList.textContent = "â€”";
          toast("Load error: check questions.json path");
        }
      }

      // Events
      els.qSearch.addEventListener("input", renderList);
      els.qDifficulty.addEventListener("change", renderList);
      els.qTag.addEventListener("change", renderList);

      els.btnShare.addEventListener("click", async () => {
        await copyText(currentShareLink());
        toast("Share link copied!");
      });

      els.btnTeacher.addEventListener("click", toggleTeacherMode);

      els.btnHints.addEventListener("click", () => {
        els.hintsSection.style.display =
          els.hintsSection.style.display === "none" ? "block" : "none";
      });

      els.btnSolution.addEventListener("click", () => {
        if (!teacherMode) {
          toast("Turn on Teacher mode to view solution");
          return;
        }
        els.solutionSection.style.display =
          els.solutionSection.style.display === "none" ? "block" : "none";
      });

      els.btnCopyStarter.addEventListener("click", async () => {
        const q = QUESTIONS.find((x) => x.id === activeId);
        await copyText(q?.starter_code || "");
        toast("Starter code copied!");
      });

      els.btnCopyQuestionLink.addEventListener("click", async () => {
        await copyText(currentShareLink());
        toast("Question link copied!");
      });

      els.btnReloadReplies.addEventListener("click", async () => {
        await loadReplies();
        toast("Replies reloaded");
      });

      els.btnSubmitReply.addEventListener("click", async () => {
        if (!activeId) return;

        const now = new Date();
        const pad2 = (n) => String(n).padStart(2, "0");
        const stamp = `${now.getFullYear()}-${pad2(now.getMonth() + 1)}-${pad2(now.getDate())} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

        const skel = {
          id: "r" + String(Math.random()).slice(2, 6),
          q_id: activeId,
          student: prompt("Student name? (optional)", "") || "",
          message: prompt("Message? (optional)", "") || "",
          code: prompt("Code? (optional)", "") || "",
          created_at: stamp,
        };

        const payload = JSON.stringify(skel, null, 2);
        await copyText(payload);
        toast((UI.btn_submit_reply || "Submit reply") + ": copied JSON");
      });

      loadAll();
    </script>
  </body>
</html>
